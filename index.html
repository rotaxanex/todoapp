<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#111111" />
  <title>todoapp</title>
  <link rel="manifest" href="manifest.webmanifest">
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#0f0f10; --card:#17171a; --muted:#a3a3a3; --text:#f5f5f5; --line:#2a2a2f; --accent:#7dd3fc;
      --shadow: 0 10px 30px rgba(0,0,0,.35);

      --frame-termin:#fb7185;
      --frame-hedef:#60a5fa;
      --frame-gorev:#34d399;

      --monthCellH: 130px;
    }

    *{ box-sizing:border-box; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    html, body{ height:100%; }
    body{ margin:0; background:var(--bg); color:var(--text); }
    .wrap{ max-width:1440px; margin:0 auto; padding:16px; display:none; }

    header{ display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:12px; flex-wrap:wrap; }
    .left{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    h1{ font-size:16px; margin:0; font-weight:650; letter-spacing:.2px; }

    .btn{ background:var(--card); border:1px solid var(--line); color:var(--text); padding:8px 10px; border-radius:12px; cursor:pointer; }
    .btn:hover{ border-color:#3a3a44; }
    .btn:active{ transform: translateY(1px); }
    .btn.danger{ color:#fb7185; border-color:rgba(251,113,133,.35); }
    .btn.danger:hover{ border-color:rgba(251,113,133,.6); }
    .btn.primary{ background: var(--accent); color: #000; border-color:var(--accent); font-weight: 600; }

    .seg{ display:flex; background:var(--card); border:1px solid var(--line); border-radius:14px; overflow:hidden; }
    .seg button{ border:0; background:transparent; color:var(--muted); padding:8px 12px; cursor:pointer; }
    .seg button.active{ color:var(--text); background:#1f1f24; }

    .bar{ display:flex; gap:10px; align-items:center; justify-content:space-between; margin:10px 0 12px; flex-wrap:wrap; }
    .nav{ display:flex; gap:8px; align-items:center; }
    .title{ font-size:14px; color:var(--muted); }
    .filters{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    select, input[type="text"], input[type="search"], input[type="time"], input[type="email"], input[type="password"]{
      background:#101014; color:var(--text);
      border:1px solid var(--line); border-radius:12px;
      padding:8px 10px; outline:none; font-size:13px;
    }
    textarea {
      background:#101014; color:var(--text);
      border:1px solid var(--line); border-radius:12px;
      padding:10px; outline:none; font-size:13px; resize: vertical; min-height: 80px;
    }
    select:focus, input:focus, textarea:focus{ border-color:#3a3a44; }

    .main{
      display:grid;
      grid-template-columns: 1fr 240px;
      gap:12px;
      align-items:start;
    }

    /* Base calendar area */
    .calendarArea{
      height: calc(100vh - 210px);
      overflow:auto;
      padding-right:4px;
    }
    body.weekMode .calendarArea{ height: calc(100vh - 320px); }
    body.monthMode .calendarArea{ height: calc(100vh - 140px); }

    .grid{ display:grid; gap:10px; }
    .month{ grid-template-columns: repeat(7, 1fr); }
    .week{ grid-template-columns: repeat(7, 1fr); }
    .dow{ font-size:12px; color:var(--muted); padding:0 6px; }
    body.weekMode .grid{ gap:8px; }

    .cell{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      gap:8px;
      overflow:hidden;
      min-width:0;
    }
    /* 1. FIX: Haftalık hücreye max-height eklendi. 
      Ekran boyutuna göre dinamik bir yükseklik belirlendi.
    */
    .cell.weekCell{ 
      min-height: 280px; 
      max-height: calc(100vh - 380px); /* İçerik taşarsa içeride scroll oluşmasını sağlar */
    }
    
    .cell.monthCell{ height: var(--monthCellH); }
    .cell:hover{ border-color:#3a3a44; }
    .cell.out{ opacity:.55; }
    .cell.sel{ outline:2px solid rgba(125,211,252,.35); border-color:rgba(125,211,252,.35); }
    .cell.dragOver{ outline:2px dashed rgba(125,211,252,.45); border-color:rgba(125,211,252,.45); }

    .dateRow{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .dateLeft{ display:flex; align-items:center; gap:8px; min-width:0; }
    .date{ font-size:12px; color:var(--muted); }
    .count{ font-size:12px; color:var(--accent); }

    .plusBtn{
      width:26px; height:26px; display:grid; place-items:center;
      border-radius:10px; border:1px solid var(--line);
      background:transparent; color:var(--muted); cursor:pointer; flex:0 0 auto;
    }
    .plusBtn:hover{ border-color:#3a3a44; color:var(--text); }

    /* .cards alanı zaten overflow:auto'ya sahip, parent'a max-height verince scroll çalışacak */
    .cards{ display:flex; flex-direction:column; gap:6px; overflow:auto; min-height:0; padding-right:2px; }

    .card{
      border:2px solid var(--frameColor, var(--line));
      border-radius:12px; padding:6px 8px;
      background: var(--fillColor, rgba(255,255,255,0.04));
      user-select:none; min-width:0; position:relative; flex: 0 0 auto; /* Kartların küçülmesini engelle */
    }
    .card[draggable="true"]{ cursor:grab; }
    .card:active{ cursor:grabbing; }
    .card.done{ opacity:.55; }

    .cardRow{ display:flex; align-items:flex-start; gap:8px; min-width:0; }
    .checkBtn{
      width:18px; height:18px; display:grid; place-items:center;
      border-radius:7px; border:1px solid rgba(0,0,0,.25);
      background:rgba(0,0,0,.10); color:rgba(255,255,255,.85);
      cursor:pointer; flex:0 0 auto; font-size:11px; line-height:1; margin-top:1px;
    }
    .cardBody{ flex:1 1 auto; min-width:0; display:flex; flex-direction:column; gap:3px; padding-right:22px; }
    .titleText{ font-size:12.8px; line-height:1.2; color: var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .timeText{ font-size:11px; line-height:1.1; color: rgba(255,255,255,.75); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    
    .noteIcon { font-size: 10px; margin-left: 4px; opacity: 0.7; }

    body.monthMode .card{ padding:4px 6px; border-radius:10px; }
    body.monthMode .cards{ gap:4px; }
    body.monthMode .checkBtn{ width:14px; height:14px; border-radius:6px; font-size:9px; margin-top:0; }
    body.monthMode .cardBody{ gap:2px; padding-right:20px; flex-direction: row; align-items: center; gap: 6px; }
    body.monthMode .titleText{ font-size:11px; flex: 1 1 auto; min-width: 0; }
    body.monthMode .timeText{ font-size:9.5px; opacity: .85; flex: 0 0 auto; }
    body.monthMode .moreBtn{ width:16px; height:16px; top:5px; right:5px; font-size:12px; }

    /* Scrollbars */
    .cards::-webkit-scrollbar{ width: 5px; }
    .cards::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.18); border-radius: 999px; }
    .cards { scrollbar-width: thin; scrollbar-color: rgba(255,255,255,.22) transparent; }

    .moreBtn{
      position:absolute; top:6px; right:6px; width:18px; height:18px;
      border-radius:8px; border:1px solid rgba(255,255,255,.15);
      background:rgba(0,0,0,.12); color:rgba(255,255,255,.85);
      cursor:pointer; display:grid; place-items:center; font-size:14px; line-height:1;
    }
    .moreBtn:hover{ border-color:rgba(255,255,255,.25); }

    .side{ position:sticky; top:12px; display:flex; flex-direction:column; gap:12px; }
    .panelBox{ background:var(--card); border:1px solid var(--line); border-radius:18px; padding:12px; box-shadow: var(--shadow); }
    .panelHead{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .panelHead h2{ margin:0; font-size:14px; }
    .muted{ color:var(--muted); font-size:12px; }

    .inbox.dragOver{ outline:2px dashed rgba(125,211,252,.45); border-color:rgba(125,211,252,.45); }
    .inboxList{ display:flex; flex-direction:column; gap:8px; overflow:auto; max-height:40vh; padding-right:2px; }

    .bottom{ margin-top: 0px; background:transparent; border:0; padding:0; }
    body.weekMode .bottom{ margin-top: -64px; }
    .bottomGrid{ display:block; }
    body.weekMode .bottomGrid{ display:grid; grid-template-columns: 1fr 360px; gap:10px; align-items:start; }

    .panelLike{ background:var(--card); border:1px solid var(--line); border-radius:18px; padding:12px; box-shadow: var(--shadow); }
    .bottomTop{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .panelLike h2{ margin:0; font-size:14px; }

    form{ display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
    .w{ min-width:160px; }

    .list{ margin-top:10px; display:flex; flex-direction:column; gap:8px; }
    .row{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border:1px solid var(--line); background:#121216; padding:10px 12px; border-radius:14px;
    }
    .row .txt{ font-size:13px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    body.monthMode .side{ display:none; }
    body.monthMode .main{ grid-template-columns: 1fr; }
    body.monthMode #bottomInboxSlot{ display:none; }

    /* Modal */
    .overlay{
      position:fixed; inset:0; background:rgba(0,0,0,.55); display:none;
      align-items:center; justify-content:center; padding:16px; z-index:50;
    }
    .modal{
      width:min(760px, 100%); background:var(--card); border:1px solid var(--line);
      border-radius:18px; padding:12px; box-shadow: var(--shadow); max-height: 86vh; overflow:auto;
    }
    .modalTop{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .modalTop h3{ margin:0; font-size:14px; }
    .modalGrid{ display:grid; grid-template-columns: 1fr 170px 170px 1fr; gap:8px; margin-top:10px; }
    .modalGrid .full{ grid-column: 1 / -1; }
    .modalActions{ display:flex; justify-content:space-between; align-items:center; gap:8px; margin-top:10px; }

    /* Tag Settings */
    .tagManager{ display:flex; flex-direction:column; gap:8px; margin-top:10px; }
    .tagItem{
      display:grid; grid-template-columns: 1fr auto auto; gap:8px; align-items:center;
      border:1px solid var(--line); background:#121216; padding:8px 10px; border-radius:14px;
    }
    .tagItem.dragOver{ outline:2px dashed rgba(125,211,252,.35); border-color:rgba(125,211,252,.35); }
    .tagName{ display:flex; align-items:center; gap:10px; min-width:0; }
    .tagName span{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .dot{ width:10px; height:10px; border-radius:999px; display:inline-block; }
    input[type="color"]{ width:44px; height:34px; border-radius:12px; border:1px solid var(--line); background:transparent; padding:0; }

    .iconBtn{
      width:38px; height:34px; display:grid; place-items:center;
      border-radius:12px; border:1px solid var(--line); background:transparent; color:var(--muted); cursor:pointer;
    }
    .iconBtn:hover{ border-color:#3a3a44; color:var(--text); }

    .habitsList{ display:flex; flex-direction:column; gap:10px; }
    .habitRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:8px 10px; border:1px solid var(--line); background:#121216; border-radius:14px;
    }
    .habitRow.dragging{ opacity:.6; }
    .habitRow.dragOver{ outline:2px dashed rgba(125,211,252,.35); border-color:rgba(125,211,252,.35); }
    .habitRow label{ display:flex; align-items:center; gap:10px; min-width:0; cursor: pointer; flex:1; }
    .habitRow span.name{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .habitRow span.name:hover { text-decoration: underline; color: var(--accent); }
    
    /* 2. FIX: Alışkanlık listesindeki Streak Rozeti CSS */
    .habitStreak {
      font-size: 10px; color: var(--accent); background: rgba(125,211,252,0.1); 
      padding: 2px 5px; border-radius: 6px; margin-left: auto; margin-right: 8px; flex-shrink: 0;
    }

    .habitRow input[type="checkbox"]{ width:18px; height:18px; cursor: pointer; }

    /* Habit Detail Stats */
    .habitStats { display: flex; gap: 10px; margin-top: 12px; justify-content: space-around; }
    .streakStat { text-align: center; background: #1f1f24; border-radius: 12px; padding: 10px; flex: 1; border: 1px solid var(--line); }
    .streakStat .val { font-size: 20px; font-weight: bold; color: var(--accent); }
    .streakStat .lbl { font-size: 11px; color: var(--muted); }

    .habitCalendar { 
      display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; margin-top: 16px; 
      border: 1px solid var(--line); padding: 10px; border-radius: 12px; background: #121216;
    }
    .hDay { aspect-ratio: 1; display: grid; place-items: center; font-size: 10px; border-radius: 6px; color: var(--muted); }
    .hDay.done { background: rgba(52, 211, 153, 0.2); color: #34d399; border: 1px solid rgba(52, 211, 153, 0.3); font-weight: bold; }
    .hDay.today { border: 1px solid var(--text); }

    /* AUTH SCREEN CSS */
    #authOverlay {
      position: fixed; inset: 0; background: var(--bg); z-index: 999;
      display: flex; align-items: center; justify-content: center; padding: 20px;
    }
    .authBox {
      width: 100%; max-width: 360px; background: var(--card); border: 1px solid var(--line);
      border-radius: 20px; padding: 24px; box-shadow: var(--shadow);
      display: flex; flex-direction: column; gap: 12px;
    }
    .authBox h2 { text-align: center; margin-bottom: 8px; font-size: 20px; }
    .authError { color: #fb7185; font-size: 13px; text-align: center; min-height: 18px; }

    @media (max-width: 900px){
      .main{ grid-template-columns: 1fr; }
      .side{ position:static; }
      .calendarArea{ height:auto; max-height:none; }
      body.weekMode .bottomGrid{ grid-template-columns: 1fr; }
      body.monthMode .side{ display:none; }
      body.weekMode .bottom{ margin-top: 0px; }
    }

    /* --- AY GÖRÜNÜMÜ DÜZENLEMESİ (PANEL SAĞDA) --- */

/* 1. Kapsayıcıyı yan yana (Flex) hale getiriyoruz */
body.monthMode .main > div:first-child {
  display: flex;
  flex-direction: row;
  gap: 15px;
  height: calc(100vh - 90px); /* Sayfa yüksekliğine sığdır */
  overflow: hidden;
}

/* 2. Takvim alanı kalan tüm boşluğu kaplasın */
body.monthMode .calendarArea {
  flex: 1; 
  height: 100% !important; /* Yüksekliği zorla */
  border-right: 1px solid var(--line); /* Araya çizgi at */
  padding-right: 15px;
}

/* 3. Görev Kutusunu (Seçili Gün Paneli) sağa sabitle */
body.monthMode .bottom {
  width: 280px;      /* Genişlik ayarı */
  min-width: 280px;
  margin-top: 0;     /* Eski boşluğu sıfırla */
  overflow-y: auto;  /* İçeriği uzunsa scroll olsun */
  padding-bottom: 20px;
}

/* 4. Sağ panelin içindeki kutu görünümünü sadeleştir */
body.monthMode .panelLike {
  box-shadow: none;
  border: none;
  background: transparent;
  padding: 0;
}

/* 5. Ay hücrelerinin yüksekliğini sabitleyip iç scroll verelim */
/* Böylece çok termin olsa bile hücre uzayıp takvimi bozmaz */
body.monthMode .cell.monthCell {
  height: 100%; /* Satıra yayıl */
  min-height: 0;
  overflow-y: auto; /* Hücre içinde çok kayıt varsa scroll çıksın */
  display: flex;
  flex-direction: column;
}
/* Hücre içi scrollbar'ı inceltelim */
body.monthMode .cell.monthCell::-webkit-scrollbar { width: 3px; }
body.monthMode .cell.monthCell::-webkit-scrollbar-thumb { background: var(--line); }

    /* --- AY GÖRÜNÜMÜ MİNİMAL KART TASARIMI --- */

/* Kartın dış çerçevesini ve arka planını kaldır */
body.monthMode .card {
  background: transparent !important;
  border: 0;
  padding: 1px 0;
  margin-bottom: 1px;
  border-radius: 0;
  min-height: auto;
}

/* Kart içeriğini sıkıştır */
body.monthMode .cardRow {
  gap: 6px;
  align-items: center;
}

/* Check butonunu minik bir renkli noktaya çevir */
body.monthMode .checkBtn {
  width: 6px; 
  height: 6px;
  min-width: 6px; /* Ezilmemesi için */
  border-radius: 50%;
  padding: 0;
  font-size: 0; /* İçindeki tiki gizle */
  background: var(--frameColor); /* Görev türünün rengini al */
  border: none;
  opacity: 1;
}
/* Tamamlanmışsa rengi soluklaştır */
body.monthMode .card.done .checkBtn {
  opacity: 0.3;
}

/* Başlığı tek satır yap ve küçült */
body.monthMode .titleText {
  font-size: 11px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-weight: 500;
  line-height: 1.4;
}

/* Saati ve 'Daha Fazla' butonunu gizle (Yer kazanmak için) */
/* Fareyle üzerine gelince detay görünür zaten */
body.monthMode .timeText { display: none; }
body.monthMode .moreBtn { display: none; }

/* Kartın üzerine gelince hafif bir zemin rengi ver */
body.monthMode .card:hover {
  background: rgba(255,255,255,0.05) !important;
  border-radius: 4px;
}
/* --- KARE VE DÜZENLİ TAKVİM AYARLARI --- */

/* 1. Takvim Alanını Düzenle */
/* Takvimi kapsayan alanı esnek yapıp içeriği ortalıyoruz */
body.monthMode .calendarArea {
  display: flex;
  flex-direction: column;
  align-items: center; /* Yatayda ortala */
  padding-top: 10px;
}

/* 2. Grid (Takvim) Genişliğini Sınırla ve Daralt */
/* max-width değerini değiştirerek takvimi ne kadar daraltacağını seçebilirsin */
body.monthMode .grid, 
body.monthMode #dowRow {
  width: 100%;
  max-width: 900px; /* BURAYI KÜÇÜLTÜRSEN TAKVİM DAHA DA DARALIR (Örn: 700px) */
  margin: 0 auto;   /* Ortala */
}

/* 3. Gün Kutularını Tam Kare ve Eşit Yap */
body.monthMode .cell.monthCell {
  height: auto !important;  /* JS tarafından hesaplanan yüksekliği EZİYORUZ */
  aspect-ratio: 1 / 1;      /* En-Boy oranını 1'e 1 (Tam Kare) yap */
  min-height: 0;            /* Esnek yapının bozulmasını engelle */
  
  /* İçerik düzeni */
  display: flex;
  flex-direction: column;
}

/* 4. Kare kutuların içindeki tarih kısmını biraz küçültelim ki yer kalsın */
body.monthMode .dateRow {
  margin-bottom: 4px;
}
body.monthMode .date {
  font-size: 11px;
  font-weight: bold;
  opacity: 0.7;
}

/* 5. Gün isimleri (Pzt, Sal...) hizası */
body.monthMode .dow {
  text-align: center;
  margin-bottom: 5px;
}

    /* --- GÜNCELLENMİŞ AY GÖRÜNÜMÜ AYARLARI (SOLA YASLI & DETAYLI) --- */

/* 1. Takvim Alanını Sola Çek ve Hizala */
body.monthMode .calendarArea {
  display: flex;
  flex-direction: column;
  align-items: flex-start; /* Ortalamayı kaldır, sola yasla */
  padding-left: 0;         /* Sol boşluğu sıfırla */
  padding-top: 10px;
}

/* Izgara genişliğini ayarla */
body.monthMode .grid, 
body.monthMode #dowRow {
  width: 98%;       /* Panelle çakışmaması için biraz pay bırak */
  max-width: none;  /* Genişlik sınırını kaldır */
  margin: 0;        /* Ortalamayı (auto) iptal et */
}

/* 2. Gün Kutularını Kare Yap (Aynen koruyoruz) */
body.monthMode .cell.monthCell {
  height: auto !important;
  aspect-ratio: 1 / 1;
  min-height: 0;
  display: flex;
  flex-direction: column;
  padding: 4px; /* Kutunun iç boşluğunu azalt (Daha çok yer kalsın) */
}

/* 3. Tarih ve (+) Butonunu Küçültüp Yukarı Al */
body.monthMode .dateRow {
  margin-bottom: 2px;
  justify-content: space-between;
  height: 18px; /* Başlık satırını incelt */
}

body.monthMode .date {
  font-size: 10px;       /* Tarihi küçült */
  font-weight: bold;
  opacity: 0.6;
  margin-left: 2px;
}

body.monthMode .plusBtn {
  width: 18px;          /* Butonu iyice ufalttık */
  height: 18px;
  font-size: 12px;
  border-radius: 4px;
  border: none;         /* Çerçeveyi kaldır, daha temiz dursun */
}
body.monthMode .plusBtn:hover {
  background: rgba(255,255,255,0.1);
}

/* 4. SAATLERİ GERİ GETİRME VE DÜZENLEME */
/* Kart Gövdesini yan yana (Saat - Başlık) dizecek şekilde ayarla */
body.monthMode .cardBody {
  flex-direction: row !important; /* Yan yana dizilimi zorla */
  align-items: center;
  gap: 4px;
}

/* Saati görünür yap */
body.monthMode .timeText {
  display: block !important; /* Gizlemeyi iptal et */
  font-size: 9px;
  font-family: monospace;    /* Sayılar hizalı dursun */
  color: var(--accent);      /* Mavi renk ile dikkat çeksin */
  background: rgba(125,211,252,0.1); /* Hafif zemin */
  padding: 1px 3px;
  border-radius: 4px;
  flex-shrink: 0;            /* Saatin sıkışıp küçülmesini engelle */
}

/* Başlık metni ayarı */
body.monthMode .titleText {
  font-size: 10.5px;
  margin-top: 1px; /* Saat ile görsel hizalama */
}

/* Kartlar arası boşluğu minimal tut */
body.monthMode .cards {
  gap: 2px;
}
  </style>
</head>

<body>

  <div id="authOverlay">
    <div class="authBox">
      <h2>todoapp</h2>
      <div style="text-align:center; color:var(--muted); font-size:13px; margin-bottom:12px;">Devam etmek için giriş yap</div>
      
      <input type="email" id="authEmail" placeholder="E-posta adresi" />
      <input type="password" id="authPass" placeholder="Şifre" />
      
      <div class="authError" id="authError"></div>

      <button id="btnLogin" class="btn primary" type="button">Giriş Yap</button>
      <button id="btnSignup" class="btn" type="button">Kayıt Ol</button>

      <div style="margin-top:10px; font-size:11px; color:var(--muted); line-height:1.4;">
        Kayıt olduğunuzda verileriniz Supabase veritabanında şifreli olarak saklanır ve her yerden erişilebilir olur.
      </div>
    </div>
  </div>

  <div class="wrap" id="appWrap">
    <header>
      <div class="left">
        <h1>todoapp<span style="font-size:11px; color:var(--accent); font-weight:normal;">Sync</span></h1>
        <div class="seg" role="tablist" aria-label="Görünüm">
          <button id="btnWeek" class="active" type="button">Hafta</button>
          <button id="btnMonth" type="button">Ay</button>
        </div>
      </div>

      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <span id="userEmailDisplay" style="font-size:12px; color:var(--muted);"></span>
        <button id="btnLogout" class="btn danger" type="button" style="font-size:12px;">Çıkış</button>
        <button id="tagSettingsBtn" class="btn" type="button">Tag Ayarları</button>
        <button id="btnInstall" class="btn" type="button" style="display:none;">Yükle</button>
      </div>
    </header>

    <div class="bar">
      <div class="nav">
        <button id="prev" class="btn" type="button">◀</button>
        <button id="today" class="btn" type="button">Bugün</button>
        <button id="next" class="btn" type="button">▶</button>
      </div>

      <div class="filters">
        <div class="title" id="rangeTitle"></div>

        <select id="tagFilter" title="Tag filtresi">
          <option value="__all__">Tag: Hepsi</option>
        </select>

        <select id="typeFilter" title="Tür filtresi">
          <option value="__preset__">Tür: Görünüme göre (preset)</option>
          <option value="__all__">Tür: Hepsi</option>
          <option value="termin">Sadece termin</option>
          <option value="hedef">Sadece hedef</option>
          <option value="gorev">Sadece görev</option>
        </select>

        <input id="search" type="search" placeholder="Ara…" />
      </div>
    </div>

    <div class="main">
      <div>
        <div id="calendarArea" class="calendarArea">
          <div class="grid" id="dowRow"></div>
          <div class="grid week" id="grid"></div>
        </div>

        <section class="bottom" id="bottom">
          <div class="bottomGrid" id="bottomGrid">
            <div class="panelLike">
              <div class="bottomTop">
                <div>
                  <h2 id="panelTitle">Seçili gün</h2>
                  <div class="muted">Sıralama: Termin → Hedef → Görev • Saat • Tag</div>
                </div>
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                  <button id="clearDone" class="btn" type="button">Tamamlananları temizle</button>
                </div>
              </div>

              <form id="addForm" autocomplete="off">
                <input class="w" id="taskInput" type="text" placeholder="Başlık…" maxlength="120" />
                <input class="w" id="timeInput" type="time" title="Saat" />
                <select class="w" id="typeInput" title="Tür">
                  <option value="termin">Termin</option>
                  <option value="hedef">Hedef</option>
                  <option value="gorev">Görev</option>
                </select>
                <select class="w" id="tagInput" title="Tag (dropdown)"></select>

                <select class="w" id="whereInput" title="Nereye eklensin?">
                  <option value="selected">Seçili güne</option>
                  <option value="inbox">Inbox (Brain Dump)</option>
                </select>

                <button id="addSubmit" class="btn" type="submit">Ekle</button>
              </form>

              <div class="list" id="taskList"></div>
            </div>

            <div id="bottomInboxSlot" class="panelLike"></div>
          </div>
        </section>
      </div>

      <aside class="side">
        <div id="inbox" class="panelBox inbox" aria-label="Brain Dump">
          <div class="panelHead">
            <div>
              <h2>Brain Dump</h2>
              <div class="muted">Güne atanmamış kartlar</div>
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
              <button id="inboxAdd" class="plusBtn" type="button">+</button>
              <button id="clearInboxDone" class="btn" type="button">Temizle</button>
            </div>
          </div>
          <div class="muted" id="inboxCount"></div>
          <div id="inboxList" class="inboxList"></div>
        </div>

        <div id="habitsBox" class="panelBox">
          <div class="panelHead">
            <div>
              <h2>Habits</h2>
              <div class="muted" id="habitsSub">Her gün sıfırlanır</div>
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
              <button id="habitAddBtn" class="plusBtn" type="button">+</button>
              <button id="habitResetBtn" class="btn" type="button">Reset</button>
            </div>
          </div>
          <div class="habitsList" id="habitsList"></div>
        </div>
      </aside>
    </div>
  </div>

  <div id="overlay" class="overlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalTop">
        <h3 id="modalTitle">Modal</h3>
        <button id="modalClose" class="btn" type="button">Kapat</button>
      </div>

      <div id="quickAddSection">
        <div class="muted" id="modalWhere"></div>
        <div class="modalGrid">
          <input id="mText" class="full" type="text" placeholder="Başlık…" maxlength="120" />
          <textarea id="mNotes" class="full" rows="3" placeholder="Notlar..."></textarea>
          
          <input id="mTime" type="time" />
          <select id="mType">
            <option value="termin">Termin</option>
            <option value="hedef">Hedef</option>
            <option value="gorev">Görev</option>
          </select>
          <select id="mTag"></select>
          <div class="full muted">Enter = Kaydet/Ekle</div>
        </div>

        <div class="modalActions">
          <button id="modalDelete" class="btn danger" type="button" style="display:none;">Sil</button>
          <div style="display:flex; gap:8px; margin-left:auto;">
            <button id="modalSave" class="btn" type="button">Ekle</button>
          </div>
        </div>
      </div>

      <div id="tagSettingsSection" style="display:none;">
        <div class="muted">Tag sıralamasını drag-drop ile değiştir.</div>
        <div class="tagManager" id="tagManager"></div>
      </div>

      <div id="habitDetailSection" style="display:none;">
        <div class="habitStats">
          <div class="streakStat">
            <div class="val" id="currentStreak">0</div>
            <div class="lbl">Mevcut Seri (Gün)</div>
          </div>
          <div class="streakStat">
            <div class="val" id="maxStreak">0</div>
            <div class="lbl">En Uzun Seri</div>
          </div>
        </div>
        
        <div style="margin-top:16px; font-size:13px; color:var(--muted);">Son 28 Gün</div>
        <div class="habitCalendar" id="habitCalendarGrid"></div>
      </div>
    </div>
  </div>

  <div id="confirmOverlay" class="overlay" style="z-index:60;">
    <div class="modal" style="width:300px; max-width:90%;">
      <h3 style="margin-top:0; text-align:center;">Emin misin?</h3>
      <div id="confirmMsg" style="text-align:center; color:var(--muted); margin-bottom:16px;">Bu işlem geri alınamaz.</div>
      <div style="display:flex; gap:10px; justify-content:center;">
        <button id="confirmNo" class="btn" type="button">İptal</button>
        <button id="confirmYes" class="btn danger" type="button">Evet, Sil</button>
      </div>
    </div>
  </div>

  <script>
    // ----------------------------------------------------------------------
    // SUPABASE AYARLARI (BURAYA KENDİ BİLGİLERİNİ YAPIŞTIR)
    // ----------------------------------------------------------------------
    const SUPABASE_URL = "https://czuprhvrnlqpipcytvwx.supabase.co"; 
    const SUPABASE_KEY = "sb_publishable_IR67FHQQNsnA9aNMizaqUA_HYGC8cKM"; 
    // ----------------------------------------------------------------------

    const LOCAL_KEY = 'minimal_todo_v15_3_offline';
    let db = null;
    let currentUser = null;
    let _supabase = null;

    // Supabase Init
    if(SUPABASE_URL && SUPABASE_KEY) {
      _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    } else {
      console.warn("Supabase bilgileri girilmemiş!");
    }

    // Custom Confirm Logic
    const confirmOverlay = document.getElementById('confirmOverlay');
    const confirmMsg = document.getElementById('confirmMsg');
    const confirmYes = document.getElementById('confirmYes');
    const confirmNo = document.getElementById('confirmNo');
    let onConfirmYes = null;

    function showConfirm(text, callback) {
      confirmMsg.textContent = text;
      onConfirmYes = callback;
      confirmOverlay.style.display = 'flex';
    }

    confirmYes.addEventListener('click', () => {
      if(onConfirmYes) onConfirmYes();
      confirmOverlay.style.display = 'none';
      onConfirmYes = null;
    });

    confirmNo.addEventListener('click', () => {
      confirmOverlay.style.display = 'none';
      onConfirmYes = null;
    });

    // Auth Elementleri
    const authOverlay = document.getElementById('authOverlay');
    const authEmail = document.getElementById('authEmail');
    const authPass = document.getElementById('authPass');
    const authError = document.getElementById('authError');
    const btnLogin = document.getElementById('btnLogin');
    const btnSignup = document.getElementById('btnSignup');
    const appWrap = document.getElementById('appWrap');
    const btnLogout = document.getElementById('btnLogout');
    const userEmailDisplay = document.getElementById('userEmailDisplay');

    // Başlangıç: Session kontrol
    async function initApp() {
      if(!_supabase) {
        alert("Lütfen kodun içindeki SUPABASE_URL ve SUPABASE_KEY alanlarını doldurun.");
        return;
      }
      
      const { data: { session } } = await _supabase.auth.getSession();
      if(session) {
        handleSession(session);
      } else {
        showAuth();
      }

      // Auth durum değişikliğini dinle
      _supabase.auth.onAuthStateChange((_event, session) => {
        if(session) handleSession(session);
        else showAuth();
      });
    }

    function showAuth() {
      authOverlay.style.display = 'flex';
      appWrap.style.display = 'none';
      currentUser = null;
    }

    async function handleSession(session) {
      currentUser = session.user;
      authOverlay.style.display = 'none';
      appWrap.style.display = 'block';
      userEmailDisplay.textContent = currentUser.email;
      
      await loadRemoteDB();
      render();
    }

    // Login
    btnLogin.addEventListener('click', async () => {
      authError.textContent = 'Giriş yapılıyor...';
      const email = authEmail.value;
      const password = authPass.value;
      const { data, error } = await _supabase.auth.signInWithPassword({ email, password });
      if(error) authError.textContent = error.message;
      else authError.textContent = '';
    });

    // Signup
    btnSignup.addEventListener('click', async () => {
      authError.textContent = 'Kayıt olunuyor...';
      const email = authEmail.value;
      const password = authPass.value;
      const { data, error } = await _supabase.auth.signUp({ email, password });
      if(error) {
        authError.textContent = error.message;
      } else {
        alert("Kayıt başarılı! Lütfen giriş yapın (Eğer e-posta onayı açıksa onaylayın).");
        authError.textContent = 'Kayıt başarılı.';
      }
    });

    // Logout
    btnLogout.addEventListener('click', async () => {
      await _supabase.auth.signOut();
    });

    // ----------------------------------------------------------------------
    // VERİTABANI YÖNETİMİ
    // ----------------------------------------------------------------------

    function getEmptyDB() {
      return { 
        days:{}, 
        inbox:[], 
        tags: [
          { name:'akademik',  color:'#7dd3fc', order:1 },
          { name:'praktikum', color:'#34d399', order:2 },
          { name:'finans',    color:'#fbbf24', order:3 },
          { name:'ev',        color:'#fb7185', order:4 },
        ], 
        habits:[], 
        habitState:{ date: todayKey(), doneIds:[] },
        habitHistory: {} // New: stores history { "habitId": ["2023-01-01", ...] }
      };
    }

    // Veriyi çek
    async function loadRemoteDB() {
      if(!currentUser) return;
      
      // Önce yerel yedeği al (varsa)
      let localData = null;
      try {
        const raw = localStorage.getItem(LOCAL_KEY);
        if(raw) localData = JSON.parse(raw);
      } catch {}

      // Sunucudan çek
      const { data, error } = await _supabase
        .from('user_data')
        .select('content')
        .eq('id', currentUser.id)
        .single();

      if (error && error.code !== 'PGRST116') {
        console.error("Veri çekme hatası:", error);
      }

      if (data && data.content) {
        // Sunucuda veri var, onu kullan
        db = data.content;
        if (!db.habitHistory) db.habitHistory = {}; // Migration support
        // Yereli güncelle
        localStorage.setItem(LOCAL_KEY, JSON.stringify(db));
      } else {
        // Sunucuda veri yok (yeni kullanıcı)
        if(localData) {
          db = localData;
          if (!db.habitHistory) db.habitHistory = {};
          saveDB(db); 
        } else {
          db = getEmptyDB();
          saveDB(db);
        }
      }
    }

    // Veriyi kaydet (Debounce ile)
    let saveTimeout = null;
    function saveDB(newDB) {
      if(!newDB) return;
      db = newDB;
      
      localStorage.setItem(LOCAL_KEY, JSON.stringify(db));

      if(saveTimeout) clearTimeout(saveTimeout);
      saveTimeout = setTimeout(async () => {
        if(!currentUser) return;
        await _supabase
          .from('user_data')
          .upsert({ 
            id: currentUser.id, 
            content: db,
            updated_at: new Date()
          });
      }, 1000); 
    }

    // ----------------------------------------------------------------------
    // STANDART UYGULAMA MANTIĞI
    // ----------------------------------------------------------------------
    
    // PWA install
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(()=>{}));
    }
    let deferredPrompt = null;
    const btnInstall = document.getElementById('btnInstall');
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      btnInstall.style.display = 'inline-block';
    });
    btnInstall.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
      btnInstall.style.display = 'none';
    });

    function dayKey(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const da = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    }
    function todayKey(){ return dayKey(new Date()); }

    function startOfWeek(date){
      const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      const day = (d.getDay() + 6) % 7;
      d.setDate(d.getDate() - day);
      return d;
    }
    function addDays(date, n){
      const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      d.setDate(d.getDate()+n);
      return d;
    }
    function startOfMonth(date){ return new Date(date.getFullYear(), date.getMonth(), 1); }
    function endOfMonth(date){ return new Date(date.getFullYear(), date.getMonth()+1, 0); }

    function fmtRange(a,b){
      const opts = { day:'2-digit', month:'short', year:'numeric' };
      return `${a.toLocaleDateString('tr-TR', opts)} – ${b.toLocaleDateString('tr-TR', opts)}`;
    }
    function fmtDay(d){
      return d.toLocaleDateString('tr-TR', { weekday:'long', day:'2-digit', month:'long', year:'numeric' });
    }

    function normalizeTagName(s){
      return (s||'').trim().toLowerCase().replace(/\s+/g,'-');
    }

    function fixItem(t){
      const id = t.id || (crypto.randomUUID ? crypto.randomUUID() : String(Date.now())+Math.random());
      const type = (['gorev','termin','hedef'].includes(t.type) ? t.type : 'gorev');
      return {
        id,
        text: (t.text||'').trim(),
        notes: (t.notes||''), 
        done: !!t.done,
        type,
        tag: (t.tag || ''),
        time: (t.time || ''),
        created: t.created || Date.now()
      };
    }

    function getCssVar(name){
      return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    }
    function typeFrameColor(type){
      if (type === 'termin') return getCssVar('--frame-termin');
      if (type === 'hedef') return getCssVar('--frame-hedef');
      return getCssVar('--frame-gorev');
    }

    function hexToRgba(hex, alpha){
      if (!hex) return `rgba(255,255,255,${alpha})`;
      const h = hex.replace('#','').trim();
      const full = h.length === 3 ? h.split('').map(c=>c+c).join('') : h;
      const r = parseInt(full.slice(0,2),16);
      const g = parseInt(full.slice(2,4),16);
      const b = parseInt(full.slice(4,6),16);
      return `rgba(${r},${g},${b},${alpha})`;
    }

    function typeRank(type){
      if (type === 'termin') return 0;
      if (type === 'hedef') return 1;
      return 2;
    }
    function timeKey(t){ return t.time ? t.time : '99:99'; }

    const DOW = ['Pzt','Sal','Çar','Per','Cum','Cts','Paz'];
    let mode = 'week';
    let anchor = new Date();
    let selected = new Date();
    let dragPayload = null;

    function ensureHabitReset(){
      if(!db) return;
      const today = todayKey();
      db.habitState = db.habitState || { date: today, doneIds: [] };
      db.habitHistory = db.habitHistory || {};
      
      if (db.habitState.date !== today){
        // New day reset, simple clear of daily state
        db.habitState = { date: today, doneIds: [] };
        saveDB(db);
      }
    }

    // UI refs
    const calendarArea = document.getElementById('calendarArea');
    const grid = document.getElementById('grid');
    const dowRow = document.getElementById('dowRow');
    const rangeTitle = document.getElementById('rangeTitle');
    const btnWeek = document.getElementById('btnWeek');
    const btnMonth = document.getElementById('btnMonth');

    const panelTitle = document.getElementById('panelTitle');
    const taskList = document.getElementById('taskList');

    const addForm = document.getElementById('addForm');
    const taskInput = document.getElementById('taskInput');
    const timeInput = document.getElementById('timeInput');
    const typeInput = document.getElementById('typeInput');
    const tagInput = document.getElementById('tagInput');
    const whereInput = document.getElementById('whereInput');
    const addSubmit = document.getElementById('addSubmit');
    const clearDone = document.getElementById('clearDone');

    const tagFilter = document.getElementById('tagFilter');
    const typeFilter = document.getElementById('typeFilter');
    const search = document.getElementById('search');

    const inbox = document.getElementById('inbox');
    const inboxList = document.getElementById('inboxList');
    const inboxCount = document.getElementById('inboxCount');
    const clearInboxDone = document.getElementById('clearInboxDone');
    const inboxAdd = document.getElementById('inboxAdd');
    const bottomInboxSlot = document.getElementById('bottomInboxSlot');

    const habitsList = document.getElementById('habitsList');
    const habitAddBtn = document.getElementById('habitAddBtn');
    const habitResetBtn = document.getElementById('habitResetBtn');
    const habitsSub = document.getElementById('habitsSub');

    // Modal
    const overlay = document.getElementById('overlay');
    const modalClose = document.getElementById('modalClose');
    const modalTitle = document.getElementById('modalTitle');
    const modalWhere = document.getElementById('modalWhere');
    const mText = document.getElementById('mText');
    const mNotes = document.getElementById('mNotes'); // New ref
    const mTime = document.getElementById('mTime');
    const mType = document.getElementById('mType');
    const mTag = document.getElementById('mTag');
    const quickAddSection = document.getElementById('quickAddSection');
    const tagSettingsSection = document.getElementById('tagSettingsSection');
    const habitDetailSection = document.getElementById('habitDetailSection');
    const tagSettingsBtn = document.getElementById('tagSettingsBtn');
    const tagManager = document.getElementById('tagManager');
    const modalSave = document.getElementById('modalSave');
    const modalDelete = document.getElementById('modalDelete');

    let modalContext = { mode:'add', dest:'day', dayKey:null, origin:null, itemId:null };

    function closeModal(){ overlay.style.display = 'none'; }
    modalClose.addEventListener('click', closeModal);
    overlay.addEventListener('click', (e)=>{ if (e.target === overlay) closeModal(); });

    overlay.addEventListener('keydown', (e)=>{
      if (overlay.style.display !== 'flex') return;
      if (tagSettingsSection.style.display === 'block') return;
      if (habitDetailSection.style.display === 'block') return;
      if (e.target.tagName === 'TEXTAREA') return; 
      if (e.key === 'Enter'){
        e.preventDefault();
        modalSave.click();
      }
    });

    tagSettingsBtn.addEventListener('click', ()=>{
      modalTitle.textContent = 'Tag Ayarları';
      quickAddSection.style.display = 'none';
      habitDetailSection.style.display = 'none';
      tagSettingsSection.style.display = 'block';
      overlay.style.display = 'flex';
      renderTagManager();
    });

    function tagMeta(name){ return (db && db.tags) ? db.tags.find(x=>x.name===name) : null; }
    function tagOrder(name){
      if (!name) return 9999;
      const m = tagMeta(name);
      return m ? (m.order ?? 9999) : 9999;
    }
    function itemSort(a,b){
      const ra = typeRank(a.type), rb = typeRank(b.type);
      if (ra !== rb) return ra - rb;
      const ta = timeKey(a), tb = timeKey(b);
      if (ta < tb) return -1;
      if (ta > tb) return 1;
      const oa = tagOrder(a.tag), ob = tagOrder(b.tag);
      if (oa !== ob) return oa - ob;
      return (a.created||0) - (b.created||0);
    }

    function presetTypesForMode(){
      if (mode === 'month') return new Set(['termin','hedef']);
      return new Set(['termin','hedef','gorev']);
    }
    function passesFilters(item){
      const q = (search.value||'').trim().toLowerCase();
      if (q && !(item.text||'').toLowerCase().includes(q)) return false;
      const tf = tagFilter.value;
      if (tf && tf !== '__all__' && item.tag !== tf) return false;
      const tpf = typeFilter.value;
      if (tpf === '__preset__'){
        if (!presetTypesForMode().has(item.type)) return false;
      } else if (tpf !== '__all__' && item.type !== tpf) return false;
      return true;
    }

    function rebuildTagDropdowns(){
      if(!db) return;
      db.tags.sort((a,b)=>(a.order??9999)-(b.order??9999));

      tagInput.innerHTML = '';
      const opt0 = document.createElement('option');
      opt0.value='__none__'; opt0.textContent='Tag: yok';
      tagInput.appendChild(opt0);
      for (const t of db.tags){
        const o = document.createElement('option');
        o.value=t.name; o.textContent=t.name;
        tagInput.appendChild(o);
      }

      mTag.innerHTML = '';
      const m0 = document.createElement('option');
      m0.value='__none__'; m0.textContent='Tag: yok';
      mTag.appendChild(m0);
      for (const t of db.tags){
        const o = document.createElement('option');
        o.value=t.name; o.textContent=t.name;
        mTag.appendChild(o);
      }

      const current = tagFilter.value || '__all__';
      tagFilter.innerHTML = '';
      const all = document.createElement('option');
      all.value='__all__'; all.textContent='Tag: Hepsi';
      tagFilter.appendChild(all);
      for (const t of db.tags){
        const o = document.createElement('option');
        o.value=t.name; o.textContent = `Tag: ${t.name}`;
        tagFilter.appendChild(o);
      }
      tagFilter.value = db.tags.some(x=>x.name===current) ? current : '__all__';
    }

    function addItemTo(dest, dayK, item){
      item = fixItem(item);
      if (dest === 'inbox'){
        db.inbox = db.inbox || [];
        db.inbox.push(item);
      } else {
        db.days[dayK] = db.days[dayK] || [];
        db.days[dayK].push(item);
      }
      saveDB(db);
    }

    function findItem(origin, itemId){
      if (!origin || !itemId) return null;
      if (origin.from === 'inbox'){
        return (db.inbox||[]).find(x=>x.id===itemId) || null;
      }
      if (origin.from === 'day'){
        return (db.days[origin.dayKey]||[]).find(x=>x.id===itemId) || null;
      }
      return null;
    }

    function deleteItem(origin, itemId){
      if (origin.from === 'inbox'){
        db.inbox = (db.inbox||[]).filter(x=>x.id!==itemId);
      } else if (origin.from === 'day'){
        const k = origin.dayKey;
        const arr = db.days[k] || [];
        const kept = arr.filter(x=>x.id!==itemId);
        if (kept.length) db.days[k]=kept; else delete db.days[k];
      }
      saveDB(db);
      render();
    }

    function openModalAdd(ctx){
      modalContext = { mode:'add', dest:ctx.dest, dayKey:ctx.dayKey, origin:null, itemId:null };
      modalTitle.textContent = (ctx.dest === 'inbox') ? 'Inbox’a ekle' : 'Güne ekle';
      modalWhere.textContent = (ctx.dest === 'inbox') ? 'Hedef: Brain Dump' : `Hedef gün: ${ctx.dayKey}`;

      quickAddSection.style.display = 'block';
      tagSettingsSection.style.display = 'none';
      habitDetailSection.style.display = 'none';
      overlay.style.display = 'flex';

      rebuildTagDropdowns();
      mText.value = '';
      mNotes.value = '';
      mTime.value = '';
      mTag.value = '__none__';

      const defaultType = (ctx.dest === 'inbox') ? 'gorev' : (mode === 'month') ? 'termin' : 'gorev';
      mType.value = defaultType;

      modalDelete.style.display = 'none';
      modalSave.textContent = 'Ekle';
      setTimeout(()=>mText.focus(), 0);
    }

    function openModalEdit(origin, itemId){
      const it = findItem(origin, itemId);
      if (!it) return;

      modalContext = { mode:'edit', dest:null, dayKey:null, origin, itemId };
      modalTitle.textContent = 'Düzenle';
      modalWhere.textContent = origin.from === 'inbox' ? 'Konum: Brain Dump' : `Konum: ${origin.dayKey}`;

      quickAddSection.style.display = 'block';
      tagSettingsSection.style.display = 'none';
      habitDetailSection.style.display = 'none';
      overlay.style.display = 'flex';

      rebuildTagDropdowns();
      mText.value = it.text || '';
      mNotes.value = it.notes || ''; // Load notes
      mTime.value = it.time || '';
      mType.value = it.type || 'gorev';
      mTag.value = it.tag ? it.tag : '__none__';

      modalDelete.style.display = 'inline-block';
      modalSave.textContent = 'Kaydet';
      setTimeout(()=>mText.focus(), 0);
    }

    modalSave.addEventListener('click', ()=>{
      const text = (mText.value||'').trim();
      if (!text) return;

      if (modalContext.mode === 'add'){
        addItemTo(modalContext.dest, modalContext.dayKey, {
          text,
          notes: mNotes.value || '',
          time: mTime.value || '',
          type: mType.value,
          tag: (mTag.value==='__none__' ? '' : mTag.value),
          done:false,
          created: Date.now()
        });
        closeModal();
        render();
        return;
      }

      if (modalContext.mode === 'edit'){
        const it = findItem(modalContext.origin, modalContext.itemId);
        if (!it) { closeModal(); return; }
        it.text = text;
        it.notes = mNotes.value || '';
        it.time = mTime.value || '';
        it.type = mType.value;
        it.tag  = (mTag.value==='__none__' ? '' : mTag.value);
        saveDB(db);
        closeModal();
        render();
      }
    });

    // CUSTOM CONFIRM UYGULANDI
    modalDelete.addEventListener('click', ()=>{
      if (modalContext.mode !== 'edit') return;
      
      showConfirm('Bu kart silinsin mi?', () => {
        deleteItem(modalContext.origin, modalContext.itemId);
        closeModal();
      });
    });

    function renderDOW(){
      dowRow.innerHTML = '';
      dowRow.className = 'grid ' + (mode==='month' ? 'month' : 'week');
      for (const name of DOW){
        const el = document.createElement('div');
        el.className='dow'; el.textContent=name;
        dowRow.appendChild(el);
      }
    }

    function makeCard(item, origin){
      const meta = tagMeta(item.tag);
      const tagColor = meta?.color || null;

      const card = document.createElement('div');
      card.className = 'card' + (item.done ? ' done' : '');
      card.draggable = true;

      card.style.setProperty('--frameColor', typeFrameColor(item.type));
      card.style.setProperty('--fillColor', tagColor ? hexToRgba(tagColor, 0.22) : 'rgba(255,255,255,0.04)');

      const more = document.createElement('button');
      more.className='moreBtn'; more.type='button'; more.textContent='⋯'; more.title='Düzenle';
      more.addEventListener('click', (e)=>{ e.stopPropagation(); openModalEdit(origin, item.id); });

      const row = document.createElement('div');
      row.className = 'cardRow';

      const check = document.createElement('button');
      check.className = 'checkBtn'; check.type = 'button';
      check.title = item.done ? 'Geri al' : 'Tamamla';
      check.textContent = item.done ? '↩' : '✓';
      check.addEventListener('click', (e)=>{
        e.stopPropagation();
        item.done = !item.done;
        saveDB(db);
        render();
      });

      const body = document.createElement('div');
      body.className = 'cardBody';

      const title = document.createElement('div');
      title.className = 'titleText'; 
      title.textContent = item.text || '(başlıksız)';
      
      // Visual indicator for notes
      if(item.notes && item.notes.trim().length > 0){
        const noteIcon = document.createElement('span');
        noteIcon.className = 'noteIcon';
        noteIcon.textContent = '📝';
        title.appendChild(noteIcon);
      }

      body.appendChild(title);

      if (item.time){
        const time = document.createElement('div');
        time.className = 'timeText'; time.textContent = item.time;
        body.appendChild(time);
      }

      row.appendChild(check); row.appendChild(body);
      card.appendChild(more); card.appendChild(row);

      card.addEventListener('dragstart', (e)=>{
        dragPayload = { ...origin, itemId: item.id };
        e.dataTransfer.setData('text/plain', JSON.stringify(dragPayload));
        e.dataTransfer.effectAllowed = 'move';
      });

      return card;
    }

    function renderInbox(){
      inboxList.innerHTML = '';
      if(!db) return;
      const items = (db.inbox||[]).map(fixItem).filter(passesFilters).sort(itemSort);
      const openCount = items.filter(x=>!x.done).length;
      inboxCount.textContent = items.length ? `Açık: ${openCount} • Toplam: ${items.length}` : 'Boş';

      if (!items.length){
        const empty = document.createElement('div');
        empty.className='muted'; empty.textContent='Inbox boş. + ile hızlı ekle.';
        inboxList.appendChild(empty);
        return;
      }
      for (const it of items){
        inboxList.appendChild(makeCard(it, {from:'inbox'}));
      }
    }

    // --- HABIT LOGIC UPDATED FOR HISTORY ---

                function toggleHabit(id, isDone) {
      ensureHabitReset();
      const today = todayKey();
      
      // 1. habitHistory (Kalıcı Geçmiş) Güncellemesi - ASIL KAYNAK
      db.habitHistory = db.habitHistory || {};
      // Eğer undefined ise boş dizi ata, sonra Set'e çevir
      const histSet = new Set(db.habitHistory[id] || []);
      
      if(isDone) {
        histSet.add(today);
      } else {
        histSet.delete(today);
      }
   


      // Set'i tekrar diziye çevirip kaydet
      db.habitHistory[id] = [...histSet].sort();

      // 2. habitState (Günlük Durum) Güncellemesi (Yedek/Legacy için)
      const s = new Set(db.habitState.doneIds || []);
      isDone ? s.add(id) : s.delete(id);
      db.habitState.doneIds = [...s];

      saveDB(db);
      renderHabits();
    }


    function calculateStreak(habitId) {
      const history = new Set(db.habitHistory[habitId] || []);
      let currentStreak = 0;
      let checkDate = new Date();
      
      // Check today
      if(history.has(dayKey(checkDate))) {
        currentStreak++;
      }
      // Check previous days
      while(true) {
        checkDate.setDate(checkDate.getDate() - 1);
        if(history.has(dayKey(checkDate))) {
          currentStreak++;
        } else {
          break;
        }
      }
      
      // Calculate Max Streak (simple naive approach on sorted array)
      const sortedDates = [...history].sort();
      let maxStreak = 0;
      let tempStreak = 0;
      for(let i=0; i<sortedDates.length; i++) {
        if(i === 0) { tempStreak = 1; continue; }
        
        const curr = new Date(sortedDates[i]);
        const prev = new Date(sortedDates[i-1]);
        const diffTime = Math.abs(curr - prev);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        
        if(diffDays === 1) {
          tempStreak++;
        } else {
          maxStreak = Math.max(maxStreak, tempStreak);
          tempStreak = 1;
        }
      }
      maxStreak = Math.max(maxStreak, tempStreak);

      return { current: currentStreak, max: maxStreak };
    }

    function openHabitDetail(habitId) {
      const h = db.habits.find(x=>x.id===habitId);
      if(!h) return;

      modalTitle.textContent = h.name;
      quickAddSection.style.display = 'none';
      tagSettingsSection.style.display = 'none';
      habitDetailSection.style.display = 'block';
      overlay.style.display = 'flex';

      // Stats
      const stats = calculateStreak(habitId);
      document.getElementById('currentStreak').textContent = stats.current;
      document.getElementById('maxStreak').textContent = stats.max;

      // Calendar Grid (Last 28 days)
      const gridContainer = document.getElementById('habitCalendarGrid');
      gridContainer.innerHTML = '';
      const history = new Set(db.habitHistory[habitId] || []);
      const today = new Date();
      const daysToShow = 28;
      
      // Generate last 28 days backwards, then reverse for display
      let dates = [];
      for(let i=0; i<daysToShow; i++) {
        const d = new Date();
        d.setDate(today.getDate() - i);
        dates.push(d);
      }
      dates.reverse();

      for(const d of dates) {
        const key = dayKey(d);
        const el = document.createElement('div');
        el.className = 'hDay' + (history.has(key) ? ' done' : '') + (key === dayKey(today) ? ' today' : '');
        el.textContent = d.getDate();
        el.title = key;
        gridContainer.appendChild(el);
      }
    }

        function renderHabits(){
      ensureHabitReset();
      habitsList.innerHTML = '';
      if(!db) return;
      
      const today = todayKey(); // Bugünü al
      const total = (db.habits||[]).length;
      
      // Bugün tamamlananları hesaplarken de history'den bakıyoruz
      let doneCount = 0;
      if(db.habits) {
        doneCount = db.habits.filter(h => {
            const hist = db.habitHistory && db.habitHistory[h.id] ? db.habitHistory[h.id] : [];
            return hist.includes(today);
        }).length;
      }

      habitsSub.textContent = total ? `Bugün: ${doneCount}/${total}` : 'Her gün sıfırlanır';

      if (!total){
        const empty = document.createElement('div');
        empty.className='muted'; empty.textContent='Alışkanlık eklemek için +';
        habitsList.appendChild(empty);
        return;
      }

      let dragHabitId = null;
      for (const h of db.habits){
        // Streak hesapla
        const stats = calculateStreak(h.id);
        
        // BUG FİX: Checkbox durumu artık doğrudan tarihçeden okunuyor
        const history = db.habitHistory && db.habitHistory[h.id] ? db.habitHistory[h.id] : [];
        const isDoneToday = history.includes(today);

        const row = document.createElement('div');
        row.className='habitRow'; row.draggable = true; row.dataset.habit = h.id;

        const lab = document.createElement('label');
        const cb = document.createElement('input');
        cb.type='checkbox'; 
        cb.checked = isDoneToday; // Düzeltilen kısım burası
        
        cb.addEventListener('click', (e)=>{
          e.stopPropagation();
          toggleHabit(h.id, cb.checked);
        });

        const name = document.createElement('span'); 
        name.className = 'name';
        name.textContent = h.name;
        
        name.addEventListener('click', (e)=>{
          e.preventDefault(); 
          e.stopPropagation();
          openHabitDetail(h.id);
        });

        lab.appendChild(cb); 
        lab.appendChild(name);
        
        if(stats.current > 0) {
          const streakBadge = document.createElement('span');
          streakBadge.className = 'habitStreak';
          streakBadge.textContent = `🔥 ${stats.current}`;
          lab.appendChild(streakBadge);
        }

        const del = document.createElement('button');
        del.className='iconBtn'; del.type='button'; del.textContent='🗑';
        
        del.addEventListener('click', ()=>{
          showConfirm(`"${h.name}" silinsin mi?`, () => {
            db.habits = (db.habits||[]).filter(x=>x.id!==h.id);
            ensureHabitReset();
            // Silince state ve history'den de temizle
            if(db.habitState && db.habitState.doneIds) {
                db.habitState.doneIds = db.habitState.doneIds.filter(id=>id!==h.id);
            }
            if(db.habitHistory) delete db.habitHistory[h.id];
            saveDB(db);
            renderHabits();
          });
        });

        row.appendChild(lab); row.appendChild(del);

        // Drag-drop eventleri aynı kaldı
        row.addEventListener('dragstart', ()=>{ dragHabitId = h.id; row.classList.add('dragging'); });
        row.addEventListener('dragend', ()=>{
          dragHabitId = null; row.classList.remove('dragging');
          [...habitsList.querySelectorAll('.habitRow')].forEach(x=>x.classList.remove('dragOver'));
        });
        row.addEventListener('dragover', (e)=>{ e.preventDefault(); row.classList.add('dragOver'); });
        row.addEventListener('dragleave', ()=>row.classList.remove('dragOver'));
        row.addEventListener('drop', (e)=>{
          e.preventDefault();
          row.classList.remove('dragOver');
          const targetId = row.dataset.habit;
          if (!dragHabitId || !targetId || dragHabitId === targetId) return;
          const ids = db.habits.map(x=>x.id);
          const from = ids.indexOf(dragHabitId);
          const to = ids.indexOf(targetId);
          if (from < 0 || to < 0) return;
          const moved = db.habits.splice(from,1)[0];
          db.habits.splice(to,0,moved);
          saveDB(db);
          renderHabits();
        });

        habitsList.appendChild(row);
      }
    }


        

    function renderPanel(){
      const k = dayKey(selected);
      panelTitle.textContent = fmtDay(selected);
      const items = (db && db.days[k]||[]).map(fixItem).filter(passesFilters).sort(itemSort);

      taskList.innerHTML = '';
      if (!items.length){
        const empty = document.createElement('div');
        empty.className='muted'; empty.style.padding='10px 2px';
        empty.textContent='Bu gün için (filtreye göre) kart yok.';
        taskList.appendChild(empty);
        return;
      }
      for (const it of items){
        const row = document.createElement('div');
        row.className='row';
        const txt = document.createElement('div');
        txt.className='txt';
        
        let displayTxt = it.text + (it.time ? ` • ${it.time}` : '');
        if(it.notes) displayTxt += ' 📝';

        txt.textContent = displayTxt;
        txt.style.color = it.done ? 'var(--muted)' : 'var(--text)';
        row.appendChild(txt);
        taskList.appendChild(row);
      }
    }

    function adjustMonthCellHeight(totalCells){
      const rows = Math.max(5, Math.min(6, Math.ceil(totalCells / 7)));
      const areaH = calendarArea.clientHeight;
      const dowH = dowRow.getBoundingClientRect().height || 18;
      const gaps = (rows - 1) * 10 + 10;
      const topPadding = 14;
      const cellH = Math.floor((areaH - dowH - gaps - topPadding) / rows);
      const clamped = Math.max(115, Math.min(185, cellH));
      document.documentElement.style.setProperty('--monthCellH', clamped + 'px');
    }

    function dockInboxForMode(){
      const side = document.querySelector('.side');
      if (mode === 'week'){
        document.body.classList.add('weekMode');
        document.body.classList.remove('monthMode');
        const inboxOpt = whereInput.querySelector('option[value="inbox"]');
        if (inboxOpt) inboxOpt.disabled = false;
        if (bottomInboxSlot && inbox.parentElement !== bottomInboxSlot){
          bottomInboxSlot.appendChild(inbox);
        }
      } else {
        document.body.classList.remove('weekMode');
        document.body.classList.add('monthMode');
        whereInput.value = 'selected';
        const inboxOpt = whereInput.querySelector('option[value="inbox"]');
        if (inboxOpt) inboxOpt.disabled = true;
        if (inbox.parentElement !== side){
          side.insertBefore(inbox, side.firstChild);
        }
      }
    }

    function renderTagManager(){
      tagManager.innerHTML = '';
      const addRow = document.createElement('div');
      addRow.className = 'tagItem';
      addRow.innerHTML = `
        <input id="newTagText" type="text" placeholder="Yeni tag (örn: kompozit)" />
        <input id="newTagColor" type="color" value="#7dd3fc" />
        <button id="newTagBtn" class="btn" type="button">Ekle</button>
      `;
      tagManager.appendChild(addRow);

      const newTagText = addRow.querySelector('#newTagText');
      const newTagColor = addRow.querySelector('#newTagColor');

      addRow.querySelector('#newTagBtn').addEventListener('click', ()=>{
        const name = normalizeTagName(newTagText.value);
        if (!name) return;
        if (db.tags.some(x=>x.name===name)) return;
        const maxOrder = Math.max(0, ...db.tags.map(x=>x.order||0));
        db.tags.push({ name, color: newTagColor.value || '#7dd3fc', order: maxOrder+1 });
        saveDB(db);
        rebuildTagDropdowns();
        render();
        renderTagManager();
      });

      const hint = document.createElement('div');
      hint.className='muted'; hint.textContent='Tag sıralamasını sürükleyip bırakarak değiştir.';
      tagManager.appendChild(hint);

      if(!db) return;
      db.tags.sort((a,b)=>(a.order??9999)-(b.order??9999));
      let dragTagName = null;

      for (const t of db.tags){
        const row = document.createElement('div');
        row.className='tagItem'; row.draggable = true; row.dataset.tag = t.name;

        const nameBox = document.createElement('div');
        nameBox.className='tagName';
        const d = document.createElement('span'); d.className='dot'; d.style.background=t.color || '#999';
        const s = document.createElement('span'); s.textContent=t.name;
        nameBox.appendChild(d); nameBox.appendChild(s);

        const color = document.createElement('input');
        color.type='color'; color.value = t.color || '#7dd3fc';
        color.addEventListener('input', ()=>{
          t.color = color.value;
          saveDB(db);
          render();
        });

        const del = document.createElement('button');
        del.className='iconBtn'; del.type='button'; del.textContent='🗑';
        
        // CUSTOM CONFIRM UYGULANDI
        del.addEventListener('click', ()=>{
          showConfirm(`"${t.name}" silinsin mi? (kartlardan tag kalkar)`, () => {
            db.tags = db.tags.filter(x=>x.name!==t.name);
            for (const k of Object.keys(db.days)){
              db.days[k].forEach(it=>{ if (it.tag===t.name) it.tag=''; });
            }
            (db.inbox||[]).forEach(it=>{ if (it.tag===t.name) it.tag=''; });
            saveDB(db);
            rebuildTagDropdowns();
            render();
            renderTagManager();
          });
        });

        row.appendChild(nameBox); row.appendChild(color); row.appendChild(del);

        row.addEventListener('dragstart', ()=>{ dragTagName = t.name; });
        row.addEventListener('dragover', (e)=>{ e.preventDefault(); row.classList.add('dragOver'); });
        row.addEventListener('dragleave', ()=>row.classList.remove('dragOver'));
        row.addEventListener('drop', (e)=>{
          e.preventDefault();
          row.classList.remove('dragOver');
          const targetName = row.dataset.tag;
          if (!dragTagName || !targetName || dragTagName === targetName) return;
          const names = db.tags.slice().sort((a,b)=>(a.order??9999)-(b.order??9999)).map(x=>x.name);
          const from = names.indexOf(dragTagName);
          const to = names.indexOf(targetName);
          if (from<0 || to<0) return;
          names.splice(from,1);
          names.splice(to,0,dragTagName);
          names.forEach((name, idx)=>{
            const m = db.tags.find(x=>x.name===name);
            if (m) m.order = idx+1;
          });
          saveDB(db);
          rebuildTagDropdowns();
          render();
          renderTagManager();
        });

        tagManager.appendChild(row);
      }
    }

    function render(){
      if(!db) return; // DB henüz yüklenmediyse çizme

      for (const k of Object.keys(db.days||{})){
        db.days[k] = (db.days[k]||[]).map(fixItem);
      }
      db.inbox = (db.inbox||[]).map(fixItem);

      rebuildTagDropdowns();
      renderDOW();
      dockInboxForMode();

      grid.className = 'grid ' + (mode==='month' ? 'month' : 'week');
      grid.innerHTML = '';

      let cells = [];
      if (mode === 'week'){
        const start = startOfWeek(anchor);
        const end = addDays(start, 6);
        rangeTitle.textContent = fmtRange(start, end);
        for (let i=0;i<7;i++) cells.push({ date: addDays(start,i), out:false });
      } else {
        const first = startOfMonth(anchor);
        const last = endOfMonth(anchor);
        const start = startOfWeek(first);
        const end = addDays(startOfWeek(last), 6);
        rangeTitle.textContent = anchor.toLocaleDateString('tr-TR', { month:'long', year:'numeric' });
        const totalDays = Math.round((end - start) / (24*3600*1000)) + 1;
        for (let i=0;i<totalDays;i++){
          const d = addDays(start,i);
          cells.push({ date:d, out: d.getMonth() !== anchor.getMonth() });
        }
        adjustMonthCellHeight(cells.length);
      }

      const selKey = dayKey(selected);

      for (const c of cells){
        const k = dayKey(c.date);
        const items = (db.days[k]||[]).filter(passesFilters).sort(itemSort);
        const openCount = items.filter(x=>!x.done).length;

        const cell = document.createElement('div');
        cell.className = 'cell ' + (mode==='month' ? 'monthCell' : 'weekCell') + (c.out ? ' out' : '') + (k===selKey ? ' sel' : '');
        cell.dataset.key = k;

        const top = document.createElement('div');
        top.className='dateRow';

        const left = document.createElement('div');
        left.className='dateLeft';
        const dateEl = document.createElement('div');
        dateEl.className='date'; dateEl.textContent = String(c.date.getDate()).padStart(2,'0');
        const plus = document.createElement('button');
        plus.className='plusBtn'; plus.type='button'; plus.textContent='+';
        plus.addEventListener('click', (e)=>{ e.stopPropagation(); openModalAdd({ dest:'day', dayKey:k }); });

        left.appendChild(dateEl); left.appendChild(plus);

        const count = document.createElement('div');
        count.className='count'; count.textContent = openCount ? `${openCount}` : '';

        top.appendChild(left); top.appendChild(count);

        const cards = document.createElement('div');
        cards.className='cards';
        for (const it of items){
          cards.appendChild(makeCard(it, { from:'day', dayKey:k }));
        }

        cell.appendChild(top); cell.appendChild(cards);

        cell.addEventListener('click', ()=>{
          selected = c.date;
          if (mode==='month' && c.out){
            anchor = new Date(c.date.getFullYear(), c.date.getMonth(), 1);
          }
          render();
        });

        cell.addEventListener('dragover', (e)=>{ e.preventDefault(); cell.classList.add('dragOver'); e.dataTransfer.dropEffect='move'; });
        cell.addEventListener('dragleave', ()=>cell.classList.remove('dragOver'));
        cell.addEventListener('drop', (e)=>{
          e.preventDefault();
          cell.classList.remove('dragOver');
          let payload = dragPayload;
          try {
            const txt = e.dataTransfer.getData('text/plain');
            if (txt) payload = JSON.parse(txt);
          } catch {}
          if (!payload?.itemId) return;

          const toKey = k;
          if (payload.from === 'inbox'){
            const idx = (db.inbox||[]).findIndex(x=>x.id===payload.itemId);
            if (idx === -1) return;
            const [moved] = db.inbox.splice(idx,1);
            db.days[toKey] = db.days[toKey] || [];
            db.days[toKey].push(moved);
          } else if (payload.from === 'day'){
            const fromKey = payload.dayKey;
            if (!fromKey || fromKey===toKey) return;
            const fromArr = db.days[fromKey] || [];
            const idx = fromArr.findIndex(x=>x.id===payload.itemId);
            if (idx === -1) return;
            const [moved] = fromArr.splice(idx,1);
            if (!fromArr.length) delete db.days[fromKey];
            db.days[toKey] = db.days[toKey] || [];
            db.days[toKey].push(moved);
          }
          saveDB(db);
          dragPayload = null;
          selected = c.date;
          render();
        });

        grid.appendChild(cell);
      }

      renderInbox();
      renderHabits();
      renderPanel();
    }

    // Controls
    document.getElementById('prev').addEventListener('click', ()=>{
      anchor = (mode==='week') ? addDays(anchor, -7) : new Date(anchor.getFullYear(), anchor.getMonth()-1, 1);
      render();
    });
    document.getElementById('next').addEventListener('click', ()=>{
      anchor = (mode==='week') ? addDays(anchor, 7) : new Date(anchor.getFullYear(), anchor.getMonth()+1, 1);
      render();
    });
    document.getElementById('today').addEventListener('click', ()=>{
      anchor = new Date();
      selected = new Date();
      render();
    });

    btnWeek.addEventListener('click', ()=>{
      mode='week';
      btnWeek.classList.add('active'); btnMonth.classList.remove('active');
      anchor = new Date(selected);
      typeFilter.value = '__preset__';
      typeInput.value = 'gorev';
      render();
    });
    btnMonth.addEventListener('click', ()=>{
      mode='month';
      btnMonth.classList.add('active'); btnWeek.classList.remove('active');
      anchor = new Date(selected.getFullYear(), selected.getMonth(), 1);
      typeFilter.value = '__preset__';
      typeInput.value = 'termin';
      render();
    });

    tagFilter.addEventListener('change', render);
    typeFilter.addEventListener('change', render);
    search.addEventListener('input', render);

    taskInput.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter'){
        e.preventDefault();
        addSubmit.click();
      }
    });

    addForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      const text = (taskInput.value||'').trim();
      if (!text) return;

      const item = {
        text,
        notes: '', // Quick add has no notes
        time: timeInput.value || '',
        type: typeInput.value,
        tag: (tagInput.value==='__none__' ? '' : tagInput.value),
        done:false,
        created: Date.now()
      };

      if (whereInput.value === 'inbox'){
        addItemTo('inbox', null, item);
      } else {
        addItemTo('day', dayKey(selected), item);
      }

      taskInput.value=''; timeInput.value=''; tagInput.value='__none__';
      render();
      taskInput.focus();
    });

    clearDone.addEventListener('click', ()=>{
      const k = dayKey(selected);
      const items = db.days[k] || [];
      const kept = items.filter(t=>!t.done);
      if (kept.length) db.days[k]=kept; else delete db.days[k];
      saveDB(db);
      render();
    });

    clearInboxDone.addEventListener('click', ()=>{
      db.inbox = (db.inbox||[]).filter(t=>!t.done);
      saveDB(db);
      render();
    });

    inboxAdd.addEventListener('click', ()=>openModalAdd({ dest:'inbox', dayKey:null }));

    inbox.addEventListener('dragover', (e)=>{ e.preventDefault(); inbox.classList.add('dragOver'); e.dataTransfer.dropEffect='move'; });
    inbox.addEventListener('dragleave', ()=>inbox.classList.remove('dragOver'));
    inbox.addEventListener('drop', (e)=>{
      e.preventDefault();
      inbox.classList.remove('dragOver');
      let payload = dragPayload;
      try {
        const txt = e.dataTransfer.getData('text/plain');
        if (txt) payload = JSON.parse(txt);
      } catch {}
      if (!payload?.itemId) return;

      if (payload.from === 'day'){
        const fromKey = payload.dayKey;
        const fromArr = db.days[fromKey] || [];
        const idx = fromArr.findIndex(x=>x.id===payload.itemId);
        if (idx === -1) return;
        const [moved] = fromArr.splice(idx,1);
        if (!fromArr.length) delete db.days[fromKey];
        db.inbox = db.inbox || [];
        db.inbox.push(moved);
        saveDB(db);
        dragPayload = null;
        render();
      }
    });

    habitAddBtn.addEventListener('click', ()=>{
      const name = prompt('Yeni alışkanlık:');
      if (!name) return;
      db.habits = db.habits || [];
      db.habits.push({ id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now())+Math.random(), name: name.trim() });
      saveDB(db);
      renderHabits();
    });

    habitResetBtn.addEventListener('click', ()=>{
      db.habitState = { date: todayKey(), doneIds: [] };
      saveDB(db);
      renderHabits();
    });

    typeFilter.value='__preset__';
    typeInput.value = 'gorev';

    // Başlat
    initApp();

    window.addEventListener('resize', ()=>{
      if (mode === 'month') render();
    });
  </script>
</body>
</html>
