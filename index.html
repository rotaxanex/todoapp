<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="theme-color" content="#111111" />
  <title>TodoApp Pro</title>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  
  <style>
    :root {
      --bg: #0f0f10;
      --card: #17171a;
      --card-hover: #1f1f24;
      --muted: #a3a3a3;
      --text: #f5f5f5;
      --line: #2a2a2f;
      --accent: #7dd3fc;
      --shadow: 0 10px 30px rgba(0,0,0,.5);
      
      --frame-termin: #fb7185; /* Kırmızımsı */
      --frame-hedef: #60a5fa;  /* Mavi */
      --frame-gorev: #34d399;  /* Yeşil */
      
      --month-cell-h: 120px;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { margin: 0; background: var(--bg); color: var(--text); font-family: ui-sans-serif, system-ui, -apple-system, sans-serif; height: 100vh; overflow: hidden; }
    
    /* UTILS */
    .hidden { display: none !important; }
    .w-full { width: 100%; }
    .btn { background: var(--card); border: 1px solid var(--line); color: var(--text); padding: 8px 12px; border-radius: 10px; cursor: pointer; transition: all .2s; font-size: 13px; }
    .btn:hover { border-color: #444; background: var(--card-hover); }
    .btn.danger { color: #fb7185; border-color: rgba(251,113,133,.3); }
    .btn.active { background: var(--text); color: var(--bg); border-color: var(--text); }
    
    input, select { background: #101014; color: var(--text); border: 1px solid var(--line); border-radius: 8px; padding: 8px; outline: none; font-size: 13px; }
    input:focus, select:focus { border-color: var(--accent); }

    /* LAYOUT DESKTOP */
    .app-wrap {
      max-width: 1600px; margin: 0 auto; padding: 16px; height: 100%; display: flex; flex-direction: column;
      transition: filter .3s;
    }

    /* Header */
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-shrink: 0; }
    .logo { font-weight: 700; font-size: 18px; letter-spacing: -0.5px; }
    .top-actions { display: flex; gap: 8px; align-items: center; }
    
    /* Filters Bar */
    .bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-shrink: 0; gap: 12px; flex-wrap: wrap; }
    .nav-grp { display: flex; gap: 6px; }
    .filter-grp { display: flex; gap: 8px; align-items: center; flex: 1; justify-content: flex-end; }
    .range-title { font-variant-numeric: tabular-nums; color: var(--muted); font-size: 14px; font-weight: 500; min-width: 140px; text-align: center; }

    /* Main Grid System */
    .main-grid {
      display: grid;
      grid-template-columns: 1fr 260px; /* Default Week Mode: Calendar | Sidebar */
      gap: 16px;
      flex: 1;
      min-height: 0; /* Nested scroll fix */
    }

    /* LEFT SIDE: Calendar + Bottom Panel */
    .left-col { display: flex; flex-direction: column; gap: 16px; min-width: 0; }
    
    .calendar-container {
      flex: 1; 
      display: flex; flex-direction: column; 
      background: var(--bg); 
      overflow: hidden; /* Scroll içeride olacak */
      min-height: 0;
    }

    .dow-row { display: grid; grid-template-columns: repeat(7, 1fr); padding-bottom: 6px; border-bottom: 1px solid var(--line); margin-bottom: 6px; }
    .dow { color: var(--muted); font-size: 12px; text-align: center; text-transform: uppercase; letter-spacing: 1px; }

    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; overflow-y: auto; padding-right: 4px; flex: 1; }
    
    /* WEEK CELL */
    .cell {
      background: var(--card); border: 1px solid var(--line); border-radius: 12px; padding: 8px;
      display: flex; flex-direction: column; gap: 6px; min-height: 120px; position: relative;
      transition: border-color .2s;
    }
    .cell:hover { border-color: #333; }
    .cell.today { border-color: var(--accent); background: rgba(125, 211, 252, 0.03); }
    .cell.selected { outline: 2px solid var(--accent); }
    .cell.out { opacity: 0.4; }
    .cell-head { display: flex; justify-content: space-between; align-items: center; }
    .day-num { font-size: 13px; color: var(--muted); font-weight: 600; }
    .add-tiny { width: 20px; height: 20px; display: grid; place-items: center; border: 1px solid var(--line); border-radius: 6px; color: var(--muted); cursor: pointer; font-size: 14px; line-height: 0; background: transparent; }
    .add-tiny:hover { color: var(--text); border-color: var(--text); }
    
    .cell-cards { flex: 1; display: flex; flex-direction: column; gap: 4px; overflow-y: auto; min-height: 0; }

    /* CARD STYLE */
    .task-card {
      background: rgba(255,255,255,0.03); border-left: 3px solid var(--line);
      border-radius: 4px; padding: 6px; font-size: 12px; cursor: grab; user-select: none;
      position: relative; display: flex; gap: 6px; align-items: flex-start;
      transition: transform .1s, opacity .2s;
    }
    .task-card:active { cursor: grabbing; }
    .task-card.done { opacity: 0.5; text-decoration: line-through; }
    .task-card:hover .card-actions { opacity: 1; }
    
    .task-check { 
      min-width: 14px; height: 14px; border: 1px solid var(--muted); border-radius: 4px; 
      display: grid; place-items: center; cursor: pointer; margin-top: 2px;
    }
    .task-check.checked { background: var(--accent); border-color: var(--accent); color: #000; font-weight: bold; font-size: 10px; }

    .card-content { flex: 1; min-width: 0; overflow: hidden; }
    .card-title { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; }
    .card-meta { font-size: 10px; color: var(--muted); display: flex; gap: 4px; margin-top: 2px; }

    /* TASK ENTRY / BOTTOM PANEL */
    .entry-panel {
      background: var(--card); border: 1px solid var(--line); border-radius: 16px; padding: 12px;
      display: flex; flex-direction: column; gap: 10px;
      flex-shrink: 0; /* Küçülmesin */
    }
    .entry-form { display: flex; gap: 8px; flex-wrap: wrap; }
    .task-row { display: flex; align-items: center; gap: 10px; padding: 8px; background: rgba(255,255,255,0.03); border-radius: 8px; }

    /* SIDEBAR */
    .sidebar { display: flex; flex-direction: column; gap: 16px; overflow-y: auto; }
    .panel { background: var(--card); border: 1px solid var(--line); border-radius: 16px; padding: 12px; display: flex; flex-direction: column; gap: 8px; max-height: 40vh; }
    .panel h2 { font-size: 14px; margin: 0; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
    .side-list { overflow-y: auto; display: flex; flex-direction: column; gap: 6px; padding-right: 2px; }

    /* --- MODES --- */

    /* MONTH MODE OVERRIDES */
    body.mode-month .main-grid {
      grid-template-columns: 1fr 340px; /* Sağ taraf genişler */
    }
    body.mode-month .cell {
      min-height: var(--month-cell-h);
      height: var(--month-cell-h);
    }
    body.mode-month .entry-panel {
      /* Ay modunda entry panel sağ kolona (sidebar) taşınacak gibi davranmalı */
      /* Ancak JS ile taşımak yerine, CSS Grid ile sağ kolonda göstereceğiz */
      display: none; /* Sol alttakini gizle */
    }
    
    /* Ay modunda sidebar içinde özel bir alan açılacak */
    #sidebar-entry-slot { display: none; }
    body.mode-month #sidebar-entry-slot { display: block; }
    body.mode-month #sidebar-inbox { display: none; } /* Ay modunda Brain Dump gizlensin mi? Yer kazanmak için evet */
    body.mode-month #sidebar-habits { display: none; }

    /* MOBILE OVERRIDES (Max 900px) */
    .mobile-view { display: none; padding: 16px; height: 100vh; overflow-y: auto; }
    
    @media (max-width: 900px) {
      .app-wrap { display: none; } /* Masaüstü arayüzü gizle */
      .mobile-view { display: block; } /* Mobil arayüzü aç */
      
      /* Mobile Card Style */
      .m-card { background: var(--card); padding: 16px; border-radius: 20px; margin-bottom: 12px; border: 1px solid var(--line); }
      .m-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
      .m-title { font-size: 20px; font-weight: 700; }
      .m-nav { display: flex; gap: 8px; margin-bottom: 16px; }
    }

    /* AUTH OVERLAY */
    .auth-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 999;
      display: flex; align-items: center; justify-content: center;
    }
    .auth-box { width: 340px; background: var(--card); padding: 24px; border-radius: 24px; border: 1px solid var(--line); display: flex; flex-direction: column; gap: 12px; }
    
    /* MODAL */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100;
      display: none; align-items: center; justify-content: center;
    }
    .modal { width: 400px; background: var(--card); padding: 20px; border-radius: 16px; border: 1px solid var(--line); box-shadow: var(--shadow); }
    .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
  </style>
</head>

<body class="mode-week">

  <div id="authOverlay" class="auth-overlay">
    <div class="auth-box">
      <h2 style="margin:0; text-align:center;">Todo Sync</h2>
      <div id="authMsg" style="color:var(--frame-termin); font-size:12px; min-height:16px; text-align:center;"></div>
      <input id="emailInput" type="email" placeholder="E-posta" />
      <input id="passInput" type="password" placeholder="Şifre" />
      <button id="btnLogin" class="btn active">Giriş Yap</button>
      <button id="btnRegister" class="btn">Kayıt Ol</button>
      <div style="font-size:11px; color:var(--muted); text-align:center; margin-top:5px;">Supabase keys kod içinde tanımlı.</div>
    </div>
  </div>

  <div id="modalOverlay" class="modal-overlay">
    <div class="modal">
      <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
        <h3 id="modalTitle" style="margin:0;">Düzenle</h3>
        <button onclick="closeModal()" class="btn" style="padding:4px 8px;">✕</button>
      </div>
      <input id="mText" class="w-full" placeholder="Ne yapılacak?" autofocus />
      <div class="modal-grid">
        <input id="mTime" type="time" />
        <select id="mType">
          <option value="gorev">Görev</option>
          <option value="termin">Termin</option>
          <option value="hedef">Hedef</option>
        </select>
        <select id="mTag"></select>
      </div>
      <div style="display:flex; justify-content:space-between; margin-top:16px;">
        <button id="modalDel" class="btn danger" style="display:none;">Sil</button>
        <button id="modalSave" class="btn active" style="margin-left:auto;">Kaydet</button>
      </div>
    </div>
  </div>

  <div class="app-wrap" id="desktopApp">
    <header>
      <div class="logo">todo<span style="color:var(--accent)">app</span></div>
      <div class="top-actions">
        <div id="statusText" style="font-size:12px; color:var(--muted);">Offline</div>
        <button id="btnLogout" class="btn danger">Çıkış</button>
      </div>
    </header>

    <div class="bar">
      <div class="nav-grp">
        <button id="btnPrev" class="btn">◀</button>
        <button id="btnToday" class="btn">Bugün</button>
        <button id="btnNext" class="btn">▶</button>
      </div>
      <div class="range-title" id="rangeTitle">...</div>
      
      <div class="filter-grp">
        <div style="background:var(--card); border:1px solid var(--line); border-radius:10px; display:flex; overflow:hidden;">
          <button id="viewWeek" class="btn" style="border:0; border-radius:0;">Hafta</button>
          <button id="viewMonth" class="btn" style="border:0; border-radius:0;">Ay</button>
        </div>
        <select id="filterTag"><option value="all">Tag: Tümü</option></select>
        <input id="searchBox" type="search" placeholder="Ara..." style="width:140px;" />
      </div>
    </div>

    <div class="main-grid">
      <div class="left-col">
        <div class="calendar-container">
          <div class="dow-row" id="dowRow"></div>
          <div class="cal-grid" id="calGrid"></div>
        </div>

        <div class="entry-panel" id="bottomPanel">
          <div class="cell-head">
            <h3 style="margin:0; font-size:14px;" id="selDateTitle">Seçili Gün</h3>
            <button id="clearDoneBtn" class="add-tiny" style="width:auto; padding:0 6px; font-size:11px;">Temizle</button>
          </div>
          <form id="addForm" class="entry-form" autocomplete="off">
            <input id="inpText" type="text" placeholder="Yeni kayıt..." class="w-full" style="flex:2;" />
            <input id="inpTime" type="time" />
            <select id="inpType"><option value="gorev">Görev</option><option value="termin">Termin</option><option value="hedef">Hedef</option></select>
            <select id="inpTag"></select>
            <button type="submit" class="btn active">+</button>
          </form>
          <div id="selDayList" class="side-list" style="max-height:150px;"></div>
        </div>
      </div>

      <aside class="sidebar">
        <div id="sidebar-entry-slot" class="entry-panel" style="border-color:var(--accent);">
          <div style="font-size:12px; color:var(--muted); margin-bottom:8px;">Ay görünümü: Hızlı Ekle</div>
          </div>

        <div id="sidebar-inbox" class="panel">
          <div class="cell-head"><h2>Brain Dump</h2> <button id="addInbox" class="add-tiny">+</button></div>
          <div id="inboxList" class="side-list"></div>
        </div>

        <div id="sidebar-habits" class="panel">
          <div class="cell-head"><h2>Habits</h2> <button id="addHabit" class="add-tiny">+</button></div>
          <div id="habitsList" class="side-list"></div>
        </div>
      </aside>
    </div>
  </div>

  <div class="mobile-view" id="mobileApp">
    <div class="m-head">
      <div>
        <div class="m-title" id="mTitle">Bugün</div>
        <div style="font-size:12px; color:var(--muted);">Kaydırarak günü değiştir</div>
      </div>
      <button onclick="logout()" class="btn danger" style="padding:4px 8px;">Çıkış</button>
    </div>

    <div class="m-nav">
      <button id="mGoWeek" class="btn active w-full">Günlük</button>
      <button id="mGoMonth" class="btn w-full">Takvim</button>
    </div>

    <div class="m-card">
      <div class="cell-head" style="margin-bottom:8px;">
        <span style="font-weight:600; font-size:14px;">Alışkanlıklar</span>
        <button id="mAddHabit" class="add-tiny">+</button>
      </div>
      <div id="mHabitList" style="display:flex; flex-direction:column; gap:8px;"></div>
    </div>

    <div class="m-card" id="mDayCard" style="min-height:200px;">
      <div class="cell-head" style="margin-bottom:12px;">
        <span id="mDateStr" style="color:var(--accent)">...</span>
        <button id="mAddJob" class="btn active" style="font-size:12px; padding:4px 10px;">+ Ekle</button>
      </div>
      <div id="mTaskList" style="display:flex; flex-direction:column; gap:8px;"></div>
    </div>
  </div>

<script>
  // --- CONFIG ---
  const SUPABASE_URL = 'https://czuprhvrnlqpipcytvwx.supabase.co';
  const SUPABASE_KEY = 'sb_publishable_IR67FHQQNsnA9aNMizaqUA_HYGC8cKM'; // Public key
  
  // --- STATE ---
  let db = { days: {}, inbox: [], habits: [], habitLog: {}, tags: [] };
  const defaultTags = [
    {name:'İş', color:'#60a5fa'}, {name:'Ev', color:'#fb7185'}, 
    {name:'Okul', color:'#34d399'}, {name:'Finans', color:'#fbbf24'}
  ];
  
  let state = {
    mode: 'week', // week | month
    anchor: new Date(),
    selected: new Date(),
    user: null,
    dragItem: null
  };

  const sb = window.supabase ? window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY) : null;
  
  // --- HELPERS ---
  const $ = (id) => document.getElementById(id);
  const toKey = (d) => d.toISOString().split('T')[0];
  const addDays = (d, n) => { const x=new Date(d); x.setDate(x.getDate()+n); return x; };
  const getStartOfWeek = (d) => { const x=new Date(d); const day=x.getDay()||7; x.setHours(0,0,0,0); x.setDate(x.getDate()-day+1); return x; };
  
  function saveLocal() {
    localStorage.setItem('todo_db_v2', JSON.stringify(db));
    syncRemote();
  }
  
  let syncTimer;
  function syncRemote() {
    if(!state.user || !sb) return;
    clearTimeout(syncTimer);
    syncTimer = setTimeout(async () => {
      $('statusText').innerText = 'Syncing...';
      const { error } = await sb.from('user_data').upsert({ id: state.user.id, content: db, updated_at: new Date() });
      $('statusText').innerText = error ? 'Sync Error' : state.user.email;
    }, 1000);
  }

  // --- RENDER ---
  function render() {
    // 1. Setup Tags
    if(!db.tags || db.tags.length===0) db.tags = defaultTags;
    const fillTags = (sel) => {
      sel.innerHTML = '<option value="">Etiket Yok</option>';
      db.tags.forEach(t => sel.innerHTML += `<option value="${t.name}">${t.name}</option>`);
    };
    fillTags($('inpTag')); fillTags($('mTag'));
    
    // 2. Setup Mode & Grid
    document.body.className = state.mode === 'month' ? 'mode-month' : 'mode-week';
    $('viewWeek').className = state.mode === 'week' ? 'btn active' : 'btn';
    $('viewMonth').className = state.mode === 'month' ? 'btn active' : 'btn';

    const grid = $('calGrid');
    const dow = $('dowRow');
    grid.innerHTML = ''; dow.innerHTML = '';

    const days = ['Pzt','Sal','Çar','Per','Cum','Cts','Paz'];
    days.forEach(d => dow.innerHTML += `<div class="dow">${d}</div>`);

    let start, end, cellCount;
    if(state.mode === 'week') {
      start = getStartOfWeek(state.anchor);
      cellCount = 7;
      $('rangeTitle').innerText = `${start.getDate()} - ${addDays(start,6).toLocaleDateString('tr-TR', {month:'long'})}`;
    } else {
      const y = state.anchor.getFullYear(), m = state.anchor.getMonth();
      const firstDay = new Date(y, m, 1);
      const lastDay = new Date(y, m+1, 0);
      start = getStartOfWeek(firstDay);
      // Ay görünümünde 5 veya 6 satır (35 veya 42 gün)
      cellCount = 35; // Basitlik için
      if(addDays(start, 35) < lastDay) cellCount = 42;
      $('rangeTitle').innerText = state.anchor.toLocaleDateString('tr-TR', {month:'long', year:'numeric'});
    }

    const selKey = toKey(state.selected);
    const todayKey = toKey(new Date());

    for(let i=0; i<cellCount; i++) {
      const date = addDays(start, i);
      const key = toKey(date);
      const isOut = state.mode==='month' && date.getMonth() !== state.anchor.getMonth();
      const isSel = key === selKey;
      
      const cell = document.createElement('div');
      cell.className = `cell ${isOut?'out':''} ${key===todayKey?'today':''} ${isSel?'selected':''}`;
      cell.innerHTML = `<div class="cell-head"><span class="day-num">${date.getDate()}</span></div><div class="cell-cards"></div>`;
      
      // Render Tasks inside Cell
      const list = db.days[key] || [];
      const cont = cell.querySelector('.cell-cards');
      
      list.forEach(task => {
        if(filterPass(task)) cont.appendChild(createCardUI(task, 'day', key));
      });

      // Events
      cell.onclick = () => {
        state.selected = date;
        // Ay modundaysak ve farklı aya tıkladıysak anchor'ı güncelleme (opsiyonel)
        render(); 
        renderRightPanel(); // Panel güncelle
        renderMobile();
      };
      
      // Drop Zone
      cell.ondragover = e => { e.preventDefault(); cell.style.background = '#1f1f24'; };
      cell.ondragleave = e => { cell.style.background = ''; };
      cell.ondrop = e => {
        e.preventDefault(); cell.style.background = '';
        handleDrop(key);
      };

      grid.appendChild(cell);
    }

    renderRightPanel();
    renderInbox();
    renderHabits();
    renderMobile();
  }

  function renderRightPanel() {
    const key = toKey(state.selected);
    $('selDateTitle').innerText = state.selected.toLocaleDateString('tr-TR', {weekday:'long', day:'numeric', month:'long'});
    
    // Desktop Bottom List
    const listCont = $('selDayList');
    listCont.innerHTML = '';
    const tasks = db.days[key] || [];
    
    if(tasks.length === 0) listCont.innerHTML = '<div style="color:var(--muted); font-size:12px; padding:10px;">Görev yok.</div>';
    
    tasks.forEach(task => {
      if(filterPass(task)) {
        const row = document.createElement('div');
        row.className = 'task-row';
        row.innerHTML = `
          <input type="checkbox" ${task.done?'checked':''}>
          <span style="flex:1; font-size:13px; text-decoration:${task.done?'line-through':''}; opacity:${task.done?0.5:1}">${task.text}</span>
          <button class="add-tiny" style="border:0;">⋮</button>
        `;
        row.querySelector('input').onchange = () => toggleTask('day', key, task.id);
        row.querySelector('button').onclick = () => openModal(task, 'day', key);
        listCont.appendChild(row);
      }
    });

    // Month Mode Side Slot Logic
    // Ay modunda, normal entry panel gizlenir. Sağ taraftaki sidebar-entry-slot içine basit bir form koyarız.
    const sideSlot = $('sidebar-entry-slot');
    if(state.mode === 'month') {
      sideSlot.innerHTML = '';
      // Clone form logic simple
      const clone = $('addForm').cloneNode(true);
      clone.id = "sideFormClone";
      clone.onsubmit = (e) => {
        e.preventDefault();
        const inputs = clone.querySelectorAll('input, select');
        // Değerleri asıl fonksiyona pasla
        addTask(inputs[0].value, inputs[1].value, inputs[2].value, inputs[3].value);
        inputs[0].value = '';
      };
      sideSlot.appendChild(clone);
      
      // Seçili gün listesi de burada olsun
      const listClone = listCont.cloneNode(true);
      // Event listenerlar clone ile gelmez, basitçe tekrar render edilebilir ama
      // Pratik çözüm: Month modunda sadece listeyi göster, editleme modal üzerinden.
      sideSlot.appendChild(listClone);
    }
  }

  function renderInbox() {
    const cont = $('inboxList');
    cont.innerHTML = '';
    db.inbox.forEach(task => {
      cont.appendChild(createCardUI(task, 'inbox', null));
    });
  }

  function renderHabits() {
    const cont = $('habitsList');
    const mCont = $('mHabitList');
    cont.innerHTML = ''; mCont.innerHTML = '';
    const key = toKey(new Date()); // Habits track today
    
    db.habits.forEach(h => {
      const isDone = db.habitLog[key] && db.habitLog[key].includes(h.id);
      
      const ui = document.createElement('div');
      ui.className = 'task-row';
      ui.innerHTML = `<input type="checkbox" ${isDone?'checked':''}> <span style="font-size:13px;">${h.name}</span> <button class="add-tiny" style="margin-left:auto">x</button>`;
      
      ui.querySelector('input').onchange = (e) => toggleHabit(h.id, e.target.checked);
      ui.querySelector('button').onclick = () => { db.habits = db.habits.filter(x=>x.id!==h.id); saveLocal(); renderHabits(); };
      
      cont.appendChild(ui);
      mCont.appendChild(ui.cloneNode(true)); // Mobile kopyası (eventleri tekrar bağlamak gerekir ama basitlik için geçiyorum)
      // Mobilde eventleri tekrar bağlamak:
      const mCheck = mCont.lastChild.querySelector('input');
      mCheck.onchange = (e) => toggleHabit(h.id, e.target.checked);
      const mDel = mCont.lastChild.querySelector('button');
      mDel.onclick = () => { db.habits = db.habits.filter(x=>x.id!==h.id); saveLocal(); renderHabits(); };
    });
  }

  function renderMobile() {
    // Sadece veri güncelleme
    $('mTitle').innerText = state.selected.toLocaleDateString('tr-TR', {weekday:'long'});
    $('mDateStr').innerText = state.selected.toLocaleDateString('tr-TR', {day:'numeric', month:'long', year:'numeric'});
    
    const key = toKey(state.selected);
    const list = db.days[key] || [];
    const cont = $('mTaskList');
    cont.innerHTML = '';
    
    if(list.length === 0) cont.innerHTML = '<div style="text-align:center; padding:20px; color:var(--muted)">Bugün boş.</div>';
    
    list.forEach(task => {
      const el = document.createElement('div');
      el.className = 'm-card'; 
      el.style.marginBottom='8px'; el.style.padding='10px';
      el.innerHTML = `
        <div style="display:flex; align-items:center; gap:10px;">
          <input type="checkbox" ${task.done?'checked':''} style="width:20px; height:20px;">
          <div style="flex:1;">
            <div style="font-size:14px; text-decoration:${task.done?'line-through':''}">${task.text}</div>
            <div style="font-size:11px; color:var(--muted)">${task.time || ''} ${task.tag ? '• '+task.tag : ''}</div>
          </div>
        </div>
      `;
      el.querySelector('input').onchange = () => toggleTask('day', key, task.id);
      el.onclick = (e) => { if(e.target.tagName!=='INPUT') openModal(task, 'day', key); };
      cont.appendChild(el);
    });
  }

  function createCardUI(task, source, dayKey) {
    const el = document.createElement('div');
    el.className = `task-card ${task.done?'done':''}`;
    el.style.borderLeftColor = task.type === 'termin' ? 'var(--frame-termin)' : task.type === 'hedef' ? 'var(--frame-hedef)' : 'var(--frame-gorev)';
    el.draggable = true;
    
    el.innerHTML = `
      <div class="task-check ${task.done?'checked':''}">${task.done?'✓':''}</div>
      <div class="card-content">
        <div class="card-title">${task.text}</div>
        <div class="card-meta">${task.time || ''} ${task.tag ? '• '+task.tag : ''}</div>
      </div>
    `;

    // Events
    const checkBtn = el.querySelector('.task-check');
    checkBtn.onclick = (e) => { e.stopPropagation(); toggleTask(source, dayKey, task.id); };
    
    el.ondragstart = (e) => {
      state.dragItem = { id: task.id, source, dayKey };
      e.dataTransfer.effectAllowed = 'move';
      setTimeout(()=>el.style.opacity='0.5',0);
    };
    el.ondragend = () => el.style.opacity='';
    el.onclick = () => openModal(task, source, dayKey);

    return el;
  }

  // --- LOGIC ---
  function addTask(text, time, type, tag, dest='day') {
    if(!text) return;
    const item = { id: Date.now().toString(), text, time, type, tag, done: false };
    
    if(dest === 'inbox') {
      db.inbox.push(item);
    } else {
      const key = toKey(state.selected);
      if(!db.days[key]) db.days[key] = [];
      db.days[key].push(item);
    }
    saveLocal(); render();
  }

  function toggleTask(source, dayKey, id) {
    let list = source === 'inbox' ? db.inbox : db.days[dayKey];
    const task = list.find(t => t.id === id);
    if(task) task.done = !task.done;
    saveLocal(); render();
  }

  function handleDrop(targetKey) {
    if(!state.dragItem) return;
    const { id, source, dayKey } = state.dragItem;
    
    // Remove from old
    let task;
    if(source === 'inbox') {
      const idx = db.inbox.findIndex(t => t.id === id);
      if(idx > -1) task = db.inbox.splice(idx, 1)[0];
    } else {
      const list = db.days[dayKey];
      const idx = list.findIndex(t => t.id === id);
      if(idx > -1) task = list.splice(idx, 1)[0];
    }

    // Add to new
    if(task) {
      if(!db.days[targetKey]) db.days[targetKey] = [];
      db.days[targetKey].push(task);
      saveLocal(); render();
    }
  }
  
  function toggleHabit(id, val) {
    const key = toKey(new Date());
    if(!db.habitLog[key]) db.habitLog[key] = [];
    
    if(val) {
      if(!db.habitLog[key].includes(id)) db.habitLog[key].push(id);
    } else {
      db.habitLog[key] = db.habitLog[key].filter(x => x !== id);
    }
    saveLocal();
  }

  function filterPass(task) {
    const tagF = $('filterTag').value;
    const search = $('searchBox').value.toLowerCase();
    
    if(tagF !== 'all' && task.tag !== tagF) return false;
    if(search && !task.text.toLowerCase().includes(search)) return false;
    return true;
  }

  // --- MODAL ---
  let editContext = null;
  function openModal(task, source, dayKey) {
    editContext = { task, source, dayKey };
    $('modalOverlay').style.display = 'flex';
    $('mText').value = task.text;
    $('mTime').value = task.time;
    $('mType').value = task.type;
    $('mTag').value = task.tag || '';
    $('modalDel').style.display = 'block';
  }
  function closeModal() { $('modalOverlay').style.display = 'none'; editContext = null; }
  
  $('modalSave').onclick = () => {
    if(!editContext) return;
    const { task } = editContext;
    task.text = $('mText').value;
    task.time = $('mTime').value;
    task.type = $('mType').value;
    task.tag = $('mTag').value;
    saveLocal(); render(); closeModal();
  };
  
  $('modalDel').onclick = () => {
    if(!editContext) return;
    const { task, source, dayKey } = editContext;
    if(confirm('Silinsin mi?')) {
      if(source==='inbox') db.inbox = db.inbox.filter(t=>t.id!==task.id);
      else db.days[dayKey] = db.days[dayKey].filter(t=>t.id!==task.id);
      saveLocal(); render(); closeModal();
    }
  };

  // --- EVENTS ---
  $('addForm').onsubmit = (e) => {
    e.preventDefault();
    addTask($('inpText').value, $('inpTime').value, $('inpType').value, $('inpTag').value);
    $('inpText').value = '';
  };
  
  $('viewWeek').onclick = () => { state.mode='week'; state.anchor = new Date(state.selected); render(); };
  $('viewMonth').onclick = () => { state.mode='month'; state.anchor = new Date(state.selected.getFullYear(), state.selected.getMonth(), 1); render(); };
  $('btnToday').onclick = () => { state.selected = new Date(); state.anchor = new Date(); render(); };
  $('btnPrev').onclick = () => { 
    state.anchor = state.mode==='week' ? addDays(state.anchor,-7) : new Date(state.anchor.getFullYear(), state.anchor.getMonth()-1, 1); 
    render(); 
  };
  $('btnNext').onclick = () => { 
    state.anchor = state.mode==='week' ? addDays(state.anchor,7) : new Date(state.anchor.getFullYear(), state.anchor.getMonth()+1, 1); 
    render(); 
  };
  
  $('filterTag').onchange = render;
  $('searchBox').oninput = render;

  $('addInbox').onclick = () => {
    const txt = prompt('Brain Dump:');
    if(txt) addTask(txt, '', 'gorev', '', 'inbox');
  };
  $('addHabit').onclick = () => {
    const txt = prompt('Yeni Alışkanlık:');
    if(txt) { db.habits.push({id:Date.now().toString(), name:txt}); saveLocal(); renderHabits(); }
  };

  // Mobile Nav
  $('mGoWeek').onclick = () => { $('mobileApp').scrollTo(0,0); };
  $('mGoMonth').onclick = () => { alert('Mobilde tam takvim için telefonu yan çevirin veya masaüstüne geçin.'); };
  $('mAddJob').onclick = () => {
    const txt = prompt('Hızlı Ekle:');
    if(txt) addTask(txt, '', 'gorev', '');
  };

  // Swipe Logic
  let touchStartX = 0;
  $('mDayCard').ontouchstart = e => touchStartX = e.changedTouches[0].screenX;
  $('mDayCard').ontouchend = e => {
    if(Math.abs(e.changedTouches[0].screenX - touchStartX) > 50) {
      const dir = e.changedTouches[0].screenX < touchStartX ? 1 : -1;
      state.selected = addDays(state.selected, dir);
      render();
    }
  };

  // --- AUTH & INIT ---
  async function init() {
    // Load Local
    const local = localStorage.getItem('todo_db_v2');
    if(local) db = JSON.parse(local);

    // Auth Check
    if(sb) {
      const { data } = await sb.auth.getSession();
      if(data.session) {
        state.user = data.session.user;
        $('authOverlay').classList.add('hidden');
        $('statusText').innerText = state.user.email;
        // Load Remote
        const { data: remote } = await sb.from('user_data').select('content').eq('id', state.user.id).single();
        if(remote && remote.content) { db = remote.content; saveLocal(); }
      }
    } else {
      $('authMsg').innerText = "Supabase bağlantısı kurulamadı (Adblock?)";
    }
    
    render();
  }

  $('btnLogin').onclick = async () => {
    if(!sb) return;
    const { error } = await sb.auth.signInWithPassword({ email: $('emailInput').value, password: $('passInput').value });
    if(error) $('authMsg').innerText = error.message;
    else location.reload();
  };
  
  $('btnRegister').onclick = async () => {
    if(!sb) return;
    const { error } = await sb.auth.signUp({ email: $('emailInput').value, password: $('passInput').value });
    if(error) $('authMsg').innerText = error.message;
    else $('authMsg').innerText = "Kayıt başarılı! Giriş yapabilirsin.";
  };
  
  $('btnLogout').onclick = async () => {
    if(sb) await sb.auth.signOut();
    location.reload();
  };

  init();

</script>
</body>
</html>
