<script>
  // --- KONFIGURASYON ---
  // L√úTFEN BURAYI KENDƒ∞ Bƒ∞LGƒ∞LERƒ∞NLE DOLDUR:
  const SUPABASE_URL = 'https://BURAYA_PROJE_URL_GELECEK.supabase.co'; 
  const SUPABASE_KEY = 'BURAYA_ANON_KEY_GELECEK';

  // Hata yakalama fonksiyonu (Ekrana yazdƒ±rmak i√ßin)
  function logError(msg) {
    const el = document.getElementById('auth-msg');
    if(el) {
      el.textContent = msg;
      el.style.display = 'block';
    }
    console.error(msg);
  }

  let supabase;
  let session = null;
  let currentView = 'daily';
  let currentDate = new Date();
  let selectedType = 'gorev';
  let cachedTags = [];
  let touchStartX = 0;

  // --- INIT ---
  async function init() {
    try {
      if (!window.supabase) {
        throw new Error('Supabase k√ºt√ºphanesi y√ºklenemedi. ƒ∞nternet baƒülantƒ±nƒ± kontrol et.');
      }
      
      // Client olu≈ütur
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      // Session kontrol√º
      const { data, error } = await supabase.auth.getSession();
      if (error) throw error;
      
      session = data.session;
      updateAuthUI();
      
      if(session) {
        document.getElementById('user-email').textContent = session.user.email;
        loadData();
      }
    } catch (err) {
      logError('Ba≈ülatma Hatasƒ±: ' + err.message);
    }
  }
  
  window.addEventListener('load', init);

  // --- AUTH ---
  function updateAuthUI() {
    if(session) {
      document.getElementById('auth-screen').style.display = 'none';
      document.getElementById('app-screen').style.display = 'flex';
    } else {
      document.getElementById('auth-screen').style.display = 'flex';
      document.getElementById('app-screen').style.display = 'none';
    }
  }

  async function handleLogin() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const msgBox = document.getElementById('auth-msg');
    
    if(!email || !password) {
      logError('L√ºtfen e-posta ve ≈üifre girin.');
      return;
    }

    msgBox.style.color = 'yellow';
    msgBox.textContent = 'Giri≈ü yapƒ±lƒ±yor...';

    try {
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });
      if(error) throw error;
      
      msgBox.textContent = '';
      session = data.session;
      updateAuthUI();
      document.getElementById('user-email').textContent = session.user.email;
      loadData();
    } catch (err) {
      msgBox.style.color = 'var(--danger)';
      logError('Giri≈ü Hatasƒ±: ' + err.message);
    }
  }

  async function handleSignUp() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const msgBox = document.getElementById('auth-msg');

    if(!email || !password) {
      logError('Kayƒ±t i√ßin e-posta ve ≈üifre gerekli.');
      return;
    }

    msgBox.style.color = 'yellow';
    msgBox.textContent = 'Kayƒ±t olunuyor...';

    try {
      const { data, error } = await supabase.auth.signUp({ email, password });
      if(error) throw error;

      alert('Kayƒ±t ba≈üarƒ±lƒ±! Eƒüer e-posta onayƒ± a√ßƒ±ksa l√ºtfen mail kutunu kontrol et.');
      // Otomatik giri≈ü yapmaya √ßalƒ±≈üalƒ±m (Eƒüer onay kapalƒ±ysa)
      if(data.session) {
        session = data.session;
        updateAuthUI();
        loadData();
      }
    } catch (err) {
      msgBox.style.color = 'var(--danger)';
      logError('Kayƒ±t Hatasƒ±: ' + err.message);
    }
  }

  async function handleLogout() {
    await supabase.auth.signOut();
    window.location.reload();
  }

  // --- NAVIGATION ---
  function toggleDrawer() {
    document.getElementById('drawer').classList.toggle('open');
    document.getElementById('drawer-overlay').classList.toggle('open');
  }

  function navTo(viewId) {
    currentView = viewId;
    document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    
    document.getElementById('view-' + viewId).classList.add('active');
    toggleDrawer();

    const titles = { daily:'G√ºnl√ºk', month:'Takvim', habits:'Alƒ±≈ükanlƒ±klar', inbox:'Brain Dump', tags:'Etiketler' };
    document.getElementById('page-title').textContent = titles[viewId];
    
    const fab = document.getElementById('fab');
    if(viewId === 'tags') fab.style.display = 'none';
    else fab.style.display = 'flex';

    loadData();
  }

  // --- DATE HELPERS ---
  function getDayKey(d) {
    return d.toISOString().split('T')[0];
  }
  function formatDay(d) {
    return d.toLocaleDateString('tr-TR', { day:'numeric', month:'long', year:'numeric' });
  }

  // --- LOAD DATA & RENDER ---
  async function loadData() {
    try {
      // 1. Fetch Tags Global
      const { data: tags, error } = await supabase.from('tags').select('*').order('name');
      if(error) throw error;
      
      cachedTags = tags || [];
      renderTagOptions();

      if(currentView === 'daily') renderDaily();
      else if(currentView === 'month') renderMonth();
      else if(currentView === 'habits') renderHabits();
      else if(currentView === 'inbox') renderInbox();
      else if(currentView === 'tags') renderTagsView();
    } catch (err) {
      console.error('Veri y√ºkleme hatasƒ±:', err);
    }
  }

  // --- DAILY VIEW ---
  async function renderDaily() {
    const dateKey = getDayKey(currentDate);
    document.getElementById('daily-date-display').textContent = formatDay(currentDate);
    document.getElementById('daily-dow-display').textContent = currentDate.toLocaleDateString('tr-TR', { weekday:'long' });

    const { data: tasks } = await supabase
      .from('tasks')
      .select('*')
      .eq('date_key', dateKey)
      .order('status', {ascending:true}) 
      .order('type'); 

    const list = document.getElementById('daily-list');
    list.innerHTML = '';
    
    if(!tasks || tasks.length === 0) {
      document.getElementById('daily-empty').style.display = 'block';
      return;
    }
    document.getElementById('daily-empty').style.display = 'none';

    tasks.forEach(t => {
      const tag = cachedTags.find(x => x.id === t.tag_id);
      list.appendChild(createTaskCard(t, tag));
    });
  }

  function changeDay(delta) {
    currentDate.setDate(currentDate.getDate() + delta);
    renderDaily();
  }
  
  const dailyView = document.getElementById('view-daily');
  dailyView.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; });
  dailyView.addEventListener('touchend', e => {
    const touchEndX = e.changedTouches[0].screenX;
    if(touchEndX < touchStartX - 50) changeDay(1); 
    if(touchEndX > touchStartX + 50) changeDay(-1); 
  });

  // --- MONTHLY VIEW ---
  async function renderMonth() {
    const y = currentDate.getFullYear(), m = currentDate.getMonth();
    document.getElementById('month-display').textContent = currentDate.toLocaleDateString('tr-TR', { month:'long', year:'numeric' });
    
    const startStr = new Date(y, m, 1).toISOString().split('T')[0];
    const endStr = new Date(y, m+1, 0).toISOString().split('T')[0];
    
    const { data: tasks } = await supabase
      .from('tasks')
      .select('date_key')
      .gte('date_key', startStr)
      .lte('date_key', endStr);
    
    const taskDates = new Set(tasks?.map(t => t.date_key));

    const header = document.getElementById('calendar-header');
    header.innerHTML = '';
    ['Pzt','Sal','√áar','Per','Cum','Cts','Paz'].forEach(d => header.innerHTML += `<div class="cal-head">${d}</div>`);

    const body = document.getElementById('calendar-body');
    body.innerHTML = '';

    const firstDay = new Date(y, m, 1);
    const startDay = (firstDay.getDay() + 6) % 7; 
    const daysInMonth = new Date(y, m+1, 0).getDate();

    for(let i=0; i<startDay; i++) body.innerHTML += `<div></div>`;

    const todayKey = getDayKey(new Date());

    for(let i=1; i<=daysInMonth; i++) {
      const dKey = `${y}-${String(m+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
      const isToday = dKey === todayKey;
      const hasTask = taskDates.has(dKey);
      
      const el = document.createElement('div');
      el.className = `cal-cell ${isToday ? 'today' : ''} ${hasTask ? 'has-task' : ''}`;
      el.textContent = i;
      el.onclick = () => {
        currentDate = new Date(y, m, i);
        navTo('daily');
      };
      body.appendChild(el);
    }
  }

  function changeMonth(delta) {
    currentDate.setMonth(currentDate.getMonth() + delta);
    renderMonth();
  }

  // --- INBOX VIEW ---
  async function renderInbox() {
    const { data: tasks } = await supabase
      .from('tasks')
      .select('*')
      .is('date_key', null)
      .order('created_at', {ascending:false});
      
    const list = document.getElementById('inbox-list');
    list.innerHTML = '';
    tasks?.forEach(t => list.appendChild(createTaskCard(t, cachedTags.find(x => x.id === t.tag_id))));
  }

  // --- HABITS VIEW ---
  async function renderHabits() {
    const today = getDayKey(new Date());
    
    const { data: habits } = await supabase.from('habits').select('*').order('created_at');
    const { data: logs } = await supabase.from('habit_logs').select('habit_id').eq('date_key', today);
    const doneIds = new Set(logs?.map(l => l.habit_id));

    const list = document.getElementById('habits-list');
    list.innerHTML = '';
    
    habits?.forEach(h => {
      const row = document.createElement('div');
      row.className = 'habit-row';
      const isDone = doneIds.has(h.id);
      
      row.innerHTML = `
        <div style="display:flex; align-items:center; gap:12px;">
          <div class="checkbox" style="${isDone ? 'background:var(--gorev); border-color:var(--gorev); color:white;' : ''}">
            ${isDone ? '‚úì' : ''}
          </div>
          <span style="${isDone ? 'opacity:0.5; text-decoration:line-through;' : ''}">${h.name}</span>
        </div>
        <button style="background:none; border:none; color:var(--muted);" onclick="deleteHabit('${h.id}')">üóë</button>
      `;
      row.children[0].onclick = () => toggleHabit(h.id, !isDone);
      list.appendChild(row);
    });
  }

  async function toggleHabit(id, val) {
    const today = getDayKey(new Date());
    if(val) {
      await supabase.from('habit_logs').insert({ habit_id: id, date_key: today });
    } else {
      await supabase.from('habit_logs').delete().eq('habit_id', id).eq('date_key', today);
    }
    renderHabits();
  }

  async function deleteHabit(id) {
    if(confirm('Silinsin mi?')) {
      await supabase.from('habits').delete().eq('id', id);
      renderHabits();
    }
  }

  // --- TAGS VIEW ---
  function renderTagsView() {
    const list = document.getElementById('tags-list');
    list.innerHTML = '';
    cachedTags.forEach(t => {
      const div = document.createElement('div');
      div.className = 'habit-row';
      div.innerHTML = `
        <div style="display:flex; align-items:center; gap:10px;">
          <div style="width:16px; height:16px; border-radius:50%; background:${t.color}"></div>
          <span>${t.name}</span>
        </div>
        <button style="color:var(--danger); background:none; border:none;" onclick="deleteTag('${t.id}')">Sil</button>
      `;
      list.appendChild(div);
    });
  }

  async function addTag() {
    const name = document.getElementById('new-tag-name').value;
    const color = document.getElementById('new-tag-color').value;
    if(!name) return;
    await supabase.from('tags').insert({ user_id: session.user.id, name, color });
    document.getElementById('new-tag-name').value = '';
    loadData();
  }

  async function deleteTag(id) {
    if(confirm('Tag silinsin mi?')) {
      await supabase.from('tags').delete().eq('id', id);
      loadData();
    }
  }

  // --- SHARED COMPONENTS ---
  function createTaskCard(t, tag) {
    const div = document.createElement('div');
    div.className = `card ${t.type} ${t.status ? 'done' : ''}`;
    div.innerHTML = `
      <div class="checkbox" onclick="toggleTask('${t.id}', ${!t.status})">
        ${t.status ? '‚úì' : ''}
      </div>
      <div class="card-content">
        <div class="card-text">${t.text}</div>
        <div class="card-meta">
          ${t.time_val ? `<span>‚è∞ ${t.time_val}</span>` : ''}
          ${tag ? `<span class="tag-badge" style="color:${tag.color}; border:1px solid ${tag.color}">${tag.name}</span>` : ''}
        </div>
      </div>
      <button onclick="deleteTask('${t.id}')" style="background:none; border:none; font-size:16px; color:var(--muted);">‚ãÆ</button>
    `;
    return div;
  }

  async function toggleTask(id, status) {
    await supabase.from('tasks').update({ status }).eq('id', id);
    if(currentView === 'daily') renderDaily();
    else renderInbox();
  }

  async function deleteTask(id) {
    if(confirm('Sil?')) {
      await supabase.from('tasks').delete().eq('id', id);
      if(currentView === 'daily') renderDaily();
      else renderInbox();
    }
  }

  // --- ADD MODAL ---
  function openAddModal() {
    document.getElementById('add-modal').classList.add('open');
    document.getElementById('m-text').focus();
    
    const hDiv = document.getElementById('habit-adder');
    if(currentView === 'habits') {
      hDiv.style.display = 'block';
    } else {
      hDiv.style.display = 'none';
    }
  }

  function closeAddModal() {
    document.getElementById('add-modal').classList.remove('open');
    document.getElementById('m-text').value = '';
    document.getElementById('m-time').value = '';
  }

  function selectType(t) {
    selectedType = t;
    document.querySelectorAll('.type-opt').forEach(el => el.classList.remove('selected'));
    document.querySelector(`.type-opt[data-val="${t}"]`).classList.add('selected');
  }

  function renderTagOptions() {
    const s = document.getElementById('m-tag');
    s.innerHTML = '<option value="">Tag Yok</option>';
    cachedTags.forEach(t => {
      s.innerHTML += `<option value="${t.id}">${t.name}</option>`;
    });
  }

  async function saveTask() {
    const text = document.getElementById('m-text').value;
    if(!text) return;
    
    const timeVal = document.getElementById('m-time').value || null;
    const tagId = document.getElementById('m-tag').value || null;

    let dateKey = null;
    if(currentView === 'daily' || currentView === 'month') {
      dateKey = getDayKey(currentDate);
    }

    await supabase.from('tasks').insert({
      user_id: session.user.id,
      text,
      type: selectedType,
      time_val: timeVal,
      tag_id: tagId,
      date_key: dateKey
    });
    
    closeAddModal();
    loadData();
  }

  async function saveHabit() {
    const text = document.getElementById('m-text').value;
    if(!text) return;
    await supabase.from('habits').insert({ user_id: session.user.id, name: text });
    closeAddModal();
    loadData();
  }
</script>
