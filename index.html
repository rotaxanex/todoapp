<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="theme-color" content="#111111" />
  <title>Minimal To-Do v16 (Mobile)</title>
  <link rel="manifest" href="manifest.webmanifest">
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#0f0f10; --card:#17171a; --muted:#a3a3a3; --text:#f5f5f5; --line:#2a2a2f; --accent:#7dd3fc;
      --shadow: 0 10px 30px rgba(0,0,0,.35);

      --frame-termin:#fb7185;
      --frame-hedef:#60a5fa;
      --frame-gorev:#34d399;

      --bottom-nav-h: 60px;
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    html, body{ height:100%; overscroll-behavior-y: none; }
    body{ margin:0; background:var(--bg); color:var(--text); }

    /* --- COMMON UI --- */
    .btn{ background:var(--card); border:1px solid var(--line); color:var(--text); padding:8px 10px; border-radius:12px; cursor:pointer; }
    .btn.danger{ color:#fb7185; border-color:rgba(251,113,133,.35); }
    .btn.primary{ background: var(--accent); color: #000; border-color:var(--accent); font-weight: 600; }
    input, select{ background:#101014; color:var(--text); border:1px solid var(--line); border-radius:12px; padding:8px; outline:none; }

    /* CARD STYLES (Shared) */
    .card{
      border-left: 3px solid var(--frameColor, var(--line));
      border-radius:8px; padding:8px 10px;
      background: var(--card); border-top:1px solid var(--line); border-bottom:1px solid var(--line); border-right:1px solid var(--line);
      user-select:none; position:relative; margin-bottom:6px;
    }
    .card.done{ opacity:.5; }
    .cardRow{ display:flex; align-items:flex-start; gap:10px; }
    .checkBtn{
      width:20px; height:20px; border-radius:6px; border:1px solid var(--muted);
      background:transparent; color:transparent; cursor:pointer; display:flex; align-items:center; justify-content:center;
    }
    .card.done .checkBtn{ background:var(--accent); border-color:var(--accent); color:#000; }
    .cardBody{ flex:1; display:flex; flex-direction:column; gap:2px; }
    .titleText{ font-size:14px; color:var(--text); line-height:1.3; }
    .timeText{ font-size:11px; color:var(--muted); }
    .tagDot{ width:8px; height:8px; border-radius:50%; display:inline-block; margin-right:4px; }

    /* --- DESKTOP LAYOUT (Hidden on mobile) --- */
    .desktop-layout { max-width:1440px; margin:0 auto; padding:16px; display:block; }
    
    /* Header & Filters (Desktop) */
    header{ display:flex; gap:12px; justify-content:space-between; align-items:center; margin-bottom:12px; }
    .desktop-grid { display:grid; grid-template-columns: 1fr 280px; gap:12px; align-items:start; height: calc(100vh - 100px); }
    .calendarArea { height: 100%; overflow:auto; }
    .grid { display:grid; gap:10px; }
    .week { grid-template-columns: repeat(7, 1fr); }
    .month { grid-template-columns: repeat(7, 1fr); }
    .cell { background:var(--card); border:1px solid var(--line); border-radius:16px; padding:10px; min-height:120px; cursor:pointer; }
    .cell:hover { border-color: var(--accent); }
    .cell.sel { border-color: var(--accent); background: #1f1f24; }
    
    /* Side Panels (Desktop) */
    .side { display:flex; flex-direction:column; gap:12px; height:100%; overflow:auto; }
    .panelBox { background:var(--card); border:1px solid var(--line); border-radius:18px; padding:12px; }

    /* --- MOBILE LAYOUT (Visible only on mobile) --- */
    .mobile-layout { display:none; flex-direction:column; height:100%; position:relative; }
    .mobile-header {
      padding: 12px 16px; background: rgba(15,15,16,0.95); backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line); display:flex; justify-content:space-between; align-items:center;
      z-index: 10;
    }
    .mobile-title { font-size:18px; font-weight:700; }
    .mobile-date { font-size:13px; color:var(--accent); }
    
    .mobile-content { flex:1; overflow-y:auto; overflow-x:hidden; padding:12px; padding-bottom: 80px; position:relative; }

    /* Mobile Bottom Nav */
    .bottom-nav {
      position:fixed; bottom:0; left:0; right:0; height: var(--bottom-nav-h);
      background: var(--card); border-top: 1px solid var(--line);
      display:grid; grid-template-columns: repeat(5, 1fr);
      z-index: 20; padding-bottom: env(safe-area-inset-bottom);
    }
    .nav-item {
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:4px; color:var(--muted); font-size:10px; cursor:pointer; border:none; background:transparent;
    }
    .nav-item.active { color:var(--accent); }
    .nav-icon { font-size: 18px; }

    /* Mobile Day View */
    .mobile-day-wrapper { min-height: 80vh; }
    .day-nav-bar { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
    .day-nav-btn { background:transparent; border:none; color:var(--text); font-size:18px; padding:10px; }
    .empty-state { text-align:center; color:var(--muted); margin-top:40px; font-size:14px; }

    /* Mobile Month View (Google Calendar Style) */
    .m-cal-grid { display:grid; grid-template-columns: repeat(7, 1fr); gap:2px; margin-top:10px; }
    .m-cal-head { text-align:center; font-size:12px; color:var(--muted); padding-bottom:8px; }
    .m-cal-cell {
      aspect-ratio: 1; border-radius:50%; display:flex; flex-direction:column; align-items:center; justify-content:center;
      font-size:14px; position:relative; cursor:pointer;
    }
    .m-cal-cell.today { background: #2a2a2f; color: var(--text); font-weight:bold; }
    .m-cal-cell.selected { background: var(--accent); color: #000; font-weight:bold; }
    .m-cal-cell.diff-month { opacity: 0.3; }
    .m-dots { display:flex; gap:2px; margin-top:2px; }
    .m-dot { width:4px; height:4px; border-radius:50%; background: var(--frame-gorev); }
    .m-dot.termin { background: var(--frame-termin); }
    .m-dot.hedef { background: var(--frame-hedef); }

    /* Mobile Fab (Floating Action Button) */
    .fab {
      position:fixed; bottom: calc(var(--bottom-nav-h) + 20px); right: 20px;
      width:56px; height:56px; border-radius:16px; background:var(--accent); color:#000;
      display:flex; align-items:center; justify-content:center; font-size:28px; box-shadow: 0 4px 15px rgba(0,0,0,0.4);
      border:none; cursor:pointer; z-index:15;
    }

    /* AUTH & MODAL Overlays */
    .overlay { position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:100; padding:20px; }
    .modal { width:100%; max-width:400px; background:var(--card); border-radius:16px; padding:16px; border:1px solid var(--line); max-height:85vh; overflow-y:auto; }

    /* RESPONSIVE SWITCH */
    @media (max-width: 900px) {
      .desktop-layout { display: none; }
      .mobile-layout { display: flex; }
      .wrap { display: block !important; } /* Force show if auth passed */
    }
  </style>
</head>
<body>

  <div id="authOverlay" class="overlay" style="display:flex; z-index:999; background:var(--bg);">
    <div class="modal">
      <h2 style="text-align:center;">Minimal To-Do</h2>
      <p style="text-align:center; color:var(--muted); font-size:13px;">Verilerinizi senkronize etmek iÃ§in giriÅŸ yapÄ±n.</p>
      <input type="email" id="authEmail" placeholder="E-posta" style="width:100%; margin-bottom:10px;">
      <input type="password" id="authPass" placeholder="Åžifre" style="width:100%; margin-bottom:10px;">
      <div id="authError" style="color:#fb7185; font-size:12px; text-align:center; margin-bottom:10px;"></div>
      <button id="btnLogin" class="btn primary" style="width:100%; margin-bottom:8px;">GiriÅŸ Yap</button>
      <button id="btnSignup" class="btn" style="width:100%;">KayÄ±t Ol</button>
    </div>
  </div>

  <div class="wrap" id="appWrap" style="display:none;">
    
    <div class="desktop-layout">
      <header>
        <h1>Minimal To-Do v16 <span style="font-size:11px; color:var(--accent);">Desktop</span></h1>
        <div style="display:flex; gap:8px;">
           <span id="userEmailDisplay" style="font-size:12px; color:var(--muted); align-self:center;"></span>
           <button class="btn danger" id="btnLogoutD">Ã‡Ä±kÄ±ÅŸ</button>
        </div>
      </header>
      <div class="desktop-grid">
        <div class="calendarArea">
          <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <div class="seg"><button id="btnWeekD" class="active">Hafta</button><button id="btnMonthD">Ay</button></div>
            <div>
              <button id="prevD" class="btn">â—€</button>
              <button id="todayD" class="btn">BugÃ¼n</button>
              <button id="nextD" class="btn">â–¶</button>
            </div>
          </div>
          <div id="desktopCalendarTitle" style="text-align:center; margin-bottom:10px; color:var(--muted);"></div>
          <div id="desktopGrid" class="grid week"></div>
          
          <div style="margin-top:20px; background:var(--card); padding:16px; border-radius:16px; border:1px solid var(--line);">
             <h3>SeÃ§ili GÃ¼n GÃ¶revleri</h3>
             <div id="desktopTaskList" style="display:flex; flex-direction:column; gap:8px; margin-top:10px;"></div>
          </div>
        </div>
        
        <aside class="side">
          <div class="panelBox">
            <h3>Brain Dump</h3>
            <div id="desktopInboxList" style="max-height:300px; overflow:auto; display:flex; flex-direction:column; gap:8px;"></div>
            <button class="btn" style="width:100%; margin-top:10px;" onclick="openModalAdd({dest:'inbox'})">+</button>
          </div>
          <div class="panelBox">
            <h3>Habits</h3>
            <div id="desktopHabitsList" style="display:flex; flex-direction:column; gap:8px;"></div>
          </div>
        </aside>
      </div>
    </div>

    <div class="mobile-layout">
      <div class="mobile-header">
        <div class="mobile-title">Minimal To-Do</div>
        <div class="mobile-date" id="mobileHeaderDate"></div>
        <button class="btn" id="mobileSyncBtn" style="padding:4px 8px; font-size:10px;">Sync</button>
      </div>

      <div class="mobile-content" id="mobileContent">
        </div>

      <button class="fab" id="mobileFab">+</button>

      <div class="bottom-nav">
        <button class="nav-item active" data-tab="day">
          <span class="nav-icon">ðŸ“…</span>
          <span>GÃ¼n</span>
        </button>
        <button class="nav-item" data-tab="month">
          <span class="nav-icon">ðŸ—“</span>
          <span>Takvim</span>
        </button>
        <button class="nav-item" data-tab="inbox">
          <span class="nav-icon">ðŸ“¥</span>
          <span>Inbox</span>
        </button>
        <button class="nav-item" data-tab="habits">
          <span class="nav-icon">âœ…</span>
          <span>Habit</span>
        </button>
        <button class="nav-item" data-tab="settings">
          <span class="nav-icon">âš™</span>
          <span>Ayar</span>
        </button>
      </div>
    </div>

  </div>

  <div id="overlay" class="overlay">
    <div class="modal">
      <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
        <h3 id="modalTitle" style="margin:0;">Ekle</h3>
        <button id="modalClose" class="btn">X</button>
      </div>
      <div style="display:flex; flex-direction:column; gap:10px;">
        <input id="mText" type="text" placeholder="BaÅŸlÄ±k..." />
        <div style="display:flex; gap:8px;">
          <input id="mTime" type="time" style="flex:1;">
          <select id="mType" style="flex:1;">
            <option value="gorev">GÃ¶rev</option>
            <option value="termin">Termin</option>
            <option value="hedef">Hedef</option>
          </select>
        </div>
        <select id="mTag"><option value="">Tag Yok</option></select>
        
        <div style="display:flex; justify-content:space-between; margin-top:10px;">
          <button id="modalDelete" class="btn danger" style="display:none;">Sil</button>
          <button id="modalSave" class="btn primary" style="margin-left:auto;">Kaydet</button>
        </div>
      </div>
    </div>
  </div>

  <div id="confirmOverlay" class="overlay" style="z-index:110;">
    <div class="modal" style="text-align:center;">
      <h3 style="margin-top:0;">Emin misin?</h3>
      <p id="confirmMsg" style="color:var(--muted);">Bu iÅŸlem geri alÄ±namaz.</p>
      <div style="display:flex; gap:10px; justify-content:center; margin-top:16px;">
        <button id="confirmNo" class="btn">Ä°ptal</button>
        <button id="confirmYes" class="btn danger">Evet, Sil</button>
      </div>
    </div>
  </div>

<script>
// --- CONFIG ---
const SUPABASE_URL = ""; 
const SUPABASE_KEY = ""; 
// --------------

const LOCAL_KEY = 'minimal_todo_v16_offline';
let db = null;
let currentUser = null;
let _supabase = null;
let selectedDate = new Date();
let mobileTab = 'day'; // day, month, inbox, habits, settings

// --- INIT ---
if(SUPABASE_URL && SUPABASE_KEY) {
  _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  initApp();
} else {
  alert("Supabase Keylerini girmeyi unutma!");
}

async function initApp() {
  const { data: { session } } = await _supabase.auth.getSession();
  if(session) handleSession(session);
  else document.getElementById('authOverlay').style.display = 'flex';

  _supabase.auth.onAuthStateChange((_event, session) => {
    if(session) handleSession(session);
    else location.reload();
  });
}

async function handleSession(session) {
  currentUser = session.user;
  document.getElementById('authOverlay').style.display = 'none';
  document.getElementById('appWrap').style.display = 'block';
  document.getElementById('userEmailDisplay').textContent = currentUser.email;
  await loadRemoteDB();
  renderAll();
}

// --- DB SYNC ---
function getEmptyDB() {
  return { 
    days:{}, inbox:[], habits:[], habitState:{ date: todayKey(), doneIds:[] },
    tags: [
       {name:'akademik', color:'#7dd3fc', order:1},
       {name:'ev', color:'#fb7185', order:2}
    ]
  };
}

async function loadRemoteDB() {
  // Local first
  try {
    const raw = localStorage.getItem(LOCAL_KEY);
    if(raw) db = JSON.parse(raw);
  } catch{}

  // Remote
  if(currentUser) {
    const { data } = await _supabase.from('user_data').select('content').eq('id', currentUser.id).single();
    if(data && data.content) {
      db = data.content;
      localStorage.setItem(LOCAL_KEY, JSON.stringify(db));
    } else if(!db) {
      db = getEmptyDB();
      saveDB(db);
    }
  } else if(!db) {
    db = getEmptyDB();
  }
}

let saveTimeout = null;
function saveDB(newDB) {
  db = newDB;
  localStorage.setItem(LOCAL_KEY, JSON.stringify(db));
  
  if(saveTimeout) clearTimeout(saveTimeout);
  saveTimeout = setTimeout(async () => {
    if(currentUser) {
      await _supabase.from('user_data').upsert({ id: currentUser.id, content: db, updated_at: new Date() });
    }
  }, 1000);
}

// --- CORE UTILS ---
function dayKey(d) { return d.toISOString().split('T')[0]; }
function todayKey() { return dayKey(new Date()); }
function addDays(d, n) { const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function startOfMonth(d) { return new Date(d.getFullYear(), d.getMonth(), 1); }
function endOfMonth(d) { return new Date(d.getFullYear(), d.getMonth()+1, 0); }
function getDayItems(k) { return (db.days[k]||[]).sort(itemSort); }

function itemSort(a,b) {
  // Rank: Termin > Hedef > Gorev
  const ranks = {termin:0, hedef:1, gorev:2};
  const ra = ranks[a.type]??2; const rb = ranks[b.type]??2;
  if(ra!==rb) return ra-rb;
  // Time
  const ta = a.time||"99:99"; const tb = b.time||"99:99";
  if(ta<tb) return -1; if(ta>tb) return 1;
  return 0;
}

function ensureHabits() {
  const t = todayKey();
  if(!db.habitState || db.habitState.date !== t) {
    db.habitState = { date: t, doneIds: [] };
    saveDB(db);
  }
}

// --- RENDER ALL ---
function renderAll() {
  // Mobile Render
  renderMobile();
  // Desktop Render (Basit tutuldu, detaylandÄ±rÄ±labilir)
  renderDesktop();
}

// --- MOBILE LOGIC ---
const mobileContent = document.getElementById('mobileContent');
const mobileHeaderDate = document.getElementById('mobileHeaderDate');
const mobileFab = document.getElementById('mobileFab');

function renderMobile() {
  const navs = document.querySelectorAll('.nav-item');
  navs.forEach(n => {
    n.classList.toggle('active', n.dataset.tab === mobileTab);
  });

  mobileContent.innerHTML = '';
  mobileFab.style.display = (mobileTab === 'settings') ? 'none' : 'flex';

  if(mobileTab === 'day') renderMobileDay();
  else if(mobileTab === 'month') renderMobileMonth();
  else if(mobileTab === 'inbox') renderMobileInbox();
  else if(mobileTab === 'habits') renderMobileHabits();
  else if(mobileTab === 'settings') renderMobileSettings();
}

// 1. Mobile Day View (Swipeable)
function renderMobileDay() {
  mobileHeaderDate.textContent = selectedDate.toLocaleDateString('tr-TR', { weekday:'long', day:'numeric', month:'long'});
  
  const wrapper = document.createElement('div');
  wrapper.className = 'mobile-day-wrapper';
  
  // Swipe Listeners
  let touchStartX = 0;
  wrapper.addEventListener('touchstart', e => touchStartX = e.changedTouches[0].screenX);
  wrapper.addEventListener('touchend', e => {
    const endX = e.changedTouches[0].screenX;
    if(endX - touchStartX > 50) { changeDay(-1); } // Swipe Right -> Prev Day
    else if(touchStartX - endX > 50) { changeDay(1); } // Swipe Left -> Next Day
  });

  const k = dayKey(selectedDate);
  const items = getDayItems(k);

  // Nav Arrows inside content
  const navDiv = document.createElement('div');
  navDiv.className = 'day-nav-bar';
  navDiv.innerHTML = `
    <button class="day-nav-btn" onclick="changeDay(-1)">â€¹</button>
    <span style="font-size:14px; color:var(--muted);">Sola/SaÄŸa kaydÄ±r</span>
    <button class="day-nav-btn" onclick="changeDay(1)">â€º</button>
  `;
  wrapper.appendChild(navDiv);

  if(items.length === 0) {
    wrapper.innerHTML += `<div class="empty-state">BugÃ¼n iÃ§in gÃ¶rev yok.<br>+ butonuna basarak ekle.</div>`;
  } else {
    items.forEach(it => {
      wrapper.appendChild(createTaskCard(it, {origin:'day', key:k}));
    });
  }

  mobileContent.appendChild(wrapper);
}

function changeDay(delta) {
  selectedDate = addDays(selectedDate, delta);
  renderAll();
}

// 2. Mobile Month View
function renderMobileMonth() {
  mobileHeaderDate.textContent = selectedDate.toLocaleDateString('tr-TR', { month:'long', year:'numeric' });
  
  const mDiv = document.createElement('div');
  
  // Days Header
  const head = document.createElement('div');
  head.className = 'm-cal-grid m-cal-head';
  ['Pzt','Sal','Ã‡ar','Per','Cum','Cts','Paz'].forEach(d => {
    head.innerHTML += `<span>${d}</span>`;
  });
  mDiv.appendChild(head);

  // Grid
  const grid = document.createElement('div');
  grid.className = 'm-cal-grid';
  
  const first = startOfMonth(selectedDate);
  const last = endOfMonth(selectedDate);
  // Start from Monday
  let start = new Date(first);
  const day = (start.getDay() + 6) % 7;
  start.setDate(start.getDate() - day);

  // 6 weeks (42 days) cover all months
  for(let i=0; i<42; i++) {
    const d = addDays(start, i);
    const k = dayKey(d);
    const isToday = k === todayKey();
    const isSel = k === dayKey(selectedDate);
    const isDiff = d.getMonth() !== selectedDate.getMonth();
    
    const items = db.days[k] || [];
    const openCount = items.filter(x => !x.done).length;
    
    // Dot logic
    let dotsHtml = '';
    items.slice(0,3).forEach(it => {
      if(!it.done) dotsHtml += `<div class="m-dot ${it.type}"></div>`;
    });

    const cell = document.createElement('div');
    cell.className = `m-cal-cell ${isToday?'today':''} ${isSel?'selected':''} ${isDiff?'diff-month':''}`;
    cell.innerHTML = `<span>${d.getDate()}</span><div class="m-dots">${dotsHtml}</div>`;
    
    cell.onclick = () => {
      selectedDate = d;
      mobileTab = 'day';
      renderAll();
    };
    grid.appendChild(cell);
  }
  
  mDiv.appendChild(grid);
  mobileContent.appendChild(mDiv);
}

// 3. Mobile Inbox
function renderMobileInbox() {
  mobileHeaderDate.textContent = "Brain Dump";
  const items = (db.inbox||[]).sort(itemSort);
  if(items.length === 0) {
    mobileContent.innerHTML = `<div class="empty-state">Inbox boÅŸ.</div>`;
    return;
  }
  items.forEach(it => {
    mobileContent.appendChild(createTaskCard(it, {origin:'inbox'}));
  });
}

// 4. Mobile Habits
function renderMobileHabits() {
  ensureHabits();
  mobileHeaderDate.textContent = "Habits";
  const doneSet = new Set(db.habitState.doneIds);
  
  if(!db.habits.length) {
    mobileContent.innerHTML = `<div class="empty-state">AlÄ±ÅŸkanlÄ±k yok.<br>+ ile ekle.</div>`;
    return;
  }

  db.habits.forEach(h => {
    const row = document.createElement('div');
    row.className = 'card';
    row.style.display = 'flex';
    row.style.alignItems = 'center';
    row.style.justifyContent = 'space-between';
    
    const isDone = doneSet.has(h.id);
    row.innerHTML = `<span>${h.name}</span>`;
    if(isDone) row.style.opacity = '0.5';

    const chk = document.createElement('button');
    chk.className = 'checkBtn';
    chk.style.background = isDone ? 'var(--accent)' : 'transparent';
    chk.innerHTML = isDone ? 'âœ“' : '';
    
    row.prepend(chk);
    
    // Toggle
    row.onclick = () => {
       if(doneSet.has(h.id)) doneSet.delete(h.id); else doneSet.add(h.id);
       db.habitState.doneIds = [...doneSet];
       saveDB(db);
       renderAll();
    };

    // Long press to delete (simple implementation)
    let pressTimer;
    row.addEventListener('touchstart', () => {
       pressTimer = setTimeout(() => {
          showConfirm(`${h.name} silinsin mi?`, () => {
             db.habits = db.habits.filter(x=>x.id!==h.id);
             saveDB(db);
             renderAll();
          });
       }, 800);
    });
    row.addEventListener('touchend', () => clearTimeout(pressTimer));

    mobileContent.appendChild(row);
  });
}

// 5. Mobile Settings (Tags)
function renderMobileSettings() {
  mobileHeaderDate.textContent = "Ayarlar & Tagler";
  
  // Logout
  const logoutBtn = document.createElement('button');
  logoutBtn.className = 'btn danger';
  logoutBtn.textContent = "Ã‡Ä±kÄ±ÅŸ Yap";
  logoutBtn.style.width = '100%';
  logoutBtn.style.marginBottom = '20px';
  logoutBtn.onclick = () => _supabase.auth.signOut();
  mobileContent.appendChild(logoutBtn);

  // Tag List
  const title = document.createElement('h3'); title.textContent = "Tag YÃ¶netimi";
  mobileContent.appendChild(title);
  
  db.tags.forEach(t => {
    const d = document.createElement('div');
    d.className = 'card';
    d.style.display = 'flex'; d.style.justifyContent='space-between';
    d.innerHTML = `
      <div style="display:flex; align-items:center; gap:8px;">
        <div style="width:12px; height:12px; background:${t.color}; border-radius:50%;"></div>
        <span>${t.name}</span>
      </div>
      <button class="btn danger" style="padding:2px 6px;">Sil</button>
    `;
    d.querySelector('button').onclick = () => {
       showConfirm('Tag silinsin mi?', () => {
         db.tags = db.tags.filter(x=>x.name!==t.name);
         saveDB(db); renderAll();
       });
    };
    mobileContent.appendChild(d);
  });

  // Add Tag
  const addDiv = document.createElement('div');
  addDiv.style.marginTop = '10px';
  addDiv.innerHTML = `<input id="newTagNameM" placeholder="Yeni tag"><input type="color" id="newTagColorM" value="#7dd3fc" style="width:40px;margin-left:5px;"><button id="addTagM" class="btn primary" style="margin-left:5px;">Ekle</button>`;
  mobileContent.appendChild(addDiv);
  
  addDiv.querySelector('#addTagM').onclick = () => {
     const n = document.getElementById('newTagNameM').value;
     const c = document.getElementById('newTagColorM').value;
     if(n) {
       db.tags.push({name:n, color:c, order:99});
       saveDB(db); renderAll();
     }
  };
}

// --- CARD CREATION (Shared) ---
function createTaskCard(item, ctx) {
  const el = document.createElement('div');
  el.className = `card ${item.done ? 'done' : ''}`;
  
  // Color Border
  let color = 'var(--line)';
  if(item.type === 'termin') color = 'var(--frame-termin)';
  if(item.type === 'hedef') color = 'var(--frame-hedef)';
  if(item.type === 'gorev') color = 'var(--frame-gorev)';
  el.style.setProperty('--frameColor', color);

  // Tag Color
  const tagObj = db.tags.find(t => t.name === item.tag);
  const tagDot = tagObj ? `<span class="tagDot" style="background:${tagObj.color}"></span>` : '';

  el.innerHTML = `
    <div class="cardRow">
      <button class="checkBtn">${item.done ? 'âœ“' : ''}</button>
      <div class="cardBody">
        <div class="titleText">${tagDot}${item.text}</div>
        ${item.time ? `<div class="timeText">ðŸ•’ ${item.time}</div>` : ''}
      </div>
    </div>
  `;

  // Check Action
  el.querySelector('.checkBtn').onclick = (e) => {
    e.stopPropagation();
    item.done = !item.done;
    saveDB(db);
    renderAll();
  };

  // Edit Action (Tap body)
  el.querySelector('.cardBody').onclick = () => {
    openModalEdit(item, ctx);
  };

  return el;
}

// --- MODAL LOGIC ---
const overlay = document.getElementById('overlay');
let modalCtx = null; // { mode: 'add'|'edit', item: ref, context: {origin, key} }

function closeModal() { overlay.style.display = 'none'; }
document.getElementById('modalClose').onclick = closeModal;

// Tag select filler
function fillTags() {
  const s = document.getElementById('mTag');
  s.innerHTML = '<option value="">Tag Yok</option>';
  db.tags.forEach(t => {
    s.innerHTML += `<option value="${t.name}">${t.name}</option>`;
  });
}

function openModalAdd(ctx) { // ctx: {dest: 'inbox' or 'day'}
  modalCtx = { mode: 'add', dest: ctx.dest };
  document.getElementById('modalTitle').textContent = ctx.dest === 'inbox' ? 'Inboxa Ekle' : 'GÃ¼ne Ekle';
  document.getElementById('mText').value = '';
  document.getElementById('mTime').value = '';
  document.getElementById('mType').value = 'gorev';
  document.getElementById('modalDelete').style.display = 'none';
  fillTags();
  overlay.style.display = 'flex';
}

function openModalEdit(item, context) { // context: {origin, key}
  modalCtx = { mode: 'edit', item: item, context: context };
  document.getElementById('modalTitle').textContent = 'DÃ¼zenle';
  document.getElementById('mText').value = item.text;
  document.getElementById('mTime').value = item.time || '';
  document.getElementById('mType').value = item.type;
  fillTags();
  document.getElementById('mTag').value = item.tag || '';
  document.getElementById('modalDelete').style.display = 'block';
  overlay.style.display = 'flex';
}

document.getElementById('modalSave').onclick = () => {
  const txt = document.getElementById('mText').value;
  if(!txt) return;
  const time = document.getElementById('mTime').value;
  const type = document.getElementById('mType').value;
  const tag = document.getElementById('mTag').value;

  if(modalCtx.mode === 'add') {
    const newItem = {
      id: crypto.randomUUID(), text: txt, time: time, type: type, tag: tag, done: false, created: Date.now()
    };
    if(modalCtx.dest === 'inbox') db.inbox.push(newItem);
    else {
      const k = dayKey(selectedDate);
      if(!db.days[k]) db.days[k] = [];
      db.days[k].push(newItem);
    }
  } else {
    // Edit
    const it = modalCtx.item;
    it.text = txt; it.time = time; it.type = type; it.tag = tag;
  }
  saveDB(db);
  closeModal();
  renderAll();
};

document.getElementById('modalDelete').onclick = () => {
  showConfirm('Silinsin mi?', () => {
    const { item, context } = modalCtx;
    if(context.origin === 'inbox') {
      db.inbox = db.inbox.filter(x => x.id !== item.id);
    } else {
      const arr = db.days[context.key];
      db.days[context.key] = arr.filter(x => x.id !== item.id);
    }
    saveDB(db);
    closeModal();
    renderAll();
  });
};

// --- EVENTS ---
mobileFab.onclick = () => {
  if(mobileTab === 'inbox') openModalAdd({dest:'inbox'});
  else if(mobileTab === 'habits') {
    const n = prompt("Yeni AlÄ±ÅŸkanlÄ±k:");
    if(n) { db.habits.push({id: crypto.randomUUID(), name:n}); saveDB(db); renderAll(); }
  }
  else openModalAdd({dest:'day'});
};

document.querySelectorAll('.nav-item').forEach(btn => {
  btn.onclick = () => {
    mobileTab = btn.dataset.tab;
    renderAll();
  };
});

// Custom Confirm
const confirmOverlay = document.getElementById('confirmOverlay');
let confirmCallback = null;
function showConfirm(msg, cb) {
  document.getElementById('confirmMsg').textContent = msg;
  confirmCallback = cb;
  confirmOverlay.style.display = 'flex';
}
document.getElementById('confirmYes').onclick = () => {
  if(confirmCallback) confirmCallback();
  confirmOverlay.style.display = 'none';
};
document.getElementById('confirmNo').onclick = () => { confirmOverlay.style.display = 'none'; };

// Login Events
document.getElementById('btnLogin').onclick = async () => {
  const { error } = await _supabase.auth.signInWithPassword({
    email: document.getElementById('authEmail').value,
    password: document.getElementById('authPass').value
  });
  if(error) document.getElementById('authError').textContent = error.message;
};
document.getElementById('btnSignup').onclick = async () => {
  const { error } = await _supabase.auth.signUp({
    email: document.getElementById('authEmail').value,
    password: document.getElementById('authPass').value
  });
  if(error) document.getElementById('authError').textContent = error.message;
  else alert("KayÄ±t olundu! GiriÅŸ yapabilirsin.");
};
document.getElementById('btnLogoutD').onclick = () => _supabase.auth.signOut();

// --- DESKTOP RENDER STUB (Mevcut mantÄ±k buraya taÅŸÄ±nabilir, ÅŸimdilik boÅŸ) ---
function renderDesktop() {
  // Desktop gÃ¶rÃ¼nÃ¼mÃ¼ iÃ§in eski kodun mantÄ±ÄŸÄ±nÄ± buraya taÅŸÄ±yabilirsin.
  // Mobil odaklÄ± olduÄŸumuz iÃ§in ÅŸu an sadece mobilde Ã§alÄ±ÅŸÄ±yor olacak.
  // Ancak masaÃ¼stÃ¼ layout HTML'i de orada duruyor.
}

// Initial Sync Click
document.getElementById('mobileSyncBtn').onclick = () => {
  loadRemoteDB();
  renderAll();
};

</script>
</body>
</html>
