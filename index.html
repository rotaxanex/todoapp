<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#111111" />
  <title>todoapp</title>

  <!-- Supabase -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#0f0f10; --card:#17171a; --muted:#a3a3a3; --text:#f5f5f5; --line:#2a2a2f; --accent:#7dd3fc;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --frame-termin:#fb7185; --frame-hedef:#60a5fa; --frame-gorev:#34d399;
      --monthCellH: 130px;
    }

    *{ box-sizing:border-box; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    html, body{ height:100%; }
    body{ margin:0; background:var(--bg); color:var(--text); }
    .wrap{ max-width:1440px; margin:0 auto; padding:16px; }

    /* AUTH */
    .auth-overlay{
      position: fixed; inset: 0; background: var(--bg); z-index: 999999;
      display: flex; align-items: center; justify-content: center;
      flex-direction: column; gap: 20px;
    }
    .auth-box{
      background: var(--card); border: 1px solid var(--line);
      padding: 24px; border-radius: 18px; width: min(350px, 90%);
      display: flex; flex-direction: column; gap: 12px;
      box-shadow: var(--shadow);
    }
    .auth-box h2{ margin: 0 0 10px 0; font-size: 20px; text-align: center; }
    .auth-input{
      background: #101014; color: var(--text); border: 1px solid var(--line);
      border-radius: 10px; padding: 10px; outline: none;
    }
    .auth-btn{
      background: var(--text); color: var(--bg); border: none; font-weight: bold;
      padding: 10px; border-radius: 10px; cursor: pointer; margin-top: 5px;
    }
    .auth-btn:hover{ opacity: 0.9; }
    .auth-msg{
      color: var(--frame-termin); font-size: 13px; text-align: center;
      min-height: 18px; white-space: pre-wrap;
    }
    .hidden{ display:none !important; }

    /* Status */
    .sync-status{ font-size: 11px; color: var(--muted); display: flex; align-items: center; gap: 6px; }
    .dot-status{ width: 8px; height: 8px; border-radius: 50%; background: #666; }
    .dot-status.online{ background: #34d399; box-shadow: 0 0 5px #34d399; }
    .dot-status.syncing{ background: #fbbf24; }

    /* App */
    header{ display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:12px; flex-wrap:wrap; }
    .left{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    h1{ font-size:16px; margin:0; font-weight:650; letter-spacing:.2px; }

    .btn{ background:var(--card); border:1px solid var(--line); color:var(--text); padding:8px 10px; border-radius:12px; cursor:pointer; }
    .btn:hover{ border-color:#3a3a44; }
    .btn:active{ transform: translateY(1px); }
    .btn.danger{ color:#fb7185; border-color:rgba(251,113,133,.35); }

    .seg{ display:flex; background:var(--card); border:1px solid var(--line); border-radius:14px; overflow:hidden; }
    .seg button{ border:0; background:transparent; color:var(--muted); padding:8px 12px; cursor:pointer; }
    .seg button.active{ color:var(--text); background:#1f1f24; }

    .bar{ display:flex; gap:10px; align-items:center; justify-content:space-between; margin:10px 0 12px; flex-wrap:wrap; }
    .nav{ display:flex; gap:8px; align-items:center; }
    .title{ font-size:14px; color:var(--muted); }
    .filters{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    select, input[type="text"], input[type="search"], input[type="time"]{
      background:#101014; color:var(--text);
      border:1px solid var(--line); border-radius:12px;
      padding:8px 10px; outline:none; font-size:13px;
    }

    .main{ display:grid; grid-template-columns: 1fr 240px; gap:12px; align-items:start; }
    .calendarArea{ height: calc(100vh - 210px); overflow:auto; padding-right:4px; }

    body.weekMode .calendarArea{ height: calc(100vh - 320px); }

    /* âœ… Month: takvim alanÄ±nÄ± ~5/6 yÃ¼kseklik */
    body.monthMode .calendarArea{
      height: calc(100vh * 0.833 - 120px);
    }

    .grid{ display:grid; gap:10px; }
    .month{ grid-template-columns: repeat(7, 1fr); }
    .week{ grid-template-columns: repeat(7, 1fr); }
    .dow{ font-size:12px; color:var(--muted); padding:0 6px; }
    body.weekMode .grid{ gap:8px; }

    .cell{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      gap:8px;
      overflow:hidden;
      min-width:0;
    }
    .cell.weekCell{ min-height:280px; overflow:hidden; } /* âœ… taÅŸmayÄ± kes */
    .cell.monthCell{ height: var(--monthCellH); }

    .cell.out{ opacity:.55; }
    .cell.sel{ outline:2px solid rgba(125,211,252,.35); border-color:rgba(125,211,252,.35); }
    .cell.dragOver{ outline:2px dashed rgba(125,211,252,.45); border-color:rgba(125,211,252,.45); }

    .dateRow{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .dateLeft{ display:flex; align-items:center; gap:8px; min-width:0; }
    .date{ font-size:12px; color:var(--muted); }
    .count{ font-size:12px; color:var(--accent); }

    .plusBtn{
      width:26px; height:26px;
      display:grid; place-items:center;
      border-radius:10px;
      border:1px solid var(--line);
      background:transparent;
      color:var(--muted);
      cursor:pointer;
      flex:0 0 auto;
    }
    .plusBtn:hover{ border-color:#3a3a44; color:var(--text); }

    .cards{
      display:flex;
      flex-direction:column;
      gap:6px;
      overflow:auto;
      min-height:0;
      padding-right:2px;
      flex: 1 1 auto; /* âœ… hÃ¼cre iÃ§inde bÃ¼yÃ¼sÃ¼n, scroll alsÄ±n */
    }

    .card{
      border:2px solid var(--frameColor, var(--line));
      border-radius:12px;
      padding:6px 8px;
      background: var(--fillColor, rgba(255,255,255,0.04));
      user-select:none;
      min-width:0;
      position:relative;
    }
    .card[draggable="true"]{ cursor:grab; }
    .card:active{ cursor:grabbing; }
    .card.done{ opacity:.55; }

    .cardRow{ display:flex; align-items:flex-start; gap:8px; min-width:0; }
    .checkBtn{
      width:18px; height:18px;
      display:grid; place-items:center;
      border-radius:7px;
      border:1px solid rgba(0,0,0,.25);
      background:rgba(0,0,0,.10);
      color:rgba(255,255,255,.85);
      cursor:pointer;
      flex:0 0 auto;
      font-size:11px;
      line-height:1;
      margin-top:1px;
    }
    .cardBody{
      flex:1 1 auto;
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:3px;
      padding-right:22px;
    }
    .titleText{
      font-size:12.8px;
      line-height:1.2;
      color: var(--text);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .timeText{
      font-size:11px;
      line-height:1.1;
      color: rgba(255,255,255,.75);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Month compact + time right */
    body.monthMode .card{ padding:4px 6px; border-radius:10px; }
    body.monthMode .cards{ gap:4px; }
    body.monthMode .checkBtn{ width:14px; height:14px; border-radius:6px; font-size:9px; margin-top:0; }
    body.monthMode .cardBody{
      gap:2px; padding-right:20px;
      flex-direction: row; align-items:center; gap:6px;
    }
    body.monthMode .titleText{ font-size:11px; flex:1 1 auto; }
    body.monthMode .timeText{ font-size:9.5px; opacity:.85; flex:0 0 auto; }

    /* Month cell scrollbar thinner */
    body.monthMode .monthCell .cards{ scrollbar-width: thin; scrollbar-color: rgba(255,255,255,.22) transparent; }
    body.monthMode .monthCell .cards::-webkit-scrollbar{ width: 5px; }
    body.monthMode .monthCell .cards::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.18); border-radius: 999px; }

    .moreBtn{
      position:absolute;
      top:6px; right:6px;
      width:18px; height:18px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,.15);
      background:rgba(0,0,0,.12);
      color:rgba(255,255,255,.85);
      cursor:pointer;
      display:grid; place-items:center;
      font-size:14px;
      line-height:1;
    }

    .side{ position:sticky; top:12px; display:flex; flex-direction:column; gap:12px; }
    .panelBox{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px;
      box-shadow: var(--shadow);
    }
    .panelHead{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .panelHead h2{ margin:0; font-size:14px; }
    .muted{ color:var(--muted); font-size:12px; }

    .inbox.dragOver{ outline:2px dashed rgba(125,211,252,.45); border-color:rgba(125,211,252,.45); }
    .inboxList{ display:flex; flex-direction:column; gap:8px; overflow:auto; max-height:40vh; padding-right:2px; }

    .bottom{ margin-top: 0px; background:transparent; border:0; padding:0; }
    body.weekMode .bottom{ margin-top: -64px; } /* senin ayarÄ±n */

    .bottomGrid{ display:block; }
    body.weekMode .bottomGrid{
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:10px;
      align-items:start;
    }

    .panelLike{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px;
      box-shadow: var(--shadow);
    }

    .bottomTop{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .panelLike h2{ margin:0; font-size:14px; }

    form{ display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
    .w{ min-width:160px; }
    .list{ margin-top:10px; display:flex; flex-direction:column; gap:8px; }

    .row{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border:1px solid var(--line);
      background:#121216;
      padding:10px 12px;
      border-radius:14px;
    }
    .row .txt{ font-size:13px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    /* âœ… Month mode: 5/7 + 2/7 layout, side visible */
    body.monthMode .main{ grid-template-columns: 5fr 2fr; }
    body.monthMode .side{ display:flex; }
    body.monthMode #bottomInboxSlot{ display:block; } /* week dock slot, month'ta artÄ±k saÄŸda panelde iÅŸ gÃ¶rebilir */

    /* Modal */
    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding:16px;
      z-index:50;
    }
    .modal{
      width:min(760px, 100%);
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px;
      box-shadow: var(--shadow);
      max-height: 86vh;
      overflow:auto;
    }
    .modalTop{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .modalGrid{ display:grid; grid-template-columns: 1fr 170px 170px 1fr; gap:8px; margin-top:10px; }
    .modalGrid .full{ grid-column: 1 / -1; }
    .modalActions{ display:flex; justify-content:space-between; align-items:center; gap:8px; margin-top:10px; }

    /* Tag settings */
    .tagManager{ display:flex; flex-direction:column; gap:8px; margin-top:10px; }
    .tagItem{ display:grid; grid-template-columns: 1fr auto auto; gap:8px; align-items:center; border:1px solid var(--line); background:#121216; padding:8px 10px; border-radius:14px; }
    .tagName{ display:flex; align-items:center; gap:10px; min-width:0; }
    .dot{ width:10px; height:10px; border-radius:999px; display:inline-block; }
    input[type="color"]{ width:44px; height:34px; border-radius:12px; border:1px solid var(--line); background:transparent; padding:0; }
    .iconBtn{ width:38px; height:34px; display:grid; place-items:center; border-radius:12px; border:1px solid var(--line); background:transparent; color:var(--muted); cursor:pointer; }

    /* Habits */
    .habitsList{ display:flex; flex-direction:column; gap:10px; }
    .habitRow{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 10px; border:1px solid var(--line); background:#121216; border-radius:14px; }
    .habitRow label{ display:flex; align-items:center; gap:10px; min-width:0; }
    .habitRow input[type="checkbox"]{ width:18px; height:18px; }

    @media (max-width: 900px){
      .main{ grid-template-columns: 1fr; }
      body.monthMode .main{ grid-template-columns: 1fr; }
      .side{ position:static; }
      .calendarArea{ height:auto; max-height:none; }
      body.weekMode .bottomGrid{ grid-template-columns: 1fr; }
      body.weekMode .bottom{ margin-top: 0px; }
    }
  </style>
</head>

<body>
  <!-- AUTH -->
  <div id="authOverlay" class="auth-overlay">
    <div class="auth-box">
      <h2>Minimal To-Do Sync</h2>
      <div id="authError" class="auth-msg"></div>
      <input id="emailInput" class="auth-input" type="email" placeholder="E-posta" />
      <input id="passInput" class="auth-input" type="password" placeholder="Åžifre" />
      <button id="btnLogin" class="auth-btn" type="button">GiriÅŸ Yap</button>
      <button id="btnRegister" class="auth-btn" type="button" style="background:#333; color:white;">KayÄ±t Ol</button>
    </div>
  </div>

  <!-- APP -->
  <div class="wrap" id="appWrap" style="filter:blur(5px); pointer-events:none;">
    <header>
      <div class="left">
        <h1>todoapp</h1>
        <div class="seg" role="tablist">
          <button id="btnWeek" class="active" type="button">Hafta</button>
          <button id="btnMonth" type="button">Ay</button>
        </div>
      </div>

      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <div class="sync-status">
          <div id="statusDot" class="dot-status"></div>
          <span id="statusText">Offline</span>
        </div>
        <button id="tagSettingsBtn" class="btn" type="button">Taglar</button>
        <button id="btnLogout" class="btn danger" type="button">Ã‡Ä±kÄ±ÅŸ</button>
      </div>
    </header>

    <div class="bar">
      <div class="nav">
        <button id="prev" class="btn" type="button">â—€</button>
        <button id="today" class="btn" type="button">BugÃ¼n</button>
        <button id="next" class="btn" type="button">â–¶</button>
      </div>

      <div class="filters">
        <div class="title" id="rangeTitle"></div>
        <select id="tagFilter"><option value="__all__">Tag: Hepsi</option></select>
        <select id="typeFilter">
          <option value="__preset__">TÃ¼r: GÃ¶rÃ¼nÃ¼m</option>
          <option value="__all__">TÃ¼r: Hepsi</option>
          <option value="termin">Sadece termin</option>
          <option value="hedef">Sadece hedef</option>
          <option value="gorev">Sadece gÃ¶rev</option>
        </select>
        <input id="search" type="search" placeholder="Araâ€¦" />
      </div>
    </div>

    <div class="main">
      <div id="leftCol">
        <div id="calendarArea" class="calendarArea">
          <div class="grid" id="dowRow"></div>
          <div class="grid week" id="grid"></div>
        </div>

        <section class="bottom" id="bottom">
          <div class="bottomGrid" id="bottomGrid">
            <div class="panelLike">
              <div class="bottomTop">
                <div>
                  <h2 id="panelTitle">SeÃ§ili gÃ¼n</h2>
                  <div class="muted">SÄ±ralama: Termin â†’ Hedef â†’ GÃ¶rev</div>
                </div>
                <div>
                  <button id="clearDone" class="btn" type="button">TamamlananlarÄ± temizle</button>
                </div>
              </div>

              <form id="addForm" autocomplete="off">
                <input class="w" id="taskInput" type="text" placeholder="BaÅŸlÄ±kâ€¦" maxlength="120" />
                <input class="w" id="timeInput" type="time" title="Saat" />
                <select class="w" id="typeInput" title="TÃ¼r">
                  <option value="termin">Termin</option>
                  <option value="hedef">Hedef</option>
                  <option value="gorev">GÃ¶rev</option>
                </select>
                <select class="w" id="tagInput" title="Tag"></select>
                <select class="w" id="whereInput" title="Hedef">
                  <option value="selected">SeÃ§ili gÃ¼ne</option>
                  <option value="inbox">Inbox</option>
                </select>
                <button id="addSubmit" class="btn" type="submit">Ekle</button>
              </form>

              <div class="list" id="taskList"></div>
            </div>

            <div id="bottomInboxSlot" class="panelLike"></div>
          </div>
        </section>
      </div>

      <aside class="side" id="sideCol">
        <div id="inbox" class="panelBox inbox">
          <div class="panelHead">
            <div>
              <h2>Brain Dump</h2>
              <div class="muted">GÃ¼ne atanmamÄ±ÅŸ kartlar</div>
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
              <button id="inboxAdd" class="plusBtn" type="button">+</button>
              <button id="clearInboxDone" class="btn" type="button">Temizle</button>
            </div>
          </div>
          <div class="muted" id="inboxCount"></div>
          <div id="inboxList" class="inboxList"></div>
        </div>

        <div id="habitsBox" class="panelBox">
          <div class="panelHead">
            <div>
              <h2>Habits</h2>
              <div class="muted" id="habitsSub">Her gÃ¼n sÄ±fÄ±rlanÄ±r</div>
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
              <button id="habitAddBtn" class="plusBtn" type="button">+</button>
              <button id="habitResetBtn" class="btn" type="button">Reset</button>
            </div>
          </div>
          <div class="habitsList" id="habitsList"></div>
        </div>
      </aside>
    </div>
  </div>

  <!-- MODAL -->
  <div id="overlay" class="overlay">
    <div class="modal">
      <div class="modalTop">
        <h3 id="modalTitle">Modal</h3>
        <button id="modalClose" class="btn" type="button">Kapat</button>
      </div>

      <div id="quickAddSection">
        <div class="muted" id="modalWhere"></div>
        <div class="modalGrid">
          <input id="mText" class="full" type="text" placeholder="BaÅŸlÄ±kâ€¦" maxlength="120" />
          <input id="mTime" type="time" />
          <select id="mType">
            <option value="termin">Termin</option>
            <option value="hedef">Hedef</option>
            <option value="gorev">GÃ¶rev</option>
          </select>
          <select id="mTag"></select>
          <div class="full muted">Enter = Kaydet/Ekle</div>
        </div>
        <div class="modalActions">
          <button id="modalDelete" class="btn danger" type="button" style="display:none;">Sil</button>
          <div style="display:flex; gap:8px; margin-left:auto;">
            <button id="modalSave" class="btn" type="button">Ekle</button>
          </div>
        </div>
      </div>

      <div id="tagSettingsSection" style="display:none;">
        <div class="muted">Tag sÄ±ralamasÄ±nÄ± drag-drop ile deÄŸiÅŸtir.</div>
        <div class="tagManager" id="tagManager"></div>
      </div>
    </div>
  </div>

  <script>
    // ======================
    // SUPABASE AYARLARI
    // ======================
    const SUPABASE_URL = 'https://czuprhvrnlqpipcytvwx.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_IR67FHQQNsnA9aNMizaqUA_HYGC8cKM';
    // âš ï¸ Not: "publishable" key bazÄ± projelerde auth/db iÃ§in yetmez. Supabase panelde "anon/public" key kullanmak gerekir.

    let supabaseClient = null;
    let user = null;
    let syncTimer = null;

    if (!window.supabase) {
      alert("KRÄ°TÄ°K HATA: Supabase kÃ¼tÃ¼phanesi yÃ¼klenemedi! Ä°nternet veya AdBlock kontrol et.");
    } else {
      try {
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
      } catch (e) {
        alert("Supabase createClient hatasÄ±: " + e.message);
      }
    }

    const authOverlay = document.getElementById('authOverlay');
    const appWrap = document.getElementById('appWrap');
    const authError = document.getElementById('authError');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');

    // ======================
    // LOCAL DB + SYNC
    // ======================
    const KEY = 'minimal_todo_v15_cloud';

    function todayKey(){ return dayKey(new Date()); }
    function defaultTags(){
      return [
        {name:'akademik',color:'#7dd3fc',order:1},
        {name:'praktikum',color:'#34d399',order:2},
        {name:'finans',color:'#fbbf24',order:3},
        {name:'ev',color:'#fb7185',order:4}
      ];
    }

    let db = {
      days:{},
      inbox:[],
      tags: defaultTags(),
      habits:[],
      habitState:{ date: todayKey(), doneIds:[] }
    };

    function saveLocal(){ localStorage.setItem(KEY, JSON.stringify(db)); }

    function saveDB(newDb){
      db = newDb;
      saveLocal();
      saveRemoteDebounced();
    }

    function saveRemoteDebounced(){
      statusDot.className = 'dot-status syncing';
      clearTimeout(syncTimer);
      syncTimer = setTimeout(()=>saveRemote(), 900);
    }

    async function saveRemote(){
      if(!user || !supabaseClient) return;
      const { error } = await supabaseClient
        .from('user_data')
        .upsert({ id: user.id, content: db, updated_at: new Date().toISOString() });

      if(error){
        console.error("Sync error", error);
        statusDot.className = 'dot-status';
      } else {
        statusDot.className = 'dot-status online';
      }
    }

    async function loadRemoteData(){
      if(!user || !supabaseClient) return;

      statusDot.className = 'dot-status syncing';

      // local Ã¶nce
      const local = localStorage.getItem(KEY);
      if(local){
        try { db = JSON.parse(local); } catch {}
      }

      const { data, error } = await supabaseClient
        .from('user_data')
        .select('content')
        .eq('id', user.id)
        .single();

      if(error){
        // yeni kullanÄ±cÄ±ysa record oluÅŸtur
        if (error.code === 'PGRST116') {
          await saveRemote();
        } else {
          console.error("Veri hatasÄ±:", error);
          if(error.code === '42P01') alert("HATA: Supabase 'user_data' tablosu yok! SQL'i Ã§alÄ±ÅŸtÄ±r.");
        }
      } else if(data && data.content){
        db = data.content;
        saveLocal();
      }

      statusDot.className = 'dot-status online';
      render();
    }

    async function checkUser(){
      if(!supabaseClient) return;

      const { data, error } = await supabaseClient.auth.getSession();
      if(error) console.error("Session hatasÄ±:", error);

      user = data.session?.user || null;

      if(user){
        authOverlay.classList.add('hidden');
        appWrap.style.filter = 'none';
        appWrap.style.pointerEvents = 'auto';
        statusText.textContent = user.email;
        statusDot.className = 'dot-status online';
        await loadRemoteData();
      } else {
        authOverlay.classList.remove('hidden');
        appWrap.style.filter = 'blur(5px)';
        appWrap.style.pointerEvents = 'none';
        statusText.textContent = 'GiriÅŸ gerekli';
        statusDot.className = 'dot-status';
      }
    }

    document.getElementById('btnLogin').addEventListener('click', async ()=>{
      const email = document.getElementById('emailInput').value.trim();
      const password = document.getElementById('passInput').value;
      if(!email || !password){ authError.textContent = "LÃ¼tfen email ve ÅŸifre gir."; return; }
      authError.textContent = "GiriÅŸ yapÄ±lÄ±yor...";
      const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if(error){ authError.textContent = error.message; alert("GÄ°RÄ°Åž HATASI:\n"+error.message); }
      else { authError.textContent = "BaÅŸarÄ±lÄ±!"; checkUser(); }
    });

    document.getElementById('btnRegister').addEventListener('click', async ()=>{
      const email = document.getElementById('emailInput').value.trim();
      const password = document.getElementById('passInput').value;
      if(!email || !password){ authError.textContent = "LÃ¼tfen email ve ÅŸifre gir."; return; }
      if(password.length < 6){ authError.textContent = "Åžifre en az 6 karakter."; return; }
      authError.textContent = "KayÄ±t olunuyor...";
      const { data, error } = await supabaseClient.auth.signUp({ email, password });
      if(error){ authError.textContent = error.message; alert("KAYIT HATASI:\n"+error.message); }
      else {
        if(data.session){ alert("KayÄ±t baÅŸarÄ±lÄ± ve giriÅŸ yapÄ±ldÄ±!"); checkUser(); }
        else alert("KayÄ±t baÅŸarÄ±lÄ±! Confirm aÃ§Ä±k ise email onayla.");
      }
    });

    document.getElementById('btnLogout').addEventListener('click', async ()=>{
      if(!supabaseClient) return;
      await supabaseClient.auth.signOut();
      location.reload();
    });

    // ======================
    // APP HELPERS
    // ======================
    function dayKey(d){
      const y=d.getFullYear();
      const m=String(d.getMonth()+1).padStart(2,'0');
      const da=String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    }
    function startOfWeek(date){
      const d=new Date(date.getFullYear(), date.getMonth(), date.getDate());
      const day=(d.getDay()+6)%7;
      d.setDate(d.getDate()-day);
      return d;
    }
    function addDays(date,n){
      const d=new Date(date.getFullYear(), date.getMonth(), date.getDate());
      d.setDate(d.getDate()+n);
      return d;
    }
    function startOfMonth(date){ return new Date(date.getFullYear(), date.getMonth(), 1); }
    function endOfMonth(date){ return new Date(date.getFullYear(), date.getMonth()+1, 0); }
    function fmtRange(a,b){
      return `${a.toLocaleDateString('tr-TR',{day:'2-digit',month:'short'})} â€“ ${b.toLocaleDateString('tr-TR',{day:'2-digit',month:'short',year:'numeric'})}`;
    }
    function fmtDay(d){
      return d.toLocaleDateString('tr-TR', { weekday:'long', day:'2-digit', month:'long', year:'numeric' });
    }
    function normalizeTagName(s){ return (s||'').trim().toLowerCase().replace(/\s+/g,'-'); }
    function fixItem(t){
      return {
        id: t.id || (crypto.randomUUID ? crypto.randomUUID() : String(Date.now())+Math.random()),
        text: (t.text||'').trim(),
        done: !!t.done,
        type: (['gorev','termin','hedef'].includes(t.type)?t.type:'gorev'),
        tag: (t.tag||''),
        time: (t.time||''),
        created: t.created || Date.now()
      };
    }
    function getCssVar(n){ return getComputedStyle(document.documentElement).getPropertyValue(n).trim(); }
    function typeFrameColor(t){ return t==='termin'?getCssVar('--frame-termin'):t==='hedef'?getCssVar('--frame-hedef'):getCssVar('--frame-gorev'); }
    function hexToRgba(h,a){
      if(!h) return `rgba(255,255,255,${a})`;
      const x=h.replace('#','').trim();
      const f=x.length===3?x.split('').map(c=>c+c).join(''):x;
      const r=parseInt(f.slice(0,2),16), g=parseInt(f.slice(2,4),16), b=parseInt(f.slice(4,6),16);
      return `rgba(${r},${g},${b},${a})`;
    }
    function typeRank(t){ return t==='termin'?0:t==='hedef'?1:2; }
    function tagMeta(n){ return db.tags.find(x=>x.name===n); }
    function tagOrder(n){ const m=tagMeta(n); return m ? (m.order ?? 9999) : 9999; }
    function itemSort(a,b){
      const ra=typeRank(a.type), rb=typeRank(b.type);
      if(ra!==rb) return ra-rb;
      const ta=a.time||'99:99', tb=b.time||'99:99';
      if(ta<tb) return -1; if(ta>tb) return 1;
      const oa=tagOrder(a.tag), ob=tagOrder(b.tag);
      if(oa!==ob) return oa-ob;
      return (a.created||0)-(b.created||0);
    }

    // ======================
    // UI REFS
    // ======================
    const DOW=['Pzt','Sal','Ã‡ar','Per','Cum','Cts','Paz'];
    let mode='week';
    let anchor=new Date();
    let selected=new Date();
    let dragPayload=null;

    const calendarArea=document.getElementById('calendarArea');
    const grid=document.getElementById('grid');
    const dowRow=document.getElementById('dowRow');
    const rangeTitle=document.getElementById('rangeTitle');

    const btnWeek=document.getElementById('btnWeek');
    const btnMonth=document.getElementById('btnMonth');

    const panelTitle=document.getElementById('panelTitle');
    const taskList=document.getElementById('taskList');

    const addForm=document.getElementById('addForm');
    const taskInput=document.getElementById('taskInput');
    const timeInput=document.getElementById('timeInput');
    const typeInput=document.getElementById('typeInput');
    const tagInput=document.getElementById('tagInput');
    const whereInput=document.getElementById('whereInput');
    const clearDone=document.getElementById('clearDone');
    const addSubmit=document.getElementById('addSubmit');

    const tagFilter=document.getElementById('tagFilter');
    const typeFilter=document.getElementById('typeFilter');
    const search=document.getElementById('search');

    const inbox=document.getElementById('inbox');
    const inboxList=document.getElementById('inboxList');
    const inboxCount=document.getElementById('inboxCount');
    const inboxAdd=document.getElementById('inboxAdd');
    const clearInboxDone=document.getElementById('clearInboxDone');
    const bottomInboxSlot=document.getElementById('bottomInboxSlot');

    const habitsList=document.getElementById('habitsList');
    const habitAddBtn=document.getElementById('habitAddBtn');
    const habitResetBtn=document.getElementById('habitResetBtn');
    const habitsSub=document.getElementById('habitsSub');

    // modal
    const overlay=document.getElementById('overlay');
    const modalClose=document.getElementById('modalClose');
    const modalTitle=document.getElementById('modalTitle');
    const modalWhere=document.getElementById('modalWhere');
    const mText=document.getElementById('mText');
    const mTime=document.getElementById('mTime');
    const mType=document.getElementById('mType');
    const mTag=document.getElementById('mTag');

    const quickAddSection=document.getElementById('quickAddSection');
    const tagSettingsSection=document.getElementById('tagSettingsSection');
    const tagSettingsBtn=document.getElementById('tagSettingsBtn');
    const tagManager=document.getElementById('tagManager');
    const modalSave=document.getElementById('modalSave');
    const modalDelete=document.getElementById('modalDelete');

    // layout refs
    const leftCol = document.getElementById('leftCol');
    const sideCol = document.getElementById('sideCol');
    const bottomEl = document.getElementById('bottom');

    function ensureHabitReset(){
      const t=todayKey();
      db.habitState=db.habitState||{date:t,doneIds:[]};
      if(db.habitState.date!==t){
        db.habitState={date:t,doneIds:[]};
        saveDB(db);
      }
    }

    function closeModal(){ overlay.style.display='none'; }
    modalClose.addEventListener('click', closeModal);
    overlay.addEventListener('click', (e)=>{ if(e.target===overlay) closeModal(); });
    overlay.addEventListener('keydown', (e)=>{
      if(overlay.style.display!=='flex' || tagSettingsSection.style.display==='block') return;
      if(e.key==='Enter'){ e.preventDefault(); modalSave.click(); }
    });

    tagSettingsBtn.addEventListener('click', ()=>{
      modalTitle.textContent='Tag AyarlarÄ±';
      quickAddSection.style.display='none';
      tagSettingsSection.style.display='block';
      overlay.style.display='flex';
      renderTagManager();
    });

    function passesFilters(i){
      const q=(search.value||'').trim().toLowerCase();
      if(q && !(i.text||'').toLowerCase().includes(q)) return false;

      const tf=tagFilter.value;
      if(tf && tf!=='__all__' && i.tag!==tf) return false;

      const tpf=typeFilter.value;
      if(tpf==='__preset__'){
        const set = (mode==='month') ? new Set(['termin','hedef']) : new Set(['termin','hedef','gorev']);
        if(!set.has(i.type)) return false;
      } else if(tpf!=='__all__' && i.type!==tpf) return false;

      return true;
    }

    function rebuildTagDropdowns(){
      db.tags.sort((a,b)=>(a.order??9999)-(b.order??9999));

      const fill = (sel)=>{
        sel.innerHTML='';
        const z=document.createElement('option');
        z.value='__none__'; z.textContent='Tag: Yok';
        sel.appendChild(z);
        db.tags.forEach(t=>{
          const o=document.createElement('option');
          o.value=t.name; o.textContent=t.name;
          sel.appendChild(o);
        });
      };
      fill(tagInput);
      fill(mTag);

      // filter
      const cur = tagFilter.value || '__all__';
      tagFilter.innerHTML='';
      const all=document.createElement('option');
      all.value='__all__'; all.textContent='Tag: Hepsi';
      tagFilter.appendChild(all);
      db.tags.forEach(t=>{
        const o=document.createElement('option');
        o.value=t.name; o.textContent='Tag: '+t.name;
        tagFilter.appendChild(o);
      });
      tagFilter.value = (cur==='__all__' || db.tags.some(x=>x.name===cur)) ? cur : '__all__';
    }

    function addItemTo(dest, dayK, item){
      item = fixItem(item);
      if(dest==='inbox'){
        db.inbox = db.inbox || [];
        db.inbox.push(item);
      } else {
        db.days[dayK] = db.days[dayK] || [];
        db.days[dayK].push(item);
      }
      saveDB(db);
    }

    function findItem(origin, itemId){
      if(!origin||!itemId) return null;
      if(origin.from==='inbox') return (db.inbox||[]).find(x=>x.id===itemId) || null;
      if(origin.from==='day') return (db.days[origin.dayKey]||[]).find(x=>x.id===itemId) || null;
      return null;
    }

    function deleteItem(origin, itemId){
      if(origin.from==='inbox'){
        db.inbox = (db.inbox||[]).filter(x=>x.id!==itemId);
      } else if(origin.from==='day'){
        const k=origin.dayKey;
        const arr=db.days[k]||[];
        const kept=arr.filter(x=>x.id!==itemId);
        if(kept.length) db.days[k]=kept; else delete db.days[k];
      }
      saveDB(db);
      render();
    }

    let modalContext={mode:'add',dest:'day',dayKey:null,origin:null,itemId:null};

    function openModalAdd(ctx){
      modalContext={mode:'add',dest:ctx.dest,dayKey:ctx.dayKey,origin:null,itemId:null};
      modalTitle.textContent = (ctx.dest==='inbox') ? 'Inbox' : 'GÃ¼ne Ekle';
      modalWhere.textContent = (ctx.dest==='inbox') ? 'Brain Dump' : `Tarih: ${ctx.dayKey}`;

      quickAddSection.style.display='block';
      tagSettingsSection.style.display='none';
      overlay.style.display='flex';

      rebuildTagDropdowns();
      mText.value='';
      mTime.value='';
      mTag.value='__none__';
      mType.value = (ctx.dest==='inbox') ? 'gorev' : (mode==='month' ? 'termin' : 'gorev');

      modalDelete.style.display='none';
      modalSave.textContent='Ekle';
      setTimeout(()=>mText.focus(),0);
    }

    function openModalEdit(origin, itemId){
      const it=findItem(origin,itemId);
      if(!it) return;
      modalContext={mode:'edit',dest:null,dayKey:null,origin,itemId};

      modalTitle.textContent='DÃ¼zenle';
      modalWhere.textContent = origin.from==='inbox' ? 'Brain Dump' : origin.dayKey;

      quickAddSection.style.display='block';
      tagSettingsSection.style.display='none';
      overlay.style.display='flex';

      rebuildTagDropdowns();
      mText.value = it.text || '';
      mTime.value = it.time || '';
      mType.value = it.type || 'gorev';
      mTag.value = it.tag ? it.tag : '__none__';

      modalDelete.style.display='inline-block';
      modalSave.textContent='Kaydet';
      setTimeout(()=>mText.focus(),0);
    }

    modalSave.addEventListener('click', ()=>{
      const txt=(mText.value||'').trim();
      if(!txt) return;

      if(modalContext.mode==='add'){
        addItemTo(modalContext.dest, modalContext.dayKey, {
          text:txt,
          time:mTime.value||'',
          type:mType.value,
          tag:(mTag.value==='__none__'?'':mTag.value),
          done:false,
          created:Date.now()
        });
        closeModal();
        render();
      } else if(modalContext.mode==='edit'){
        const it=findItem(modalContext.origin, modalContext.itemId);
        if(!it){ closeModal(); return; }
        it.text=txt;
        it.time=mTime.value||'';
        it.type=mType.value;
        it.tag=(mTag.value==='__none__'?'':mTag.value);
        saveDB(db);
        closeModal();
        render();
      }
    });

    modalDelete.addEventListener('click', ()=>{
      if(modalContext.mode==='edit' && confirm('Sil?')){
        deleteItem(modalContext.origin, modalContext.itemId);
        closeModal();
      }
    });

    function renderTagManager(){
      tagManager.innerHTML='';

      const row=document.createElement('div');
      row.className='tagItem';
      row.innerHTML = `
        <input id="nT" type="text" placeholder="Yeni tag (Ã¶rn: kompozit)" />
        <input id="nC" type="color" value="#7dd3fc" />
        <button id="nB" class="btn" type="button">Ekle</button>
      `;
      tagManager.appendChild(row);

      row.querySelector('#nB').addEventListener('click', ()=>{
        const n = normalizeTagName(row.querySelector('#nT').value);
        if(!n) return;
        if(db.tags.some(x=>x.name===n)) return;
        const ord=Math.max(0, ...db.tags.map(x=>x.order||0));
        db.tags.push({name:n, color: row.querySelector('#nC').value || '#7dd3fc', order: ord+1});
        saveDB(db);
        rebuildTagDropdowns();
        render();
        renderTagManager();
      });

      db.tags.sort((a,b)=>(a.order??9999)-(b.order??9999));
      let dragName=null;

      db.tags.forEach(t=>{
        const r=document.createElement('div');
        r.className='tagItem';
        r.draggable=true;
        r.dataset.tag=t.name;
        r.innerHTML = `
          <div class="tagName">
            <span class="dot" style="background:${t.color}"></span>
            <span>${t.name}</span>
          </div>
          <input type="color" value="${t.color}">
          <button class="iconBtn" type="button">ðŸ—‘</button>
        `;

        r.querySelector('input').addEventListener('input', (e)=>{
          t.color = e.target.value;
          saveDB(db);
          render();
        });

        r.querySelector('.iconBtn').addEventListener('click', ()=>{
          if(!confirm(`"${t.name}" silinsin mi?`)) return;
          db.tags = db.tags.filter(x=>x.name!==t.name);
          Object.keys(db.days||{}).forEach(k=>{
            (db.days[k]||[]).forEach(it=>{ if(it.tag===t.name) it.tag=''; });
          });
          (db.inbox||[]).forEach(it=>{ if(it.tag===t.name) it.tag=''; });
          saveDB(db);
          rebuildTagDropdowns();
          render();
          renderTagManager();
        });

        r.addEventListener('dragstart', ()=>{ dragName=t.name; });
        r.addEventListener('dragover', (e)=>{ e.preventDefault(); r.classList.add('dragOver'); });
        r.addEventListener('dragleave', ()=>r.classList.remove('dragOver'));
        r.addEventListener('drop', (e)=>{
          e.preventDefault();
          r.classList.remove('dragOver');
          const target=r.dataset.tag;
          if(!dragName||!target||dragName===target) return;

          const names = db.tags.slice().sort((a,b)=>(a.order??9999)-(b.order??9999)).map(x=>x.name);
          const from = names.indexOf(dragName);
          const to = names.indexOf(target);
          names.splice(from,1);
          names.splice(to,0,dragName);
          names.forEach((nm,i)=>{
            const m=db.tags.find(x=>x.name===nm);
            if(m) m.order=i+1;
          });

          saveDB(db);
          rebuildTagDropdowns();
          render();
          renderTagManager();
        });

        tagManager.appendChild(r);
      });
    }

    function makeCard(item, origin){
      const meta=tagMeta(item.tag);
      const col=meta?.color || null;

      const c=document.createElement('div');
      c.className='card' + (item.done?' done':'');
      c.draggable=true;

      c.style.setProperty('--frameColor', typeFrameColor(item.type));
      c.style.setProperty('--fillColor', col ? hexToRgba(col,0.22) : 'rgba(255,255,255,0.04)');

      const more=document.createElement('button');
      more.className='moreBtn';
      more.type='button';
      more.textContent='â‹¯';
      more.addEventListener('click', (e)=>{
        e.stopPropagation();
        openModalEdit(origin, item.id);
      });

      const row=document.createElement('div');
      row.className='cardRow';

      const cb=document.createElement('button');
      cb.className='checkBtn';
      cb.type='button';
      cb.textContent=item.done?'â†©':'âœ“';
      cb.addEventListener('click', (e)=>{
        e.stopPropagation();
        item.done=!item.done;
        saveDB(db);
        render();
      });

      const body=document.createElement('div');
      body.className='cardBody';

      const title=document.createElement('div');
      title.className='titleText';
      title.textContent=item.text||'';
      body.appendChild(title);

      if(item.time){
        const tm=document.createElement('div');
        tm.className='timeText';
        tm.textContent=item.time;
        body.appendChild(tm);
      }

      row.appendChild(cb);
      row.appendChild(body);
      c.appendChild(more);
      c.appendChild(row);

      c.addEventListener('dragstart', (e)=>{
        dragPayload={...origin, itemId:item.id};
        e.dataTransfer.setData('text/plain', JSON.stringify(dragPayload));
        e.dataTransfer.effectAllowed='move';
      });

      return c;
    }

    function adjustMonthCellHeight(totalCells){
      const rows = Math.max(5, Math.min(6, Math.ceil(totalCells/7)));
      const areaH = calendarArea.clientHeight;
      const dowH = dowRow.getBoundingClientRect().height || 18;
      const gaps = (rows - 1) * 10 + 10;
      const topPadding = 14;
      const cellH = Math.floor((areaH - dowH - gaps - topPadding) / rows);
      const clamped = Math.max(100, Math.min(185, cellH));
      document.documentElement.style.setProperty('--monthCellH', clamped + 'px');
    }

    // âœ… Month: bottom panel saÄŸa taÅŸÄ±nsÄ±n, week: geri alta gelsin
    function applyLayoutForMode(){
      if(mode==='week'){
        document.body.classList.add('weekMode');
        document.body.classList.remove('monthMode');

        // bottom panel sol kolonun altÄ±nda
        if(bottomEl.parentElement !== leftCol) leftCol.appendChild(bottomEl);

        // inbox haftada altta slot'a dock
        if(bottomInboxSlot && inbox.parentElement !== bottomInboxSlot) bottomInboxSlot.appendChild(inbox);

        // inbox seÃ§eneÄŸi aktif
        const opt = whereInput.querySelector('option[value="inbox"]');
        if(opt) opt.disabled=false;

      } else {
        document.body.classList.remove('weekMode');
        document.body.classList.add('monthMode');

        // bottom panel saÄŸ kolona taÅŸÄ±nsÄ±n (side)
        if(bottomEl.parentElement !== sideCol) sideCol.insertBefore(bottomEl, sideCol.firstChild);

        // inbox saÄŸ panelde dursun (bottom slot yerine)
        if(inbox.parentElement !== sideCol) sideCol.insertBefore(inbox, bottomEl.nextSibling);

        // ay gÃ¶rÃ¼nÃ¼mÃ¼nde input "selected" olsun
        whereInput.value='selected';
        const opt = whereInput.querySelector('option[value="inbox"]');
        if(opt) opt.disabled=true;
      }
    }

    function render(){
      ensureHabitReset();

      // normalize
      Object.keys(db.days||{}).forEach(k=>{
        db.days[k] = (db.days[k]||[]).map(fixItem);
      });
      db.inbox = (db.inbox||[]).map(fixItem);

      rebuildTagDropdowns();

      // DOW
      dowRow.innerHTML='';
      dowRow.className='grid ' + (mode==='month'?'month':'week');
      DOW.forEach(d=>{
        const e=document.createElement('div');
        e.className='dow';
        e.textContent=d;
        dowRow.appendChild(e);
      });

      applyLayoutForMode();

      // grid
      grid.className='grid ' + (mode==='month'?'month':'week');
      grid.innerHTML='';

      let cells=[];
      if(mode==='week'){
        const s=startOfWeek(anchor);
        const e=addDays(s,6);
        rangeTitle.textContent=fmtRange(s,e);
        for(let i=0;i<7;i++) cells.push({ date:addDays(s,i), out:false });
      } else {
        const first=startOfMonth(anchor);
        const last=endOfMonth(anchor);
        const s=startOfWeek(first);
        const e=addDays(startOfWeek(last),6);
        rangeTitle.textContent = anchor.toLocaleDateString('tr-TR', {month:'long',year:'numeric'});
        const totalDays = Math.round((e - s) / (24*3600*1000)) + 1;
        for(let i=0;i<totalDays;i++){
          const d=addDays(s,i);
          cells.push({ date:d, out: d.getMonth() !== anchor.getMonth() });
        }
        adjustMonthCellHeight(cells.length);
      }

      const selK = dayKey(selected);

      cells.forEach(c=>{
        const k=dayKey(c.date);
        const items=(db.days[k]||[]).filter(passesFilters).sort(itemSort);
        const openCount = items.filter(x=>!x.done).length;

        const cell=document.createElement('div');
        cell.className = 'cell ' + (mode==='month'?'monthCell':'weekCell') + (c.out?' out':'') + (k===selK?' sel':'');
        cell.dataset.key = k;

        const top=document.createElement('div');
        top.className='dateRow';

        const left=document.createElement('div');
        left.className='dateLeft';

        const dateEl=document.createElement('div');
        dateEl.className='date';
        dateEl.textContent=String(c.date.getDate()).padStart(2,'0');

        const plus=document.createElement('button');
        plus.className='plusBtn';
        plus.type='button';
        plus.textContent='+';
        plus.addEventListener('click', (e)=>{
          e.stopPropagation();
          openModalAdd({dest:'day', dayKey:k});
        });

        left.appendChild(dateEl);
        left.appendChild(plus);

        const count=document.createElement('div');
        count.className='count';
        count.textContent = openCount ? String(openCount) : '';

        top.appendChild(left);
        top.appendChild(count);

        const cards=document.createElement('div');
        cards.className='cards';
        items.forEach(it=>{
          cards.appendChild(makeCard(it, {from:'day', dayKey:k}));
        });

        cell.appendChild(top);
        cell.appendChild(cards);

        cell.addEventListener('click', ()=>{
          selected=c.date;
          if(mode==='month' && c.out){
            anchor=new Date(c.date.getFullYear(), c.date.getMonth(), 1);
          }
          render();
        });

        // drag drop to day
        cell.addEventListener('dragover', (e)=>{
          e.preventDefault();
          cell.classList.add('dragOver');
          e.dataTransfer.dropEffect='move';
        });
        cell.addEventListener('dragleave', ()=>cell.classList.remove('dragOver'));
        cell.addEventListener('drop', (e)=>{
          e.preventDefault();
          cell.classList.remove('dragOver');

          if(!dragPayload?.itemId) return;

          if(dragPayload.from==='inbox'){
            const idx = (db.inbox||[]).findIndex(x=>x.id===dragPayload.itemId);
            if(idx<0) return;
            const [moved] = db.inbox.splice(idx,1);
            db.days[k]=db.days[k]||[];
            db.days[k].push(moved);
          } else if(dragPayload.from==='day'){
            const fromK=dragPayload.dayKey;
            if(!fromK || fromK===k) return;
            const arr=db.days[fromK]||[];
            const idx=arr.findIndex(x=>x.id===dragPayload.itemId);
            if(idx<0) return;
            const [moved]=arr.splice(idx,1);
            if(!arr.length) delete db.days[fromK];
            db.days[k]=db.days[k]||[];
            db.days[k].push(moved);
          }

          saveDB(db);
          dragPayload=null;
          selected=c.date;
          render();
        });

        grid.appendChild(cell);
      });

      // âœ… Inbox render (tek â€œboÅŸâ€)
      inboxList.innerHTML='';
      const inb=(db.inbox||[]).filter(passesFilters).sort(itemSort);
      if(inb.length){
        inboxCount.textContent = `AÃ§Ä±k: ${inb.filter(x=>!x.done).length} / ${inb.length}`;
        inb.forEach(it=>inboxList.appendChild(makeCard(it,{from:'inbox'})));
      } else {
        inboxCount.textContent = '';
        inboxList.innerHTML = '<div class="muted">Inbox boÅŸ. + ile hÄ±zlÄ± ekle.</div>';
      }

      // Habits
      habitsList.innerHTML='';
      const doneSet=new Set(db.habitState?.doneIds||[]);
      habitsSub.textContent = db.habits.length ? `BugÃ¼n: ${doneSet.size}/${db.habits.length}` : 'Her gÃ¼n sÄ±fÄ±rlanÄ±r';

      if(!db.habits.length){
        const empty=document.createElement('div');
        empty.className='muted';
        empty.textContent='AlÄ±ÅŸkanlÄ±k eklemek iÃ§in +';
        habitsList.appendChild(empty);
      } else {
        db.habits.forEach(h=>{
          const r=document.createElement('div');
          r.className='habitRow';
          r.innerHTML = `<label><input type="checkbox"><span>${h.name}</span></label><button class="iconBtn" type="button">ðŸ—‘</button>`;
          const cb=r.querySelector('input');
          cb.checked = doneSet.has(h.id);
          cb.addEventListener('change', ()=>{
            const s=new Set(db.habitState.doneIds||[]);
            cb.checked ? s.add(h.id) : s.delete(h.id);
            db.habitState.doneIds=[...s];
            saveDB(db);
            render();
          });
          r.querySelector('button').addEventListener('click', ()=>{
            if(!confirm('Sil?')) return;
            db.habits = (db.habits||[]).filter(x=>x.id!==h.id);
            const s=new Set(db.habitState.doneIds||[]);
            s.delete(h.id);
            db.habitState.doneIds=[...s];
            saveDB(db);
            render();
          });
          habitsList.appendChild(r);
        });
      }

      // âœ… Panel list (checkbox ile tick)
      const pk=dayKey(selected);
      const pI=(db.days[pk]||[]).filter(passesFilters).sort(itemSort);
      panelTitle.textContent = fmtDay(selected);
      taskList.innerHTML='';

      if(!pI.length){
        taskList.innerHTML='<div class="muted">Kart yok.</div>';
      } else {
        pI.forEach(it=>{
          const row=document.createElement('div');
          row.className='row';

          const left=document.createElement('div');
          left.style.display='flex';
          left.style.alignItems='center';
          left.style.gap='8px';
          left.style.minWidth='0';

          const cb=document.createElement('input');
          cb.type='checkbox';
          cb.checked=!!it.done;
          cb.addEventListener('change', ()=>{
            it.done = cb.checked;
            saveDB(db);
            render();
          });

          const txt=document.createElement('div');
          txt.className='txt';
          txt.style.color = it.done ? 'var(--muted)' : 'var(--text)';
          txt.textContent = it.text + (it.time ? ` â€¢ ${it.time}` : '');

          left.appendChild(cb);
          left.appendChild(txt);
          row.appendChild(left);

          taskList.appendChild(row);
        });
      }
    }

    // ======================
    // EVENTLER
    // ======================
    document.getElementById('prev').addEventListener('click', ()=>{
      anchor = (mode==='week') ? addDays(anchor,-7) : new Date(anchor.getFullYear(), anchor.getMonth()-1, 1);
      render();
    });
    document.getElementById('next').addEventListener('click', ()=>{
      anchor = (mode==='week') ? addDays(anchor,7) : new Date(anchor.getFullYear(), anchor.getMonth()+1, 1);
      render();
    });
    document.getElementById('today').addEventListener('click', ()=>{
      anchor=new Date(); selected=new Date(); render();
    });

    btnWeek.addEventListener('click', ()=>{
      mode='week';
      btnWeek.classList.add('active'); btnMonth.classList.remove('active');
      anchor=new Date(selected);
      typeInput.value='gorev';
      typeFilter.value='__preset__';
      render();
    });

    btnMonth.addEventListener('click', ()=>{
      mode='month';
      btnMonth.classList.add('active'); btnWeek.classList.remove('active');
      anchor=new Date(selected.getFullYear(), selected.getMonth(), 1);
      typeInput.value='termin';
      typeFilter.value='__preset__';
      render();
    });

    tagFilter.addEventListener('change', render);
    typeFilter.addEventListener('change', render);
    search.addEventListener('input', render);

    // Enter = ekle
    taskInput.addEventListener('keydown', (e)=>{
      if(e.key==='Enter'){ e.preventDefault(); addSubmit.click(); }
    });

    addForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      const t=taskInput.value.trim();
      if(!t) return;

      const item = {
        text:t,
        time:timeInput.value||'',
        type:typeInput.value,
        tag:(tagInput.value==='__none__'?'':tagInput.value),
        done:false,
        created:Date.now()
      };

      if(whereInput.value==='inbox'){
        addItemTo('inbox', null, item);
      } else {
        addItemTo('day', dayKey(selected), item);
      }

      taskInput.value='';
      timeInput.value='';
      tagInput.value='__none__';
      render();
      taskInput.focus();
    });

    inboxAdd.addEventListener('click', ()=>openModalAdd({dest:'inbox', dayKey:null}));

    // drag drop day -> inbox
    inbox.addEventListener('dragover', (e)=>{
      e.preventDefault();
      inbox.classList.add('dragOver');
      e.dataTransfer.dropEffect='move';
    });
    inbox.addEventListener('dragleave', ()=>inbox.classList.remove('dragOver'));
    inbox.addEventListener('drop', (e)=>{
      e.preventDefault();
      inbox.classList.remove('dragOver');
      if(dragPayload?.from==='day'){
        const frK=dragPayload.dayKey;
        const arr=db.days[frK]||[];
        const idx=arr.findIndex(x=>x.id===dragPayload.itemId);
        if(idx<0) return;
        const [moved]=arr.splice(idx,1);
        if(!arr.length) delete db.days[frK];
        db.inbox = db.inbox || [];
        db.inbox.push(moved);
        saveDB(db);
        dragPayload=null;
        render();
      }
    });

    clearDone.addEventListener('click', ()=>{
      const k=dayKey(selected);
      const arr=db.days[k]||[];
      const kept=arr.filter(x=>!x.done);
      if(kept.length) db.days[k]=kept; else delete db.days[k];
      saveDB(db);
      render();
    });

    clearInboxDone.addEventListener('click', ()=>{
      db.inbox = (db.inbox||[]).filter(x=>!x.done);
      saveDB(db);
      render();
    });

    habitAddBtn.addEventListener('click', ()=>{
      const n=prompt('AlÄ±ÅŸkanlÄ±k:');
      if(!n) return;
      db.habits = db.habits || [];
      db.habits.push({ id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now())+Math.random(), name: n.trim() });
      saveDB(db);
      render();
    });

    habitResetBtn.addEventListener('click', ()=>{
      db.habitState={ date: todayKey(), doneIds: [] };
      saveDB(db);
      render();
    });

    // Service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').catch(()=>{});
    }

    // Start
    typeFilter.value='__preset__';
    typeInput.value='gorev';

    checkUser(); // auth durumuna gÃ¶re render Ã§aÄŸÄ±rÄ±yor
    window.addEventListener('resize', ()=>{ if(mode==='month') render(); });
  </script>
</body>
</html>
