<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#111111" />
  <title>todoapp</title>

  <!-- Supabase v2 -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<link rel="manifest" href="/manifest.webmanifest">
<link rel="icon" href="/icon-192.png">
<link rel="apple-touch-icon" href="/icon-192.png">
  <style>
    :root{
      --bg:#0f0f10; --card:#17171a; --muted:#a3a3a3; --text:#f5f5f5; --line:#2a2a2f; --accent:#7dd3fc;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --frame-termin:#fb7185; --frame-hedef:#60a5fa; --frame-gorev:#34d399;
      --monthCellH: 64px;
    }
    *{ box-sizing:border-box; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    html, body{ height:100%; }
    body{ margin:0; background:var(--bg); color:var(--text); }
    .wrap{ max-width:1440px; margin:0 auto; padding:16px; }
    .hidden{ display:none !important; }

    /* AUTH */
    .auth-overlay{
      position: fixed; inset: 0; background: var(--bg); z-index: 9999;
      display:flex; align-items:center; justify-content:center;
      padding:16px;
    }
    .auth-box{
      width:min(380px, 100%);
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:18px;
      box-shadow: var(--shadow);
      display:flex; flex-direction:column; gap:10px;
    }
    .auth-box h2{ margin:0 0 6px; font-size:16px; }
    .auth-input{
      background:#101014; color:var(--text);
      border:1px solid var(--line);
      border-radius:12px; padding:10px 12px;
      outline:none;
    }
    .auth-row{ display:flex; gap:8px; }
    .auth-btn{
      flex:1;
      border:1px solid var(--line);
      background:#1f1f24; color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:650;
    }
    .auth-btn.primary{ background:var(--text); color:var(--bg); border-color:transparent; }
    .auth-msg{ min-height:18px; font-size:12px; color:var(--muted); white-space:pre-wrap; }
    .auth-err{ color: #fb7185; }

    /* HEADER / UI */
    header{ display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:12px; flex-wrap:wrap; }
    .left{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    h1{ font-size:16px; margin:0; font-weight:650; letter-spacing:.2px; }

    .btn{ background:var(--card); border:1px solid var(--line); color:var(--text); padding:8px 10px; border-radius:12px; cursor:pointer; }
    .btn:hover{ border-color:#3a3a44; }
    .btn.danger{ color:#fb7185; border-color:rgba(251,113,133,.35); }

    .seg{ display:flex; background:var(--card); border:1px solid var(--line); border-radius:14px; overflow:hidden; }
    .seg button{ border:0; background:transparent; color:var(--muted); padding:8px 12px; cursor:pointer; }
    .seg button.active{ color:var(--text); background:#1f1f24; }

    .bar{ display:flex; gap:10px; align-items:center; justify-content:space-between; margin:10px 0 12px; flex-wrap:wrap; }
    .nav{ display:flex; gap:8px; align-items:center; }
    .title{ font-size:14px; color:var(--muted); }
    .filters{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    select, input[type="text"], input[type="search"], input[type="time"]{
      background:#101014; color:var(--text);
      border:1px solid var(--line); border-radius:12px;
      padding:8px 10px; outline:none; font-size:13px;
    }

    .main{
      display:grid;
      grid-template-columns: 1fr 240px;
      gap:12px;
      align-items:start;
    }

    .calendarArea{
      height: calc(100vh - 210px);
      overflow:auto;
      padding-right:4px;
    }
    body.weekMode .calendarArea{ height: calc(100vh - 320px); }
    body.monthMode .calendarArea{ height: calc(100vh - 140px); }

    .grid{ display:grid; gap:10px; }
    .month{ grid-template-columns: repeat(7, 1fr); }
    .week{ grid-template-columns: repeat(7, 1fr); }
    .dow{ font-size:12px; color:var(--muted); padding:0 6px; }

    .cell{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      gap:8px;
      overflow:hidden;
      min-width:0;
    }
    .cell.weekCell{ min-height:280px; }
    .cell.monthCell{ height: var(--monthCellH); }
    .cell.out{ opacity:.55; }
    .cell.sel{ outline:2px solid rgba(125,211,252,.35); border-color:rgba(125,211,252,.35); }
    .cell.dragOver{ outline:2px dashed rgba(125,211,252,.45); border-color:rgba(125,211,252,.45); }

    .dateRow{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .dateLeft{ display:flex; align-items:center; gap:8px; min-width:0; }
    .date{ font-size:12px; color:var(--muted); }
    .count{ font-size:12px; color:var(--accent); }

    .plusBtn{
      width:26px; height:26px;
      display:grid; place-items:center;
      border-radius:10px;
      border:1px solid var(--line);
      background:transparent;
      color:var(--muted);
      cursor:pointer;
      flex:0 0 auto;
    }
    .plusBtn:hover{ border-color:#3a3a44; color:var(--text); }

    .cards{
      display:flex;
      flex-direction:column;
      gap:6px;
      overflow:auto;
      min-height:0;
      padding-right:2px;
    }

    /* IMPORTANT: Week/day cards overflow fix */
    .weekCell .cards{ max-height: 100%; overflow:auto; }

    .card{
      border:2px solid var(--frameColor, var(--line));
      border-radius:12px;
      padding:6px 8px;
      background: var(--fillColor, rgba(255,255,255,0.04));
      user-select:none;
      min-width:0;
      position:relative;
    }
    .card[draggable="true"]{ cursor:grab; }
    .card.done{ opacity:.55; }

    .cardRow{ display:flex; align-items:flex-start; gap:8px; min-width:0; }
    .checkBtn{
      width:18px; height:18px;
      display:grid; place-items:center;
      border-radius:7px;
      border:1px solid rgba(0,0,0,.25);
      background:rgba(0,0,0,.10);
      color:rgba(255,255,255,.85);
      cursor:pointer;
      flex:0 0 auto;
      font-size:11px;
      line-height:1;
      margin-top:1px;
    }
    .cardBody{
      flex:1 1 auto;
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:3px;
      padding-right:22px;
    }
    .titleText{
      font-size:12.8px;
      line-height:1.2;
      color: var(--text);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .timeText{
      font-size:11px;
      line-height:1.1;
      color: rgba(255,255,255,.75);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    body.monthMode .card{ padding:4px 6px; border-radius:10px; }
    body.monthMode .cards{ gap:4px; }
    body.monthMode .checkBtn{ width:14px; height:14px; border-radius:6px; font-size:9px; margin-top:0; }
    body.monthMode .cardBody{ gap:2px; padding-right:20px; flex-direction: row; align-items: center; }
    body.monthMode .titleText{ font-size:11px; flex: 1 1 auto; }
    body.monthMode .timeText{ font-size:9.5px; opacity:.85; flex: 0 0 auto; }

    .moreBtn{
      position:absolute;
      top:6px; right:6px;
      width:18px; height:18px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,.15);
      background:rgba(0,0,0,.12);
      color:rgba(255,255,255,.85);
      cursor:pointer;
      display:grid; place-items:center;
      font-size:14px;
      line-height:1;
    }

    .side{ position:sticky; top:12px; display:flex; flex-direction:column; gap:12px; }
    .panelBox{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px;
      box-shadow: var(--shadow);
    }
    .panelHead{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .panelHead h2{ margin:0; font-size:14px; }
    .muted{ color:var(--muted); font-size:12px; }

    .inboxList{ display:flex; flex-direction:column; gap:8px; overflow:auto; max-height:40vh; padding-right:2px; }
    .bottom{ margin-top: 0px; background:transparent; border:0; padding:0; }
    body.weekMode .bottom{ margin-top: -64px; }

    .bottomGrid{ display:block; }
    body.weekMode .bottomGrid{
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:10px;
      align-items:start;
    }
    .panelLike{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px;
      box-shadow: var(--shadow);
    }

    form{ display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
    .w{ min-width:160px; }
    .list{ margin-top:10px; display:flex; flex-direction:column; gap:8px; }
    .row{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border:1px solid var(--line);
      background:#121216;
      padding:10px 12px;
      border-radius:14px;
    }
    .rowLeft{ display:flex; align-items:center; gap:10px; min-width:0; }
    .row .txt{ font-size:13px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    /* Modal */
    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding:16px;
      z-index:50;
    }
    .modal{
      width:min(760px, 100%);
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px;
      box-shadow: var(--shadow);
      max-height: 86vh;
      overflow:auto;
    }
    .modalTop{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .modalTop h3{ margin:0; font-size:14px; }
    .modalGrid{ display:grid; grid-template-columns: 1fr 170px 170px 1fr; gap:8px; margin-top:10px; }
    .modalGrid .full{ grid-column: 1 / -1; }
    .modalActions{ display:flex; justify-content:space-between; align-items:center; gap:8px; margin-top:10px; }

    /* Habits */
    .habitsList{ display:flex; flex-direction:column; gap:10px; }
    .habitRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:8px 10px; border:1px solid var(--line); background:#121216; border-radius:14px;
    }
    .habitRow label{ display:flex; align-items:center; gap:10px; min-width:0; }
    .habitRow span{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .habitRow input[type="checkbox"]{ width:18px; height:18px; }
    .iconBtn{
      width:38px; height:34px; display:grid; place-items:center;
      border-radius:12px; border:1px solid var(--line);
      background:transparent; color:var(--muted); cursor:pointer;
    }

    /* Mobile Home */
    #mobileHome{
      max-width: 680px;
      margin: 0 auto;
      padding: 12px;
    }
    .mobileTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px;
    }
    .mobileTitleBox{ display:flex; flex-direction:column; gap:2px; }
    .mobileTitle{ margin:0; font-size:16px; }
    .mobileSub{ font-size:12px; color:var(--muted); }

    @media (max-width: 900px){
      .main{ grid-template-columns: 1fr; }
      .side{ position:static; }
      .calendarArea{ height:auto; max-height:none; }
      body.weekMode .bottomGrid{ grid-template-columns: 1fr; }
      body.weekMode .bottom{ margin-top: 0px; }
    }
    /* =========================
   MONTH MODE CLEANUP
   - AylÄ±k gÃ¶rÃ¼nÃ¼mde Brain Dump + Habits gizle
   - Alt paneli saÄŸa al (saÄŸ panel alanÄ±na)
   - AylÄ±k takvimi sayfaya sÄ±ÄŸdÄ±r (calendarArea scroll olmasÄ±n)
========================= */

/* 1) AylÄ±k gÃ¶rÃ¼nÃ¼mde saÄŸ panelde Brain Dump + Habits'i kaldÄ±r */
body.monthMode #inbox,
body.monthMode #habitsBox{
  display: none !important;
}

/* 2) AylÄ±k gÃ¶rÃ¼nÃ¼mde ana grid 2 kolon kalsÄ±n:
      sol: aylÄ±k takvim
      saÄŸ: "gÃ¶revler listesi / alt panel" (senin bottom panel) */
body.monthMode .main{
  grid-template-columns: 1fr 360px !important;
  align-items: start;
}

/* 3) AylÄ±k gÃ¶rÃ¼nÃ¼mde takvim alanÄ± scroll olmasÄ±n (ekrana sÄ±ÄŸsÄ±n) */
body.monthMode .calendarArea{
  height: auto !important;
  overflow: visible !important;
}

/* 4) AylÄ±k gÃ¶rÃ¼nÃ¼mde bottom paneli saÄŸ kolona taÅŸÄ± ve gÃ¶rÃ¼nÃ¼r yap */
body.monthMode #bottom{
  display: block !important;
}

body.monthMode #bottom .bottomGrid{
  display: block !important; /* tek panel gibi */
}

/* bottom'Ä± saÄŸ kolona "sticky" yap */
body.monthMode #bottom{
  position: sticky;
  top: 12px;
}

/* 5) AylÄ±k gÃ¶rÃ¼nÃ¼mde bottomInboxSlot (dock edilen inbox) zaten yok olsun */
body.monthMode #bottomInboxSlot{
  display: none !important;
}

/* 6) Mobilde (max 900px) aylÄ±k gÃ¶rÃ¼nÃ¼mde yine tek kolon (saÄŸ panel yok) */
@media (max-width: 900px){
  body.monthMode .main{
    grid-template-columns: 1fr !important;
  }
  body.monthMode #bottom{
    position: static !important;
  }
}
    /* === PC Month: Bottom paneli saÄŸa al (task panel + input) === */
@media (min-width: 901px){
  body.monthMode .main{
    grid-template-columns: 1fr 360px;   /* sol: ay takvimi, saÄŸ: panel */
    align-items:start;
  }

  /* saÄŸ kolon gibi davran */
  body.monthMode #bottom{
    margin-top: 0 !important;
    position: sticky;
    top: 12px;
  }

  /* bottom iÃ§indeki grid'i tek kolon yap (sadece sol panel kalsÄ±n) */
  body.monthMode #bottomGrid{
    display:block !important;
  }

  /* ay modunda Brain dump/habit istemiyorsun diye bunlar zaten gizliydi:
     ama bottomInboxSlot gibi boÅŸ yer varsa kapat */
  body.monthMode #bottomInboxSlot{
    display:none !important;
  }

  /* ay modunda calendar alanÄ±nÄ± kaydÄ±rmasÄ±z yapmÄ±ÅŸtÄ±k; bu kalsÄ±n */
  body.monthMode .calendarArea{
    height:auto !important;
    overflow:visible !important;
  }
}
    /* AylÄ±k gÃ¶rÃ¼nÃ¼mde gÃ¶rev panelini saÄŸa al */
body.monthMode .main {
  grid-template-columns: 1fr 360px;
}

/* AylÄ±k gÃ¶rÃ¼nÃ¼mde alt panel artÄ±k altta deÄŸil */
body.monthMode .bottom {
  margin-top: 0;
}

/* AylÄ±k gÃ¶rÃ¼nÃ¼mde bottom iÃ§eriÄŸi gÃ¶rÃ¼nÃ¼r olsun */
body.monthMode #bottomInboxSlot {
  display: block;
}
    /* Ay gÃ¶rÃ¼nÃ¼mÃ¼nde saÄŸda â€œSeÃ§ili gÃ¼nâ€ paneli */
body.monthMode #monthTasksSlot .panelLike{
  height: calc(100vh - 210px);
  overflow: auto;
}

/* Ay gÃ¶rÃ¼nÃ¼mÃ¼nde soldaki alanda bottom gÃ¶rÃ¼nmesin (Ã§Ã¼nkÃ¼ saÄŸa taÅŸÄ±yacaÄŸÄ±z) */
body.monthMode .main > div > #bottom{
  display:none;
}

/* Ay gÃ¶rÃ¼nÃ¼mÃ¼nde saÄŸ slot gÃ¶rÃ¼nÃ¼r */
body.monthMode #monthTasksSlot > #bottom{
  display:block;
}
    /* AY MODU: bottom paneli saÄŸ kolona sabitle (HTML taÅŸÄ±madan) */
body.monthMode #bottom{
  position: fixed;
  top: 128px;                 /* header+bar yÃ¼ksekliÄŸi gibi dÃ¼ÅŸÃ¼n */
  right: 16px;
  width: 360px;
  max-height: calc(100vh - 150px);
  overflow: auto;
  z-index: 20;
}

/* AY MODU: takvimi saÄŸ panel kadar daralt, Ã¼stÃ¼ne binmesin */
body.monthMode .main > div{
  margin-right: 4px;        /* bottom geniÅŸliÄŸi + biraz boÅŸluk */
}
   /* =====================
   MOBILE: tek Ã¼st bar
   ===================== */
.mTop{ display:none; }

@media (max-width: 900px){
  /* Desktop header + filtre barÄ± mobilde kapat (ekranda ikinci kez gÃ¶rÃ¼nmesin) */
  .wrap > header{ display:none !important; }
  .wrap > .bar{ display:none !important; }

  /* Mobil Ã¼st bar aÃ§ */
  .mTop{
    display:block;
    position: sticky;
    top: 0;
    z-index: 9999;
    background: var(--bg);
    padding: 12px 16px 8px;
    border-bottom: 1px solid rgba(255,255,255,.06);
  }
  .mTopRow{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap: 10px;
  }
  .mTitle{ font-size: 18px; font-weight: 750; }
  .mSub{ font-size: 12px; color: var(--muted); margin-top: 2px; }
  .mRight{ display:flex; align-items:center; gap:10px; }

  .mSeg{
    display:flex;
    background: var(--card);
    border: 1px solid var(--line);
    border-radius: 14px;
    overflow:hidden;
  }
  .mSegBtn{
    border:0;
    background: transparent;
    color: var(--muted);
    padding: 8px 12px;
    cursor:pointer;
  }
  .mSegBtn.active{
    background:#1f1f24;
    color: var(--text);
  }

  /* Mobilde iÃ§erik Ã¼st barÄ±n altÄ±na dÃ¼zgÃ¼n otursun */
  .wrap{ padding-top: 8px; }

  /* Mobilde side zaten saklanÄ±yordu; kalsÄ±n */
  .side{ display:none !important; }
}
    /* =========================
   MOBILE: duplicate headers off
   ========================= */
@media (max-width: 900px){

  /* GÃ¼nlÃ¼k paneldeki tarih baÅŸlÄ±ÄŸÄ±nÄ± kapat */
  .bottomTop h2,
  #panelTitle{
    display: none !important;
  }

  /* GÃ¼nlÃ¼k paneldeki "BugÃ¼n iÃ§in kart yok" Ã¼st boÅŸluÄŸunu azalt */
  .panelLike{
    margin-top: 8px;
  }
}
  </style>
</head>

<body>
  <!-- MOBILE TOP BAR -->
<div id="mobileTop" class="mTop">
  <div class="mTopRow">
    <div>
      <div id="mTitle" class="mTitle">BugÃ¼n</div>
      <div class="mSub">SaÄŸa/sola kaydÄ±r: gÃ¼n deÄŸiÅŸtir</div>
    </div>

    <div class="mRight">
      <div class="mSeg">
        <button id="mDayBtn" type="button" class="mSegBtn active">GÃ¼n</button>
        <button id="mMonthBtn" type="button" class="mSegBtn">Ay</button>
      </div>
      <button id="menuBtn" class="btn" type="button">â˜°</button>
    </div>
  </div>
</div>
  <!-- AUTH -->
  <div id="authOverlay" class="auth-overlay">
    <div class="auth-box">
      <h2>Minimal To-Do Sync</h2>
      <div id="authMsg" class="auth-msg"></div>
      <input id="emailInput" class="auth-input" type="email" placeholder="E-posta" />
      <input id="passInput" class="auth-input" type="password" placeholder="Åžifre (min 6)" />
      <div class="auth-row">
        <button id="btnLogin" class="auth-btn primary" type="button">GiriÅŸ</button>
        <button id="btnRegister" class="auth-btn" type="button">KayÄ±t</button>
      </div>
    </div>
  </div>

  <!-- MOBILE HOME -->
  <div id="mobileHome" class="hidden">
    <div class="mobileTop">
      <div class="mobileTitleBox">
        <h2 id="mobileTitle" class="mobileTitle">BugÃ¼n</h2>
        <div id="mobileSub" class="mobileSub"></div>
      </div>
      <div style="display:flex; gap:8px;">
        <button id="mGoDaily" class="btn" type="button">GÃ¼n</button>
        <button id="mGoMonth" class="btn" type="button">Ay</button>
      </div>
    </div>

    <div class="panelBox" style="margin-bottom:12px;">
      <div class="panelHead">
        <div>
          <h2>BugÃ¼n</h2>
          <div class="muted" id="mHabitsSub">Her gÃ¼n sÄ±fÄ±rlanÄ±r</div>
        </div>
        <div style="display:flex; gap:8px;">
          <button id="mHabitAdd" class="plusBtn" type="button">+</button>
          <button id="mHabitReset" class="btn" type="button">Reset</button>
        </div>
      </div>
      <div id="mHabitsList" class="habitsList"></div>
    </div>

    <div class="panelBox">
      <div id="mobileDayCard"></div>
    </div>
  </div>

  <!-- APP -->
  <div class="wrap" id="appWrap" style="filter:blur(5px); pointer-events:none;">
    <header>
      <div class="left">
        <h1>todoapp</h1>
        <div class="seg" role="tablist">
          <button id="btnWeek" class="active" type="button">Hafta</button>
          <button id="btnMonth" type="button">Ay</button>
        </div>
      </div>
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <div class="muted" id="statusText">Offline</div>
        <button id="tagSettingsBtn" class="btn" type="button">Taglar</button>
        <button id="btnLogout" class="btn danger" type="button">Ã‡Ä±kÄ±ÅŸ</button>
      </div>
    </header>

    <div class="bar">
      <div class="nav">
        <button id="prev" class="btn" type="button">â—€</button>
        <button id="today" class="btn" type="button">BugÃ¼n</button>
        <button id="next" class="btn" type="button">â–¶</button>
      </div>
      <div class="filters">
        <div class="title" id="rangeTitle"></div>
        <select id="tagFilter"><option value="__all__">Tag: Hepsi</option></select>
        <select id="typeFilter">
          <option value="__preset__">TÃ¼r: GÃ¶rÃ¼nÃ¼m</option>
          <option value="__all__">TÃ¼r: Hepsi</option>
          <option value="termin">Sadece termin</option>
          <option value="hedef">Sadece hedef</option>
          <option value="gorev">Sadece gÃ¶rev</option>
        </select>
        <input id="search" type="search" placeholder="Araâ€¦" />
      </div>
    </div>

    <div class="main">
      <div>
        <div id="calendarArea" class="calendarArea">
          <div class="grid" id="dowRow"></div>
          <div class="grid week" id="grid"></div>
        </div>

        <section class="bottom" id="bottom">
          <div class="bottomGrid" id="bottomGrid">
            <div class="panelLike">
              <div class="panelHead">
                <div>
                  <h2 id="panelTitle">SeÃ§ili gÃ¼n</h2>
                  <div class="muted">SÄ±ralama: Termin â†’ Hedef â†’ GÃ¶rev â€¢ Saat â€¢ Tag</div>
                </div>
                <button id="clearDone" class="btn" type="button">TamamlananlarÄ± temizle</button>
              </div>

              <form id="addForm" autocomplete="off">
                <input class="w" id="taskInput" type="text" placeholder="BaÅŸlÄ±kâ€¦" maxlength="120" />
                <input class="w" id="timeInput" type="time" title="Saat" />
                <select class="w" id="typeInput" title="TÃ¼r">
                  <option value="termin">Termin</option>
                  <option value="hedef">Hedef</option>
                  <option value="gorev">GÃ¶rev</option>
                </select>
                <select class="w" id="tagInput" title="Tag"></select>
                <select class="w" id="whereInput" title="Hedef">
                  <option value="selected">SeÃ§ili gÃ¼ne</option>
                  <option value="inbox">Inbox</option>
                </select>
                <button id="addSubmit" class="btn" type="submit">Ekle</button>
              </form>

              <div class="list" id="taskList"></div>
            </div>

            <div id="bottomInboxSlot" class="panelLike"></div>
          </div>
        </section>
      </div>

      <aside class="side">
        <div id="monthTasksSlot"></div>
        <div id="inbox" class="panelBox">
          <div class="panelHead">
            <div>
              <h2>Brain Dump</h2>
              <div class="muted">GÃ¼ne atanmamÄ±ÅŸ kartlar</div>
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
              <button id="inboxAdd" class="plusBtn" type="button">+</button>
              <button id="clearInboxDone" class="btn" type="button">Temizle</button>
            </div>
          </div>
          <div class="muted" id="inboxCount"></div>
          <div id="inboxList" class="inboxList"></div>
        </div>

        <div id="habitsBox" class="panelBox">
          <div class="panelHead">
            <div>
              <h2>Habits</h2>
              <div class="muted" id="habitsSub">Her gÃ¼n sÄ±fÄ±rlanÄ±r</div>
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
              <button id="habitAddBtn" class="plusBtn" type="button">+</button>
              <button id="habitResetBtn" class="btn" type="button">Reset</button>
            </div>
          </div>
          <div class="habitsList" id="habitsList"></div>
        </div>
      </aside>
    </div>
  </div>

  <!-- MODAL -->
  <div id="overlay" class="overlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalTop">
        <h3 id="modalTitle">Ekle</h3>
        <button id="modalClose" class="btn" type="button">Kapat</button>
      </div>

      <div class="muted" id="modalWhere"></div>

      <div class="modalGrid" style="margin-top:10px;">
        <input id="mText" class="full" type="text" placeholder="BaÅŸlÄ±kâ€¦" maxlength="120" />
        <input id="mTime" type="time" />
        <select id="mType">
          <option value="termin">Termin</option>
          <option value="hedef">Hedef</option>
          <option value="gorev">GÃ¶rev</option>
        </select>
        <select id="mTag"></select>
        <div class="full muted">Enter = Kaydet/Ekle</div>
      </div>

      <div class="modalActions">
        <button id="modalDelete" class="btn danger" type="button" style="display:none;">Sil</button>
        <div style="display:flex; gap:8px; margin-left:auto;">
          <button id="modalSave" class="btn" type="button">Kaydet</button>
        </div>
      </div>
    </div>
  </div>

  <script>
  // =======================
  // 0) SUPABASE SETTINGS
  // =======================
  const SUPABASE_URL = 'https://czuprhvrnlqpipcytvwx.supabase.co';
  const SUPABASE_KEY = 'sb_publishable_IR67FHQQNsnA9aNMizaqUA_HYGC8cKM';

  // =======================
  // 1) HELPERS (date, sort)
  // =======================
  function dayKey(d){
    const y=d.getFullYear();
    const m=String(d.getMonth()+1).padStart(2,'0');
    const da=String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${da}`;
  }
  function todayKey(){ return dayKey(new Date()); }
  function startOfWeek(date){
    const d=new Date(date.getFullYear(), date.getMonth(), date.getDate());
    const day=(d.getDay()+6)%7;
    d.setDate(d.getDate()-day);
    return d;
  }
  function addDays(date,n){
    const d=new Date(date.getFullYear(), date.getMonth(), date.getDate());
    d.setDate(d.getDate()+n);
    return d;
  }
  function startOfMonth(date){ return new Date(date.getFullYear(), date.getMonth(), 1); }
  function endOfMonth(date){ return new Date(date.getFullYear(), date.getMonth()+1, 0); }
  function fmtRange(a,b){
    return `${a.toLocaleDateString('tr-TR',{day:'2-digit',month:'short'})} â€“ ${b.toLocaleDateString('tr-TR',{day:'2-digit',month:'short',year:'numeric'})}`;
  }
  function fmtDay(d){
    return d.toLocaleDateString('tr-TR',{weekday:'long',day:'2-digit',month:'long',year:'numeric'});
  }
  function defaultTags(){
    return [
      { name:'akademik',  color:'#7dd3fc', order:1 },
      { name:'praktikum', color:'#34d399', order:2 },
      { name:'finans',    color:'#fbbf24', order:3 },
      { name:'ev',        color:'#fb7185', order:4 },
    ];
  }
  function fixItem(t){
    const id = t.id || (crypto.randomUUID ? crypto.randomUUID() : String(Date.now())+Math.random());
    const type = (['gorev','termin','hedef'].includes(t.type) ? t.type : 'gorev');
    return {
      id,
      text: (t.text||'').trim(),
      done: !!t.done,
      type,
      tag: (t.tag||''),
      time: (t.time||''),
      created: t.created || Date.now()
    };
  }
  function getCssVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
  function typeFrameColor(type){
    if (type === 'termin') return getCssVar('--frame-termin');
    if (type === 'hedef') return getCssVar('--frame-hedef');
    return getCssVar('--frame-gorev');
  }
  function hexToRgba(hex, alpha){
    if (!hex) return `rgba(255,255,255,${alpha})`;
    const h = hex.replace('#','').trim();
    const full = h.length === 3 ? h.split('').map(c=>c+c).join('') : h;
    const r = parseInt(full.slice(0,2),16);
    const g = parseInt(full.slice(2,4),16);
    const b = parseInt(full.slice(4,6),16);
    return `rgba(${r},${g},${b},${alpha})`;
  }
  function typeRank(type){ return type==='termin'?0 : type==='hedef'?1 : 2; }
  function tagMeta(name){ return db.tags.find(x=>x.name===name); }
  function tagOrder(name){ const m=tagMeta(name); return m ? (m.order ?? 9999) : 9999; }
  function itemSort(a,b){
    const ra=typeRank(a.type), rb=typeRank(b.type);
    if (ra!==rb) return ra-rb;
    const ta=a.time||'99:99', tb=b.time||'99:99';
    if (ta<tb) return -1; if (ta>tb) return 1;
    const oa=tagOrder(a.tag), ob=tagOrder(b.tag);
    if (oa!==ob) return oa-ob;
    return (a.created||0)-(b.created||0);
  }

  // =======================
  // 2) DB (local + cloud)
  // =======================
  const KEY = 'todoapp_cloud_v1';
  let db = { days:{}, inbox:[], tags: defaultTags(), habits:[], habitState:{ date:'', doneIds:[] } };
  db.habitState.date = todayKey();

  function saveLocal(){ localStorage.setItem(KEY, JSON.stringify(db)); }
  function loadLocal(){
    const raw = localStorage.getItem(KEY);
    if (!raw) return;
    try { db = JSON.parse(raw); } catch {}
  }

  function ensureHabitReset(){
    const t = todayKey();
    db.habitState = db.habitState || { date:t, doneIds:[] };
    if (db.habitState.date !== t){
      db.habitState = { date:t, doneIds:[] };
      saveLocal();
    }
  }

  // =======================
  // 3) SUPABASE INIT
  // =======================
  const authOverlay = document.getElementById('authOverlay');
  const appWrap = document.getElementById('appWrap');
  const statusText = document.getElementById('statusText');
  const authMsg = document.getElementById('authMsg');

  let supabaseClient = null;
  let user = null;
  let syncTimer = null;

  function setAuthUI(loggedIn){
    if (loggedIn){
      authOverlay.classList.add('hidden');
      appWrap.style.filter = 'none';
      appWrap.style.pointerEvents = 'auto';
    } else {
      authOverlay.classList.remove('hidden');
      appWrap.style.filter = 'blur(5px)';
      appWrap.style.pointerEvents = 'none';
    }
  }

  function mustHaveSupabase(){
    if (!window.supabase){
      authMsg.textContent = 'Supabase kÃ¼tÃ¼phanesi yÃ¼klenemedi. AdBlock/Internet kontrol et.';
      authMsg.classList.add('auth-err');
      return false;
    }
    if (!SUPABASE_URL.startsWith('https://') || SUPABASE_URL.includes('PASTE_')){
      authMsg.textContent = 'SUPABASE_URL doldurulmamÄ±ÅŸ.';
      authMsg.classList.add('auth-err');
      return false;
    }
    if (!SUPABASE_KEY || SUPABASE_KEY.includes('PASTE_')){
      authMsg.textContent = 'SUPABASE_KEY doldurulmamÄ±ÅŸ.';
      authMsg.classList.add('auth-err');
      return false;
    }
    return true;
  }

  function initSupabase(){
    if (!mustHaveSupabase()) return;
    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  }

  // =======================
  // 4) UI refs
  // =======================
  const DOW = ['Pzt','Sal','Ã‡ar','Per','Cum','Cts','Paz'];
  let mode = 'week';
  let anchor = new Date();
  let selected = new Date();
  let dragPayload = null;

  const calendarArea = document.getElementById('calendarArea');
  const grid = document.getElementById('grid');
  const dowRow = document.getElementById('dowRow');
  const rangeTitle = document.getElementById('rangeTitle');
  const btnWeek = document.getElementById('btnWeek');
  const btnMonth = document.getElementById('btnMonth');

  const panelTitle = document.getElementById('panelTitle');
  const taskList = document.getElementById('taskList');

  const addForm = document.getElementById('addForm');
  const taskInput = document.getElementById('taskInput');
  const timeInput = document.getElementById('timeInput');
  const typeInput = document.getElementById('typeInput');
  const tagInput = document.getElementById('tagInput');
  const whereInput = document.getElementById('whereInput');
  const addSubmit = document.getElementById('addSubmit');

  const tagFilter = document.getElementById('tagFilter');
  const typeFilter = document.getElementById('typeFilter');
  const search = document.getElementById('search');

  const inbox = document.getElementById('inbox');
  const inboxList = document.getElementById('inboxList');
  const inboxCount = document.getElementById('inboxCount');
  const clearInboxDone = document.getElementById('clearInboxDone');
  const inboxAdd = document.getElementById('inboxAdd');
  const bottomInboxSlot = document.getElementById('bottomInboxSlot');

  const habitsList = document.getElementById('habitsList');
  const habitAddBtn = document.getElementById('habitAddBtn');
  const habitResetBtn = document.getElementById('habitResetBtn');
  const habitsSub = document.getElementById('habitsSub');

  const monthTasksSlot = document.getElementById('monthTasksSlot');
  const bottom = document.getElementById('bottom');

  // Modal
  const overlay = document.getElementById('overlay');
  const modalClose = document.getElementById('modalClose');
  const modalTitle = document.getElementById('modalTitle');
  const modalWhere = document.getElementById('modalWhere');
  const mText = document.getElementById('mText');
  const mTime = document.getElementById('mTime');
  const mType = document.getElementById('mType');
  const mTag = document.getElementById('mTag');
  const modalSave = document.getElementById('modalSave');
  const modalDelete = document.getElementById('modalDelete');

  let modalContext = { mode:'add', dest:'day', dayKey:null, origin:null, itemId:null };

  function closeModal(){ overlay.style.display = 'none'; }
  modalClose.addEventListener('click', closeModal);
  overlay.addEventListener('click', (e)=>{ if (e.target===overlay) closeModal(); });
  overlay.addEventListener('keydown', (e)=>{
    if (overlay.style.display !== 'flex') return;
    if (e.key === 'Enter'){ e.preventDefault(); modalSave.click(); }
  });

  // =======================
  // 5) Filters + tags
  // =======================
  function presetTypesForMode(){ return mode==='month' ? new Set(['termin','hedef']) : new Set(['termin','hedef','gorev']); }
  function passesFilters(item){
    const q = (search.value||'').trim().toLowerCase();
    if (q && !(item.text||'').toLowerCase().includes(q)) return false;
    const tf = tagFilter.value;
    if (tf && tf!=='__all__' && item.tag!==tf) return false;
    const tpf = typeFilter.value;
    if (tpf==='__preset__'){ if (!presetTypesForMode().has(item.type)) return false; }
    else if (tpf!=='__all__' && item.type!==tpf) return false;
    return true;
  }

  function rebuildTagDropdowns(){
    db.tags.sort((a,b)=>(a.order??9999)-(b.order??9999));

    function fill(sel){
      sel.innerHTML='';
      const z=document.createElement('option'); z.value='__none__'; z.textContent='Tag: yok';
      sel.appendChild(z);
      for (const t of db.tags){
        const o=document.createElement('option');
        o.value=t.name; o.textContent=t.name;
        sel.appendChild(o);
      }
    }
    fill(tagInput);
    fill(mTag);

    const cur = tagFilter.value || '__all__';
    tagFilter.innerHTML='';
    const all=document.createElement('option'); all.value='__all__'; all.textContent='Tag: Hepsi';
    tagFilter.appendChild(all);
    for (const t of db.tags){
      const o=document.createElement('option');
      o.value=t.name; o.textContent=`Tag: ${t.name}`;
      tagFilter.appendChild(o);
    }
    tagFilter.value = db.tags.some(x=>x.name===cur) ? cur : '__all__';
  }

  // =======================
  // 6) CRUD
  // =======================
  function addItemTo(dest, dayK, item){
    item = fixItem(item);
    if (dest==='inbox'){
      db.inbox = db.inbox || [];
      db.inbox.push(item);
    } else {
      db.days[dayK] = db.days[dayK] || [];
      db.days[dayK].push(item);
    }
    saveDB(db);
  }
  function findItem(origin, itemId){
    if (!origin || !itemId) return null;
    if (origin.from==='inbox') return (db.inbox||[]).find(x=>x.id===itemId)||null;
    if (origin.from==='day') return (db.days[origin.dayKey]||[]).find(x=>x.id===itemId)||null;
    return null;
  }
  function deleteItem(origin, itemId){
    if (origin.from==='inbox'){
      db.inbox = (db.inbox||[]).filter(x=>x.id!==itemId);
    } else if (origin.from==='day'){
      const k=origin.dayKey;
      const arr=db.days[k]||[];
      const kept=arr.filter(x=>x.id!==itemId);
      if (kept.length) db.days[k]=kept; else delete db.days[k];
    }
    saveDB(db);
    render();
    renderMobileDaily();
  }

  // =======================
  // 7) Modal add/edit
  // =======================
  function openModalAdd(ctx){
    modalContext = { mode:'add', dest:ctx.dest, dayKey:ctx.dayKey, origin:null, itemId:null };
    modalTitle.textContent = (ctx.dest==='inbox') ? 'Inboxâ€™a ekle' : 'GÃ¼ne ekle';
    modalWhere.textContent = (ctx.dest==='inbox') ? 'Hedef: Brain Dump' : `Hedef gÃ¼n: ${ctx.dayKey}`;
    overlay.style.display = 'flex';

    rebuildTagDropdowns();
    mText.value=''; mTime.value='';
    mTag.value='__none__';
    mType.value = (ctx.dest==='inbox') ? 'gorev' : (mode==='month' ? 'termin' : 'gorev');

    modalDelete.style.display='none';
    modalSave.textContent='Ekle';
    setTimeout(()=>mText.focus(),0);
  }
  function openModalEdit(origin, itemId){
    const it = findItem(origin, itemId);
    if (!it) return;
    modalContext = { mode:'edit', dest:null, dayKey:null, origin, itemId };
    modalTitle.textContent='DÃ¼zenle';
    modalWhere.textContent = origin.from==='inbox' ? 'Konum: Brain Dump' : `Konum: ${origin.dayKey}`;
    overlay.style.display='flex';

    rebuildTagDropdowns();
    mText.value = it.text || '';
    mTime.value = it.time || '';
    mType.value = it.type || 'gorev';
    mTag.value = it.tag ? it.tag : '__none__';

    modalDelete.style.display='inline-block';
    modalSave.textContent='Kaydet';
    setTimeout(()=>mText.focus(),0);
  }
  modalSave.addEventListener('click', ()=>{
    const text=(mText.value||'').trim();
    if (!text) return;

    if (modalContext.mode==='add'){
      addItemTo(modalContext.dest, modalContext.dayKey, {
        text, time:mTime.value||'', type:mType.value, tag:(mTag.value==='__none__'?'':mTag.value),
        done:false, created:Date.now()
      });
      closeModal(); render(); renderMobileDaily(); return;
    }

    if (modalContext.mode==='edit'){
      const it = findItem(modalContext.origin, modalContext.itemId);
      if (!it) { closeModal(); return; }
      it.text=text; it.time=mTime.value||''; it.type=mType.value; it.tag=(mTag.value==='__none__'?'':mTag.value);
      saveDB(db);
      closeModal(); render(); renderMobileDaily();
    }
  });
  modalDelete.addEventListener('click', ()=>{
    if (modalContext.mode!=='edit') return;
    if (!confirm('Silinsin mi?')) return;
    deleteItem(modalContext.origin, modalContext.itemId);
    closeModal();
  });

  // =======================
  // 8) Render bits
  // =======================
  function renderDOW(){
    dowRow.innerHTML='';
    dowRow.className='grid ' + (mode==='month'?'month':'week');
    for (const name of DOW){
      const el=document.createElement('div');
      el.className='dow'; el.textContent=name;
      dowRow.appendChild(el);
    }
  }
  function dockInboxForMode(){
    const side=document.querySelector('.side');
    if (mode==='week'){
      document.body.classList.add('weekMode');
      document.body.classList.remove('monthMode');
    // AY gÃ¶rÃ¼nÃ¼mÃ¼nde: seÃ§ili gÃ¼n panelini saÄŸa taÅŸÄ±
    if (mode === 'month') {
  if (monthTasksSlot && bottom && bottom.parentElement !== monthTasksSlot) {
    monthTasksSlot.appendChild(bottom);
  }
} else {
  // HAFTA gÃ¶rÃ¼nÃ¼mÃ¼nde: tekrar takvimin altÄ±na geri koy
  const leftCol = document.querySelector('.main > div'); // takvim+bottomâ€™un olduÄŸu sol kolon
  if (leftCol && bottom && bottom.parentElement !== leftCol) {
    leftCol.appendChild(bottom);
  }
}
      if (bottomInboxSlot && inbox.parentElement !== bottomInboxSlot) bottomInboxSlot.appendChild(inbox);
    } else {
      document.body.classList.remove('weekMode');
      document.body.classList.add('monthMode');
      if (side && inbox.parentElement !== side) side.insertBefore(inbox, side.firstChild);
    }
  }
  function adjustMonthCellHeight(totalCells){
    const rows = Math.max(5, Math.min(6, Math.ceil(totalCells/7)));
    const areaH = calendarArea.clientHeight || 600;
    const dowH = dowRow.getBoundingClientRect().height || 18;
    const gaps = (rows-1)*10 + 10;
    const cellH = Math.floor((areaH - dowH - gaps - 14) / rows);
    const clamped = Math.max(115, Math.min(185, cellH));
    document.documentElement.style.setProperty('--monthCellH', clamped+'px');
  }

  function makeCard(item, origin){
    const meta = tagMeta(item.tag);
    const tagColor = meta?.color || null;

    const card=document.createElement('div');
    card.className='card' + (item.done?' done':'');
    card.draggable=true;

    card.style.setProperty('--frameColor', typeFrameColor(item.type));
    card.style.setProperty('--fillColor', tagColor ? hexToRgba(tagColor, 0.22) : 'rgba(255,255,255,0.04)');

    const more=document.createElement('button');
    more.className='moreBtn';
    more.type='button';
    more.textContent='â‹¯';
    more.addEventListener('click',(e)=>{ e.stopPropagation(); openModalEdit(origin, item.id); });

    const row=document.createElement('div');
    row.className='cardRow';

    const check=document.createElement('button');
    check.className='checkBtn';
    check.type='button';
    check.textContent = item.done ? 'â†©' : 'âœ“';
    check.addEventListener('click',(e)=>{
      e.stopPropagation();
      item.done = !item.done;
      saveDB(db);
      render(); renderMobileDaily();
    });

    const body=document.createElement('div');
    body.className='cardBody';

    const title=document.createElement('div');
    title.className='titleText';
    title.textContent = item.text || '(baÅŸlÄ±ksÄ±z)';
    body.appendChild(title);

    if (item.time){
      const time=document.createElement('div');
      time.className='timeText';
      time.textContent=item.time;
      body.appendChild(time);
    }

    row.appendChild(check);
    row.appendChild(body);

    card.appendChild(more);
    card.appendChild(row);

    card.addEventListener('dragstart',(e)=>{
      dragPayload = { ...origin, itemId:item.id };
      e.dataTransfer.setData('text/plain', JSON.stringify(dragPayload));
      e.dataTransfer.effectAllowed='move';
    });

    return card;
  }

  function renderInbox(){
    inboxList.innerHTML='';
    const items=(db.inbox||[]).map(fixItem).filter(passesFilters).sort(itemSort);
    const openCount=items.filter(x=>!x.done).length;
    inboxCount.textContent = items.length ? `AÃ§Ä±k: ${openCount} â€¢ Toplam: ${items.length}` : 'BoÅŸ';

    if (!items.length){
      const empty=document.createElement('div');
      empty.className='muted';
      empty.textContent='Inbox boÅŸ. + ile hÄ±zlÄ± ekle.';
      inboxList.appendChild(empty);
      return;
    }
    for (const it of items) inboxList.appendChild(makeCard(it,{from:'inbox'}));
  }

  function renderHabits(){
    ensureHabitReset();
    habitsList.innerHTML='';
    const done = new Set(db.habitState?.doneIds || []);
    const total = (db.habits||[]).length;
    habitsSub.textContent = total ? `BugÃ¼n: ${done.size}/${total}` : 'Her gÃ¼n sÄ±fÄ±rlanÄ±r';

    if (!total){
      const empty=document.createElement('div');
      empty.className='muted';
      empty.textContent='AlÄ±ÅŸkanlÄ±k eklemek iÃ§in +';
      habitsList.appendChild(empty);
      return;
    }

    for (const h of db.habits){
      const row=document.createElement('div');
      row.className='habitRow';
      const lab=document.createElement('label');
      const cb=document.createElement('input');
      cb.type='checkbox';
      cb.checked = done.has(h.id);
      cb.addEventListener('change', ()=>{
        ensureHabitReset();
        const s=new Set(db.habitState.doneIds||[]);
        cb.checked ? s.add(h.id) : s.delete(h.id);
        db.habitState.doneIds=[...s];
        saveDB(db);
        renderHabits();
        renderMobileDaily();
      });
      const name=document.createElement('span');
      name.textContent=h.name;
      lab.appendChild(cb); lab.appendChild(name);

      const del=document.createElement('button');
      del.className='iconBtn';
      del.type='button';
      del.textContent='ðŸ—‘';
      del.addEventListener('click', ()=>{
        if (!confirm(`"${h.name}" silinsin mi?`)) return;
        db.habits=(db.habits||[]).filter(x=>x.id!==h.id);
        db.habitState.doneIds=(db.habitState.doneIds||[]).filter(id=>id!==h.id);
        saveDB(db);
        renderHabits();
        renderMobileDaily();
      });

      row.appendChild(lab);
      row.appendChild(del);
      habitsList.appendChild(row);
    }
  }

  function renderPanel(){
    const k=dayKey(selected);
    panelTitle.textContent=fmtDay(selected);
    const items=(db.days[k]||[]).map(fixItem).filter(passesFilters).sort(itemSort);

    taskList.innerHTML='';
    if (!items.length){
      const empty=document.createElement('div');
      empty.className='muted';
      empty.style.padding='10px 2px';
      empty.textContent='Bu gÃ¼n iÃ§in (filtreye gÃ¶re) kart yok.';
      taskList.appendChild(empty);
      return;
    }

    for (const it of items){
      const row=document.createElement('div');
      row.className='row';

      const left=document.createElement('div');
      left.className='rowLeft';

      const cb=document.createElement('input');
      cb.type='checkbox';
      cb.checked=!!it.done;
      cb.addEventListener('change', ()=>{
        it.done = cb.checked;
        saveDB(db);
        render(); renderMobileDaily();
      });

      const txt=document.createElement('div');
      txt.className='txt';
      txt.textContent = it.text + (it.time ? ` â€¢ ${it.time}` : '');
      txt.style.color = it.done ? 'var(--muted)' : 'var(--text)';

      left.appendChild(cb);
      left.appendChild(txt);

      row.appendChild(left);
      taskList.appendChild(row);
    }
  }

  function render(){
    // normalize
    for (const k of Object.keys(db.days||{})) db.days[k] = (db.days[k]||[]).map(fixItem);
    db.inbox = (db.inbox||[]).map(fixItem);

    rebuildTagDropdowns();
    renderDOW();
    dockInboxForMode();

    grid.className = 'grid ' + (mode==='month'?'month':'week');
    grid.innerHTML='';

    let cells=[];
    if (mode==='week'){
      const start=startOfWeek(anchor);
      const end=addDays(start,6);
      rangeTitle.textContent=fmtRange(start,end);
      for (let i=0;i<7;i++) cells.push({date:addDays(start,i), out:false});
    } else {
      const first=startOfMonth(anchor);
      const last=endOfMonth(anchor);
      const start=startOfWeek(first);
      const end=addDays(startOfWeek(last),6);
      rangeTitle.textContent=anchor.toLocaleDateString('tr-TR',{month:'long',year:'numeric'});
      const totalDays = Math.round((end-start)/(24*3600*1000))+1;
      for (let i=0;i<totalDays;i++){
        const d=addDays(start,i);
        cells.push({date:d, out:d.getMonth()!==anchor.getMonth()});
      }
      adjustMonthCellHeight(cells.length);
    }

    const selKey=dayKey(selected);

    for (const c of cells){
      const k=dayKey(c.date);
      const items=(db.days[k]||[]).filter(passesFilters).sort(itemSort);
      const openCount=items.filter(x=>!x.done).length;

      const cell=document.createElement('div');
      cell.className='cell ' + (mode==='month'?'monthCell':'weekCell') + (c.out?' out':'') + (k===selKey?' sel':'');
      cell.dataset.key=k;

      const top=document.createElement('div');
      top.className='dateRow';

      const left=document.createElement('div');
      left.className='dateLeft';

      const dateEl=document.createElement('div');
      dateEl.className='date';
      dateEl.textContent=String(c.date.getDate()).padStart(2,'0');

      const plus=document.createElement('button');
      plus.className='plusBtn';
      plus.type='button';
      plus.textContent='+';
      plus.addEventListener('click',(e)=>{ e.stopPropagation(); openModalAdd({dest:'day', dayKey:k}); });

      left.appendChild(dateEl);
      left.appendChild(plus);

      const count=document.createElement('div');
      count.className='count';
      count.textContent = openCount ? `${openCount}` : '';

      top.appendChild(left);
      top.appendChild(count);

      const cards=document.createElement('div');
      cards.className='cards';
      for (const it of items) cards.appendChild(makeCard(it,{from:'day',dayKey:k}));

      cell.appendChild(top);
      cell.appendChild(cards);

      cell.addEventListener('click', ()=>{
        selected=c.date;
        if (mode==='month' && c.out) anchor=new Date(c.date.getFullYear(), c.date.getMonth(), 1);
        render();
        renderMobileDaily();
      });

      // drag/drop
      cell.addEventListener('dragover',(e)=>{ e.preventDefault(); cell.classList.add('dragOver'); e.dataTransfer.dropEffect='move'; });
      cell.addEventListener('dragleave',()=>cell.classList.remove('dragOver'));
      cell.addEventListener('drop',(e)=>{
        e.preventDefault();
        cell.classList.remove('dragOver');

        let payload = dragPayload;
        try{
          const txt=e.dataTransfer.getData('text/plain');
          if (txt) payload=JSON.parse(txt);
        }catch{}
        if (!payload?.itemId) return;

        const toKey=k;

        if (payload.from==='inbox'){
          const idx=(db.inbox||[]).findIndex(x=>x.id===payload.itemId);
          if (idx<0) return;
          const [moved]=db.inbox.splice(idx,1);
          db.days[toKey]=db.days[toKey]||[];
          db.days[toKey].push(moved);
        } else if (payload.from==='day'){
          const fromKey=payload.dayKey;
          if (!fromKey || fromKey===toKey) return;
          const fromArr=db.days[fromKey]||[];
          const idx=fromArr.findIndex(x=>x.id===payload.itemId);
          if (idx<0) return;
          const [moved]=fromArr.splice(idx,1);
          if (!fromArr.length) delete db.days[fromKey];
          db.days[toKey]=db.days[toKey]||[];
          db.days[toKey].push(moved);
        }

        saveDB(db);
        dragPayload=null;
        selected=c.date;
        render();
        renderMobileDaily();
      });

      grid.appendChild(cell);
    }

    renderInbox();
    renderHabits();
    renderPanel();
  }

  // =======================
  // 9) MOBILE DAILY (simple)
  // =======================
  function isMobile(){ return window.matchMedia('(max-width: 900px)').matches; }
  function showDesktopUI(){
    document.getElementById('mobileHome')?.classList.add('hidden');
    const main=document.querySelector('.main');
    const bar=document.querySelector('.bar');
    if (main) main.style.display='grid';
    if (bar) bar.style.display='flex';
  }
  function showMobileUI(){
    const main=document.querySelector('.main');
    const bar=document.querySelector('.bar');
    if (main) main.style.display='none';
    if (bar) bar.style.display='none';
    document.getElementById('mobileHome')?.classList.remove('hidden');
  }

  function renderMobileDaily(){
    if (!isMobile()) { showDesktopUI(); return; }

    const mh=document.getElementById('mobileHome');
    const mt=document.getElementById('mobileTitle');
    const ms=document.getElementById('mobileSub');
    const mcard=document.getElementById('mobileDayCard');
    const mHabitsSub=document.getElementById('mHabitsSub');
    const mHabitsList=document.getElementById('mHabitsList');

    if (!mh || !mt || !mcard) return;

    showMobileUI();
    mt.textContent = fmtDay(selected);
    if (ms) ms.textContent = 'SaÄŸa/sola kaydÄ±r: gÃ¼n deÄŸiÅŸtir';

    // habits
    ensureHabitReset();
    const done=new Set(db.habitState?.doneIds||[]);
    const total=(db.habits||[]).length;
    if (mHabitsSub) mHabitsSub.textContent = total ? `BugÃ¼n: ${done.size}/${total}` : 'Her gÃ¼n sÄ±fÄ±rlanÄ±r';

    if (mHabitsList){
      mHabitsList.innerHTML='';
      if (!total){
        const empty=document.createElement('div');
        empty.className='muted';
        empty.textContent='AlÄ±ÅŸkanlÄ±k eklemek iÃ§in +';
        mHabitsList.appendChild(empty);
      } else {
        for (const h of db.habits){
          const row=document.createElement('div');
          row.className='habitRow';
          row.innerHTML = `
            <label><input type="checkbox" ${done.has(h.id)?'checked':''}><span>${h.name}</span></label>
            <button class="iconBtn" type="button">ðŸ—‘</button>
          `;
          row.querySelector('input').addEventListener('change',(e)=>{
            const s=new Set(db.habitState.doneIds||[]);
            e.target.checked ? s.add(h.id) : s.delete(h.id);
            db.habitState.doneIds=[...s];
            saveDB(db);
            renderMobileDaily();
          });
          row.querySelector('button').addEventListener('click',()=>{
            if (!confirm(`"${h.name}" silinsin mi?`)) return;
            db.habits=(db.habits||[]).filter(x=>x.id!==h.id);
            db.habitState.doneIds=(db.habitState.doneIds||[]).filter(id=>id!==h.id);
            saveDB(db);
            renderMobileDaily();
          });
          mHabitsList.appendChild(row);
        }
      }
    }

    // day cards
    const k=dayKey(selected);
    const items=(db.days[k]||[]).map(fixItem).filter(passesFilters).sort(itemSort);
    const openCount=items.filter(x=>!x.done).length;

    mcard.innerHTML = `
      <div class="dateRow" style="margin-bottom:8px;">
        <div class="dateLeft">
          <div class="date">${k}</div>
          <button id="mPlus" class="plusBtn" type="button">+</button>
        </div>
        <div class="count">${openCount ? openCount : ''}</div>
      </div>
      <div class="cards" id="mCards"></div>
    `;

    const mPlus=document.getElementById('mPlus');
    const mCards=document.getElementById('mCards');

    mPlus?.addEventListener('click', ()=>openModalAdd({dest:'day', dayKey:k}));

    if (!items.length){
      mCards.innerHTML = '<div class="muted">BugÃ¼n iÃ§in kart yok.</div>';
    } else {
      for (const it of items) mCards.appendChild(makeCard(it,{from:'day', dayKey:k}));
    }
  }

  // mobile buttons
  document.getElementById('mGoDaily')?.addEventListener('click', ()=>{
    mode='week';
    anchor=new Date(selected);
    render();
    renderMobileDaily();
  });
  document.getElementById('mGoMonth')?.addEventListener('click', ()=>{
    showDesktopUI();
    mode='month';
    anchor=new Date(selected.getFullYear(), selected.getMonth(), 1);
    render();
  });
  document.getElementById('mHabitAdd')?.addEventListener('click', ()=>{
    const name=prompt('Yeni alÄ±ÅŸkanlÄ±k:');
    if (!name) return;
    db.habits=db.habits||[];
    db.habits.push({ id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now())+Math.random(), name:name.trim() });
    saveDB(db);
    renderMobileDaily();
  });
  document.getElementById('mHabitReset')?.addEventListener('click', ()=>{
    db.habitState={ date:todayKey(), doneIds:[] };
    saveDB(db);
    renderMobileDaily();
  });

  // swipe on mobile home
  (function(){
    const area=document.getElementById('mobileDayCard');
    if (!area) return;
    let x0=null;
    area.addEventListener('touchstart',(e)=>{ x0=e.touches?.[0]?.clientX ?? null; }, {passive:true});
    area.addEventListener('touchend',(e)=>{
      const x1=e.changedTouches?.[0]?.clientX ?? null;
      if (x0==null || x1==null) return;
      const dx=x1-x0;
      if (Math.abs(dx)<50) return;
      selected = (dx>0) ? addDays(selected,-1) : addDays(selected,+1);
      anchor = new Date(selected);
      render();
      renderMobileDaily();
    }, {passive:true});
  })();

  // =======================
  // 10) SAVE (local + cloud)
  // =======================
  function saveDB(newDb){
    db = newDb;
    saveLocal();
    saveRemoteDebounced();
  }

  function saveRemoteDebounced(){
    if (!user || !supabaseClient) return;
    clearTimeout(syncTimer);
    syncTimer = setTimeout(saveRemote, 800);
  }

  async function saveRemote(){
    if (!user || !supabaseClient) return;
    const payload = { id: user.id, content: db, updated_at: new Date().toISOString() };
    const { error } = await supabaseClient.from('user_data').upsert(payload);
    if (error) console.error('Sync error:', error);
  }

  async function loadRemoteData(){
    if (!user || !supabaseClient) return;

    // local first (fast)
    loadLocal();
    render();
    renderMobileDaily();

    const { data, error } = await supabaseClient
      .from('user_data')
      .select('content')
      .eq('id', user.id)
      .single();

    if (error){
      // first time => create row
      console.warn('Remote load:', error);
      await saveRemote();
      return;
    }
    if (data?.content){
      db = data.content;
      saveLocal();
      render();
      renderMobileDaily();
    }
  }

  // =======================
  // 11) AUTH FLOW
  // =======================
  function setMsg(text, isErr=false){
    authMsg.textContent = text || '';
    authMsg.classList.toggle('auth-err', !!isErr);
  }

  async function checkUser(){
    if (!supabaseClient) return;
    const { data, error } = await supabaseClient.auth.getSession();
    if (error) console.error('Session error:', error);
    user = data.session?.user || null;

    if (user){
      setAuthUI(true);
      statusText.textContent = user.email;
      await loadRemoteData();
    } else {
      setAuthUI(false);
      statusText.textContent = 'Offline';
    }
  }

  document.getElementById('btnLogin').addEventListener('click', async ()=>{
    if (!supabaseClient) { setMsg('Supabase hazÄ±r deÄŸil.', true); return; }
    const email = document.getElementById('emailInput').value.trim();
    const password = document.getElementById('passInput').value;
    if (!email || !password) { setMsg('Email + ÅŸifre gir.', true); return; }
    setMsg('GiriÅŸ yapÄ±lÄ±yor...');
    const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
    if (error) { setMsg(error.message, true); return; }
    setMsg('');
    await checkUser();
  });

  document.getElementById('btnRegister').addEventListener('click', async ()=>{
    if (!supabaseClient) { setMsg('Supabase hazÄ±r deÄŸil.', true); return; }
    const email = document.getElementById('emailInput').value.trim();
    const password = document.getElementById('passInput').value;
    if (!email || !password) { setMsg('Email + ÅŸifre gir.', true); return; }
    if (password.length < 6) { setMsg('Åžifre en az 6 karakter.', true); return; }
    setMsg('KayÄ±t olunuyor...');
    const { error } = await supabaseClient.auth.signUp({ email, password });
    if (error) { setMsg(error.message, true); return; }
    setMsg('KayÄ±t tamam. EÄŸer â€œConfirm Emailâ€ aÃ§Ä±ksa mailini onayla.');
  });

  document.getElementById('btnLogout').addEventListener('click', async ()=>{
    if (!supabaseClient) return;
    await supabaseClient.auth.signOut();
    user=null;
    setAuthUI(false);
    statusText.textContent='Offline';
  });

  // =======================
  // 12) UI controls
  // =======================
  document.getElementById('prev').addEventListener('click', ()=>{
    anchor = (mode==='week') ? addDays(anchor,-7) : new Date(anchor.getFullYear(), anchor.getMonth()-1, 1);
    render(); renderMobileDaily();
  });
  document.getElementById('next').addEventListener('click', ()=>{
    anchor = (mode==='week') ? addDays(anchor,7) : new Date(anchor.getFullYear(), anchor.getMonth()+1, 1);
    render(); renderMobileDaily();
  });
  document.getElementById('today').addEventListener('click', ()=>{
    anchor=new Date(); selected=new Date();
    render(); renderMobileDaily();
  });

  btnWeek.addEventListener('click', ()=>{
    mode='week';
    btnWeek.classList.add('active'); btnMonth.classList.remove('active');
    anchor=new Date(selected);
    typeInput.value='gorev';
    render(); renderMobileDaily();
  });
  btnMonth.addEventListener('click', ()=>{
    mode='month';
    btnMonth.classList.add('active'); btnWeek.classList.remove('active');
    anchor=new Date(selected.getFullYear(), selected.getMonth(), 1);
    typeInput.value='termin';
    render(); renderMobileDaily();
  });

  tagFilter.addEventListener('change', ()=>{ render(); renderMobileDaily(); });
  typeFilter.addEventListener('change', ()=>{ render(); renderMobileDaily(); });
  search.addEventListener('input', ()=>{ render(); renderMobileDaily(); });

  taskInput.addEventListener('keydown', (e)=>{
    if (e.key==='Enter'){ e.preventDefault(); addSubmit.click(); }
  });

  addForm.addEventListener('submit', (e)=>{
    e.preventDefault();
    const text=(taskInput.value||'').trim();
    if (!text) return;
    const item={ text, time:timeInput.value||'', type:typeInput.value, tag:(tagInput.value==='__none__'?'':tagInput.value), done:false, created:Date.now() };
    if (whereInput.value==='inbox') addItemTo('inbox', null, item);
    else addItemTo('day', dayKey(selected), item);

    taskInput.value=''; timeInput.value=''; tagInput.value='__none__';
    render(); renderMobileDaily();
    taskInput.focus();
  });

  document.getElementById('clearDone').addEventListener('click', ()=>{
    const k=dayKey(selected);
    const items=db.days[k]||[];
    const kept=items.filter(t=>!t.done);
    if (kept.length) db.days[k]=kept; else delete db.days[k];
    saveDB(db); render(); renderMobileDaily();
  });

  clearInboxDone.addEventListener('click', ()=>{
    db.inbox=(db.inbox||[]).filter(t=>!t.done);
    saveDB(db); render(); renderMobileDaily();
  });

  inboxAdd.addEventListener('click', ()=>openModalAdd({dest:'inbox', dayKey:null}));

  // drag inbox drop (day -> inbox)
  inbox.addEventListener('dragover',(e)=>{ e.preventDefault(); e.dataTransfer.dropEffect='move'; });
  inbox.addEventListener('drop',(e)=>{
    e.preventDefault();
    let payload=dragPayload;
    try{
      const txt=e.dataTransfer.getData('text/plain');
      if (txt) payload=JSON.parse(txt);
    }catch{}
    if (!payload?.itemId) return;

    if (payload.from==='day'){
      const fromKey=payload.dayKey;
      const fromArr=db.days[fromKey]||[];
      const idx=fromArr.findIndex(x=>x.id===payload.itemId);
      if (idx<0) return;
      const [moved]=fromArr.splice(idx,1);
      if (!fromArr.length) delete db.days[fromKey];
      db.inbox=db.inbox||[];
      db.inbox.push(moved);
      saveDB(db); render(); renderMobileDaily();
    }
  });

  habitAddBtn.addEventListener('click', ()=>{
    const name=prompt('Yeni alÄ±ÅŸkanlÄ±k:');
    if (!name) return;
    db.habits=db.habits||[];
    db.habits.push({ id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now())+Math.random(), name:name.trim() });
    saveDB(db);
    renderHabits(); renderMobileDaily();
  });
  habitResetBtn.addEventListener('click', ()=>{
    db.habitState={ date:todayKey(), doneIds:[] };
    saveDB(db);
    renderHabits(); renderMobileDaily();
  });

  // =======================
  // 13) Start
  // =======================
  typeFilter.value='__preset__';
  typeInput.value='gorev';

  initSupabase();
  setMsg('');
  setAuthUI(false);
  rebuildTagDropdowns();
  render();
  renderMobileDaily();
  checkUser();

  window.addEventListener('resize', ()=>{
    renderMobileDaily();
    if (mode==='month') render();
  });

  // PWA SW (optional)
  if ('serviceWorker' in navigator){
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  }
    function setMobileTitle(){
  const el = document.getElementById('mTitle');
  if (!el) return;
  // fmtDay fonksiyonun varsa onu kullan
  try {
    el.textContent = (typeof fmtDay === 'function') ? fmtDay(selected) : selected.toDateString();
  } catch {
    el.textContent = selected.toDateString();
  }
}

const mDayBtn = document.getElementById('mDayBtn');
const mMonthBtn = document.getElementById('mMonthBtn');

function setActiveMobileTab(which){
  if (!mDayBtn || !mMonthBtn) return;
  mDayBtn.classList.toggle('active', which === 'day');
  mMonthBtn.classList.toggle('active', which === 'month');
}

mDayBtn?.addEventListener('click', ()=>{
  mode = 'day';                 // sende day mode varsa
  anchor = new Date(selected);
  setActiveMobileTab('day');
  render();
  setMobileTitle();
});

mMonthBtn?.addEventListener('click', ()=>{
  mode = 'month';
  anchor = new Date(selected.getFullYear(), selected.getMonth(), 1);
  setActiveMobileTab('month');
  render();
  setMobileTitle();
});

/* Render sonrasÄ± baÅŸlÄ±k gÃ¼ncellensin */
const _oldRender = render;
render = function(){
  _oldRender();
  setMobileTitle();
  // mobilde modeâ€™a gÃ¶re aktif tab
  if (window.matchMedia && window.matchMedia("(max-width: 900px)").matches){
    setActiveMobileTab(mode === 'month' ? 'month' : 'day');
  }
};
  </script>
</body>
</html>