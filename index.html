<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Not Defterim Pro</title>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --bg: #0f0f10;
            --card-bg: #18181b;
            --input-bg: #27272a;
            --line: #3f3f46;
            --text-main: #e4e4e7;
            --text-muted: #a1a1aa;
            --green: #10b981;
            --red: #ef4444;
            --blue: #3b82f6;
            --orange: #f59e0b;
            --purple: #8b5cf6;
        }

        * { box-sizing: border-box; outline: none; }
        
        body {
            margin: 0; padding: 20px;
            background-color: var(--bg);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden; /* PC'de sayfa kaymasın */
        }

        /* MOBİL UYUMLULUK (Responsive) */
        @media (max-width: 768px) {
            body { padding: 10px; height: auto; overflow: auto; } /* Mobilde kaydırmaya izin ver */
            header { flex-direction: column; height: auto !important; gap: 10px; align-items: flex-start !important; }
            .week-grid { grid-template-columns: 1fr !important; } /* Mobilde günler alt alta */
            .dashboard { flex-direction: column; height: auto !important; position: static !important; }
            #calendarContainer { height: auto !important; overflow: visible !important; }
            .day-col { min-height: 150px; max-height: none !important; }
        }

        /* --- GİRİŞ EKRANI --- */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--bg); z-index: 10000;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        .login-box {
            background: var(--card-bg); padding: 30px; border-radius: 20px;
            border: 1px solid var(--line); text-align: center; width: 90%; max-width: 350px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .login-input { width: 100%; padding: 12px; margin-bottom: 12px; background: var(--input-bg); border: 1px solid var(--line); color: white; border-radius: 8px; }
        .btn-auth { width: 100%; padding: 12px; background: var(--text-main); color: var(--bg); border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-bottom: 10px; }
        #authError { color: var(--red); font-size: 13px; display: none; margin-top: 10px; }

        /* --- HEADER --- */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; height: 50px; flex-shrink: 0; }
        .nav-btn { background: var(--card-bg); border: 1px solid var(--line); color: var(--text-muted); padding: 6px 12px; border-radius: 6px; cursor: pointer; }
        .nav-btn.active { background: var(--input-bg); color: var(--text-main); border-color: var(--text-main); }
        .icon-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 5px; }

        /* --- TAKVİM --- */
        #calendarContainer { flex: 1; overflow-y: auto; margin-bottom: 20px; padding-right: 5px; }
        
        .week-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 15px; }
        .month-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }

        .day-col {
            background: var(--card-bg); border-radius: 12px; padding: 12px;
            border: 1px solid var(--line); display: flex; flex-direction: column; gap: 10px;
            min-height: 200px; /* Kutular artık daha büyük */
        }
        .day-col.selected { border-color: var(--blue); box-shadow: 0 0 0 1px var(--blue); }
        .day-col.today { background: #202023; }

        /* --- GÖREV KARTI & TAGLER --- */
        .task-card {
            background: var(--input-bg); padding: 10px; border-radius: 8px;
            position: relative; border-left: 3px solid transparent; transition: 0.2s;
        }
        .task-card:hover { transform: translateY(-2px); }
        
        /* Tag Renkleri (Sol Çizgi) */
        .tag-is { border-left-color: var(--blue); }
        .tag-ozel { border-left-color: var(--green); }
        .tag-okul { border-left-color: var(--orange); }
        .tag-acil { border-left-color: var(--red); }
        .tag-yok { border-left-color: var(--line); }

        .task-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .tag-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: rgba(255,255,255,0.1); }
        
        .task-time { font-size: 11px; color: var(--blue); font-weight: bold; }
        .task-text { font-size: 13px; line-height: 1.4; word-break: break-word; }

        /* --- ALT PANEL --- */
        .dashboard {
            height: 240px; flex-shrink: 0; display: flex; gap: 20px;
            background: var(--bg); position: relative; z-index: 50;
            border-top: 1px solid var(--line); padding-top: 15px;
        }
        .panel-box { background: var(--card-bg); border: 1px solid var(--line); border-radius: 16px; padding: 15px; display: flex; flex-direction: column; }
        
        /* Input Alanı */
        .input-row { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
        select { background: var(--bg); border: 1px solid var(--line); color: white; padding: 10px; border-radius: 8px; }
        .btn-add { background: var(--text-main); color: var(--bg); border: none; padding: 0 20px; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* Kaydırma Çubuğu */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: var(--line); border-radius: 10px; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-box">
            <h2 style="margin-bottom:20px;">Giriş Yap</h2>
            <input type="email" id="emailInput" class="login-input" placeholder="E-Posta">
            <input type="password" id="passwordInput" class="login-input" placeholder="Şifre">
            <button onclick="handleLogin()" class="btn-auth">Giriş</button>
            <button onclick="handleSignUp()" class="btn-auth" style="background:transparent; border:1px solid var(--line); color:var(--text-muted);">Kayıt Ol</button>
            <p id="authError"></p>
        </div>
    </div>

    <header>
        <div style="display:flex; gap:10px; align-items:center;">
            <button onclick="setView('week')" id="btnWeek" class="nav-btn active">Haftalık</button>
            <button onclick="setView('month')" id="btnMonth" class="nav-btn">Aylık</button>
            <span id="userEmail" style="font-size:12px; color:var(--text-muted); margin-left:10px;"></span>
        </div>
        
        <div style="display:flex; align-items:center; gap:5px;">
            <button onclick="changeDate(-1)" class="icon-btn"><span class="material-icons-round">chevron_left</span></button>
            <span id="dateTitle" style="font-size:14px; font-weight:500; min-width:150px; text-align:center;">...</span>
            <button onclick="changeDate(1)" class="icon-btn"><span class="material-icons-round">chevron_right</span></button>
            <button onclick="handleLogout()" class="icon-btn" style="color:var(--red); margin-left:10px;"><span class="material-icons-round">logout</span></button>
        </div>
    </header>

    <div id="calendarContainer"></div>

    <div class="dashboard">
        <div class="panel-box" style="flex:2;">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span id="selectedDateTitle" style="color:var(--text-muted); font-size:13px;">Seçili Gün</span>
            </div>

            <div class="input-row">
                <input type="text" id="taskInput" placeholder="Görev..." style="flex:1;">
                <select id="tagInput">
                    <option value="yok">Tag Yok</option>
                    <option value="is">İş</option>
                    <option value="ozel">Özel</option>
                    <option value="okul">Okul</option>
                    <option value="acil">Acil!</option>
                </select>
                <input type="time" id="timeInput">
                <button onclick="addTask()" class="btn-add">Ekle</button>
            </div>

            <div id="selectedList" style="flex:1; overflow-y:auto;"></div>
        </div>

        <div class="panel-box" style="flex:1;">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span style="font-size:14px;">Brain Dump</span>
                <div style="display:flex; gap:5px;">
                    <button onclick="addInboxTask()" class="icon-btn"><span class="material-icons-round">add</span></button>
                    <button onclick="clearInbox()" class="icon-btn" style="color:var(--red)"><span class="material-icons-round">delete_sweep</span></button>
                </div>
            </div>
            <div id="inboxList" style="flex:1; overflow-y:auto;"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://czuprhvrnlqpipcytvwx.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_IR67FHQQNsnA9aNMizaqUA_HYGC8cKM';
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let db = { tasks: [], inbox: [] };
        let currentUser = null;
        let state = { view: 'week', current: new Date(), selected: new Date().toISOString().split('T')[0] };

        // --- AUTH ---
        window.onload = async () => {
            const { data: { session } } = await client.auth.getSession();
            if(session) userLoggedIn(session.user);
        };

        async function handleLogin() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            const { data, error } = await client.auth.signInWithPassword({ email, password });
            if(error) alert(error.message); else userLoggedIn(data.user);
        }

        async function handleSignUp() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            const { error } = await client.auth.signUp({ email, password });
            if(error) alert(error.message); else alert("Mailini onayla!");
        }

        async function handleLogout() { await client.auth.signOut(); location.reload(); }

        function userLoggedIn(user) {
            currentUser = user;
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('userEmail').innerText = user.email;
            loadData().then(render);
        }

        // --- DATA ---
        async function loadData() {
            const { data } = await client.from('minimal_todo').select('data').eq('user_id', currentUser.id).single();
            if(data) db = data.data || { tasks: [], inbox: [] };
        }

        async function saveDB() {
            await client.from('minimal_todo').upsert({ user_id: currentUser.id, data: db }, { onConflict: 'user_id' });
        }

        // --- RENDER ---
        function render() {
            const container = document.getElementById('calendarContainer');
            container.innerHTML = '';
            
            if(state.view === 'week') renderWeek(container);
            else renderMonth(container);

            renderList();
            renderInbox();
            
            const trDate = new Date(state.selected).toLocaleDateString('tr-TR', { weekday:'long', day:'numeric', month:'long' });
            document.getElementById('selectedDateTitle').innerText = trDate;
        }

        function renderWeek(container) {
            container.innerHTML = '<div class="week-grid" id="grid"></div>';
            const grid = document.getElementById('grid');
            
            const start = getStartOfWeek(state.current);
            const end = new Date(start); end.setDate(end.getDate()+6);
            document.getElementById('dateTitle').innerText = `${start.getDate()} - ${end.toLocaleDateString('tr-TR', {day:'numeric', month:'long'})}`;

            for(let i=0; i<7; i++) {
                const d = new Date(start); d.setDate(d.getDate()+i);
                const dateStr = d.toISOString().split('T')[0];
                const tasks = db.tasks.filter(t => t.date === dateStr && !t.deleted);
                
                let html = '';
                tasks.forEach(t => html += getTaskHTML(t));

                const isSel = dateStr === state.selected ? 'selected' : '';
                const isToday = dateStr === new Date().toISOString().split('T')[0] ? 'today' : '';

                grid.innerHTML += `
                    <div class="day-col ${isSel} ${isToday}" onclick="selectDay('${dateStr}')">
                        <div style="font-weight:600; color:var(--text-muted); display:flex; justify-content:space-between;">
                            <span>${d.toLocaleDateString('tr-TR', {weekday:'short'})}</span>
                            <span>${d.getDate()}</span>
                        </div>
                        <div style="flex:1;">${html}</div>
                        <button onclick="selectDay('${dateStr}'); document.getElementById('taskInput').focus()" style="background:none; border:1px dashed var(--line); color:var(--text-muted); width:100%; border-radius:6px; cursor:pointer;">+</button>
                    </div>`;
            }
        }

        function renderMonth(container) {
            container.innerHTML = '<div class="month-grid" id="mGrid"></div>';
            const grid = document.getElementById('mGrid');
            const y = state.current.getFullYear(), m = state.current.getMonth();
            document.getElementById('dateTitle').innerText = new Date(y, m).toLocaleDateString('tr-TR', {month:'long', year:'numeric'});

            const days = new Date(y, m+1, 0).getDate();
            const startDay = (new Date(y, m, 1).getDay() || 7) - 1; // Pzt=0

            for(let i=0; i<startDay; i++) grid.innerHTML += '<div></div>';
            
            for(let d=1; d<=days; d++) {
                const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const count = db.tasks.filter(t => t.date === dateStr && !t.deleted && !t.done).length;
                const isSel = dateStr === state.selected ? 'border:1px solid var(--blue);' : 'border:1px solid var(--line);';
                
                grid.innerHTML += `
                    <div style="background:var(--card-bg); padding:10px; border-radius:8px; min-height:80px; cursor:pointer; ${isSel}" onclick="selectDay('${dateStr}')">
                        <div style="font-weight:bold;">${d}</div>
                        ${count > 0 ? `<div style="font-size:11px; color:var(--blue); margin-top:5px;">● ${count} İş</div>` : ''}
                    </div>`;
            }
        }

        function renderList() {
            const list = document.getElementById('selectedList');
            const tasks = db.tasks.filter(t => t.date === state.selected && !t.deleted);
            list.innerHTML = '';
            tasks.forEach(t => list.innerHTML += getRowHTML(t));
        }

        function renderInbox() {
            const list = document.getElementById('inboxList');
            list.innerHTML = '';
            db.inbox.forEach(t => {
                list.innerHTML += `
                <div style="display:flex; gap:10px; padding:5px 0; border-bottom:1px solid var(--line); opacity:${t.done?0.5:1}">
                    <button onclick="toggleInbox('${t.id}')" class="icon-btn" style="color:${t.done?'var(--green)':'var(--text-muted)'}">✓</button>
                    <span style="flex:1; font-size:13px; text-decoration:${t.done?'line-through':'none'}">${t.text}</span>
                </div>`;
            });
        }

        // --- HTML TEMPLATES ---
        function getTaskHTML(t) {
            const tagName = t.tag ? t.tag.toUpperCase() : '';
            const tagClass = t.tag ? `tag-${t.tag}` : 'tag-yok';
            
            return `
            <div class="task-card ${tagClass}" style="opacity:${t.done?0.5:1}; margin-bottom:8px;">
                <div class="task-header">
                    ${t.time ? `<span class="task-time">${t.time}</span>` : '<span></span>'}
                    ${tagName && tagName !== 'YOK' ? `<span class="tag-badge">${tagName}</span>` : ''}
                </div>
                <div class="task-text" style="text-decoration:${t.done?'line-through':'none'}">${t.text}</div>
                <div style="position:absolute; bottom:5px; right:5px; display:flex; gap:5px;">
                     <button onclick="toggleTask('${t.id}')" class="icon-btn" style="font-size:12px;">✓</button>
                     <button onclick="delTask('${t.id}')" class="icon-btn" style="font-size:12px; color:var(--red);">✕</button>
                </div>
            </div>`;
        }

        function getRowHTML(t) {
            return `
            <div style="display:flex; align-items:center; gap:10px; padding:8px 0; border-bottom:1px solid var(--line); opacity:${t.done?0.5:1}">
                <button onclick="toggleTask('${t.id}')" class="icon-btn" style="color:${t.done?'var(--green)':'var(--text-muted)'}">
                    <span class="material-icons-round">${t.done ? 'check_box' : 'check_box_outline_blank'}</span>
                </button>
                <div style="flex:1;">
                    <div style="font-size:13px; text-decoration:${t.done?'line-through':'none'}">${t.text}</div>
                    ${t.tag && t.tag !== 'yok' ? `<span style="font-size:10px; background:var(--line); padding:2px 4px; border-radius:4px;">${t.tag.toUpperCase()}</span>` : ''}
                </div>
                <button onclick="delTask('${t.id}')" class="icon-btn" style="color:var(--red);">✕</button>
            </div>`;
        }

        // --- ACTIONS ---
        function selectDay(d) { state.selected = d; render(); }
        function setView(v) { 
            state.view = v; 
            document.getElementById('btnWeek').classList.toggle('active', v==='week');
            document.getElementById('btnMonth').classList.toggle('active', v==='month');
            render(); 
        }
        function changeDate(d) {
            if(state.view === 'week') state.current.setDate(state.current.getDate() + (d*7));
            else state.current.setMonth(state.current.getMonth() + d);
            render();
        }

        function addTask() {
            const txt = document.getElementById('taskInput').value;
            if(!txt) return;
            db.tasks.push({
                id: Date.now().toString(),
                text: txt,
                time: document.getElementById('timeInput').value,
                tag: document.getElementById('tagInput').value,
                date: state.selected,
                done: false, deleted: false
            });
            saveDB(); render();
            document.getElementById('taskInput').value = '';
        }

        function addInboxTask() {
            const t = prompt("Not:");
            if(t) { db.inbox.push({id:Date.now().toString(), text:t, done:false}); saveDB(); render(); }
        }

        function toggleTask(id) { const t = db.tasks.find(x=>x.id==id); if(t){t.done=!t.done; saveDB(); render();} }
        function delTask(id) { if(confirm('Sil?')){ const t=db.tasks.find(x=>x.id==id); if(t){t.deleted=true; saveDB(); render();} } }
        function toggleInbox(id) { const t = db.inbox.find(x=>x.id==id); if(t){t.done=!t.done; saveDB(); render();} }
        function clearInbox() { db.inbox = db.inbox.filter(t=>!t.done); saveDB(); render(); }

        function getStartOfWeek(d) {
            const date = new Date(d);
            const day = date.getDay();
            const diff = date.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(date.setDate(diff));
        }
    </script>
</body>
</html>
