<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#111111" />
  <title>Minimal To-Do v14.1 (Sync)</title>
  <link rel="manifest" href="manifest.webmanifest">

  <style>
    :root{
      --bg:#0f0f10; --card:#17171a; --muted:#a3a3a3; --text:#f5f5f5; --line:#2a2a2f; --accent:#7dd3fc;
      --shadow: 0 10px 30px rgba(0,0,0,.35);

      --frame-termin:#fb7185;
      --frame-hedef:#60a5fa;
      --frame-gorev:#34d399;

      --monthCellH: 130px;
    }

    *{ box-sizing:border-box; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    html, body{ height:100%; }
    body{ margin:0; background:var(--bg); color:var(--text); }
    .wrap{ max-width:1440px; margin:0 auto; padding:16px; }

    header{ display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:12px; flex-wrap:wrap; }
    .left{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    h1{ font-size:16px; margin:0; font-weight:650; letter-spacing:.2px; }

    .btn{ background:var(--card); border:1px solid var(--line); color:var(--text); padding:8px 10px; border-radius:12px; cursor:pointer; }
    .btn:hover{ border-color:#3a3a44; }
    .btn:active{ transform: translateY(1px); }
    .btn.danger{ color:#fb7185; border-color:rgba(251,113,133,.35); }
    .btn.danger:hover{ border-color:rgba(251,113,133,.6); }

    .seg{ display:flex; background:var(--card); border:1px solid var(--line); border-radius:14px; overflow:hidden; }
    .seg button{ border:0; background:transparent; color:var(--muted); padding:8px 12px; cursor:pointer; }
    .seg button.active{ color:var(--text); background:#1f1f24; }

    .bar{ display:flex; gap:10px; align-items:center; justify-content:space-between; margin:10px 0 12px; flex-wrap:wrap; }
    .nav{ display:flex; gap:8px; align-items:center; }
    .title{ font-size:14px; color:var(--muted); }
    .filters{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }

    select, input[type="text"], input[type="search"], input[type="time"], input[type="email"]{
      background:#101014; color:var(--text);
      border:1px solid var(--line); border-radius:12px;
      padding:8px 10px; outline:none; font-size:13px;
    }
    select:focus, input:focus{ border-color:#3a3a44; }

    .main{
      display:grid;
      grid-template-columns: 1fr 240px;
      gap:12px;
      align-items:start;
    }

    /* Base calendar area */
    .calendarArea{
      height: calc(100vh - 210px);
      overflow:auto;
      padding-right:4px;
    }

    /* Week: keep normal calendar height */
    body.weekMode .calendarArea{
      height: calc(100vh - 320px);
    }

    /* Month: give calendar more space */
    body.monthMode .calendarArea{
      height: calc(100vh - 140px);
    }

    .grid{ display:grid; gap:10px; }
    .month{ grid-template-columns: repeat(7, 1fr); }
    .week{ grid-template-columns: repeat(7, 1fr); }
    .dow{ font-size:12px; color:var(--muted); padding:0 6px; }

    /* week grid a bit tighter so bottom can feel closer */
    body.weekMode .grid{ gap:8px; }

    .cell{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px;
      cursor:pointer;
      display:flex;
      flex-direction:column;
      gap:8px;
      overflow:hidden;
      min-width:0;
    }
    .cell.weekCell{ min-height:280px; }
    .cell.monthCell{ height: var(--monthCellH); }
    .cell:hover{ border-color:#3a3a44; }
    .cell.out{ opacity:.55; }
    .cell.sel{ outline:2px solid rgba(125,211,252,.35); border-color:rgba(125,211,252,.35); }
    .cell.dragOver{ outline:2px dashed rgba(125,211,252,.45); border-color:rgba(125,211,252,.45); }

    .dateRow{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .dateLeft{ display:flex; align-items:center; gap:8px; min-width:0; }
    .date{ font-size:12px; color:var(--muted); }
    .count{ font-size:12px; color:var(--accent); }

    .plusBtn{
      width:26px; height:26px;
      display:grid; place-items:center;
      border-radius:10px;
      border:1px solid var(--line);
      background:transparent;
      color:var(--muted);
      cursor:pointer;
      flex:0 0 auto;
    }
    .plusBtn:hover{ border-color:#3a3a44; color:var(--text); }

    .cards{
      display:flex;
      flex-direction:column;
      gap:6px;
      overflow:auto;
      min-height:0;
      padding-right:2px;
    }

    .card{
      border:2px solid var(--frameColor, var(--line));
      border-radius:12px;
      padding:6px 8px;
      background: var(--fillColor, rgba(255,255,255,0.04));
      user-select:none;
      min-width:0;
      position:relative;
    }
    .card[draggable="true"]{ cursor:grab; }
    .card:active{ cursor:grabbing; }
    .card.done{ opacity:.55; }

    .cardRow{ display:flex; align-items:flex-start; gap:8px; min-width:0; }

    .checkBtn{
      width:18px; height:18px;
      display:grid; place-items:center;
      border-radius:7px;
      border:1px solid rgba(0,0,0,.25);
      background:rgba(0,0,0,.10);
      color:rgba(255,255,255,.85);
      cursor:pointer;
      flex:0 0 auto;
      font-size:11px;
      line-height:1;
      margin-top:1px;
    }

    .cardBody{
      flex:1 1 auto;
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:3px;
      padding-right:22px;
    }

    .titleText{
      font-size:12.8px;
      line-height:1.2;
      color: var(--text);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .timeText{
      font-size:11px;
      line-height:1.1;
      color: rgba(255,255,255,.75);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Month: compact cards */
    body.monthMode .card{ padding:4px 6px; border-radius:10px; }
    body.monthMode .cards{ gap:4px; }
    body.monthMode .checkBtn{ width:14px; height:14px; border-radius:6px; font-size:9px; margin-top:0; }
    body.monthMode .cardBody{ gap:2px; padding-right:20px; }
    body.monthMode .titleText{ font-size:11px; }
    body.monthMode .timeText{ font-size:10px; }
    body.monthMode .moreBtn{ width:16px; height:16px; top:5px; right:5px; font-size:12px; }

    /* Month: time right (inline), small */
    body.monthMode .cardBody{
      flex-direction: row;
      align-items: center;
      gap: 6px;
    }
    body.monthMode .titleText{
      flex: 1 1 auto;
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    body.monthMode .timeText{
      flex: 0 0 auto;
      font-size: 9.5px;
      opacity: .85;
    }

    /* Month cells: scrollbar thinner only inside the day cards list */
    body.monthMode .monthCell .cards{
      scrollbar-width: thin;                 /* Firefox */
      scrollbar-color: rgba(255,255,255,.22) transparent;
    }
    body.monthMode .monthCell .cards::-webkit-scrollbar{
      width: 5px;                            /* Chrome/Edge/Safari */
    }
    body.monthMode .monthCell .cards::-webkit-scrollbar-track{
      background: transparent;
    }
    body.monthMode .monthCell .cards::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.18);
      border-radius: 999px;
    }
    body.monthMode .monthCell .cards::-webkit-scrollbar-thumb:hover{
      background: rgba(255,255,255,.26);
    }

    .moreBtn{
      position:absolute;
      top:6px; right:6px;
      width:18px; height:18px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,.15);
      background:rgba(0,0,0,.12);
      color:rgba(255,255,255,.85);
      cursor:pointer;
      display:grid; place-items:center;
      font-size:14px;
      line-height:1;
    }
    .moreBtn:hover{ border-color:rgba(255,255,255,.25); }

    /* Sidebar */
    .side{ position:sticky; top:12px; display:flex; flex-direction:column; gap:12px; }
    .panelBox{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px;
      box-shadow: var(--shadow);
    }
    .panelHead{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .panelHead h2{ margin:0; font-size:14px; }
    .muted{ color:var(--muted); font-size:12px; }

    .inbox.dragOver{ outline:2px dashed rgba(125,211,252,.45); border-color:rgba(125,211,252,.45); }
    .inboxList{ display:flex; flex-direction:column; gap:8px; overflow:auto; max-height:40vh; padding-right:2px; }

    /* Bottom panels */
    .bottom{
      margin-top: 0px;
      background:transparent;
      border:0;
      padding:0;
    }
    /* Week: pull bottom up close to calendar */
    body.weekMode .bottom{
      margin-top: -64px; /* senin ayarÄ±n */
    }

    .bottomGrid{ display:block; }
    body.weekMode .bottomGrid{
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:10px;
      align-items:start;
    }

    .panelLike{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px;
      box-shadow: var(--shadow);
    }

    .bottomTop{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .panelLike h2{ margin:0; font-size:14px; }

    form{ display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
    .w{ min-width:160px; }

    .list{ margin-top:10px; display:flex; flex-direction:column; gap:8px; }
    .row{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border:1px solid var(--line);
      background:#121216;
      padding:10px 12px;
      border-radius:14px;
    }
    .row .txt{ font-size:13px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    /* Month mode: hide sidebar + brain dump dock */
    body.monthMode .side{ display:none; }
    body.monthMode .main{ grid-template-columns: 1fr; }
    body.monthMode #bottomInboxSlot{ display:none; }

    /* Modal */
    .overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding:16px;
      z-index:50;
    }
    .modal{
      width:min(760px, 100%);
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      padding:12px;
      box-shadow: var(--shadow);
      max-height: 86vh;
      overflow:auto;
    }
    .modalTop{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .modalTop h3{ margin:0; font-size:14px; }
    .modalGrid{ display:grid; grid-template-columns: 1fr 170px 170px 1fr; gap:8px; margin-top:10px; }
    .modalGrid .full{ grid-column: 1 / -1; }
    .modalActions{ display:flex; justify-content:space-between; align-items:center; gap:8px; margin-top:10px; }

    /* Tag settings drag-drop */
    .tagManager{ display:flex; flex-direction:column; gap:8px; margin-top:10px; }
    .tagItem{
      display:grid;
      grid-template-columns: 1fr auto auto;
      gap:8px;
      align-items:center;
      border:1px solid var(--line);
      background:#121216;
      padding:8px 10px;
      border-radius:14px;
    }
    .tagItem.dragOver{ outline:2px dashed rgba(125,211,252,.35); border-color:rgba(125,211,252,.35); }
    .tagName{ display:flex; align-items:center; gap:10px; min-width:0; }
    .tagName span{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .dot{ width:10px; height:10px; border-radius:999px; display:inline-block; }
    input[type="color"]{ width:44px; height:34px; border-radius:12px; border:1px solid var(--line); background:transparent; padding:0; }

    .iconBtn{
      width:38px; height:34px; display:grid; place-items:center;
      border-radius:12px; border:1px solid var(--line);
      background:transparent; color:var(--muted); cursor:pointer;
    }
    .iconBtn:hover{ border-color:#3a3a44; color:var(--text); }

    /* Habits */
    .habitsList{ display:flex; flex-direction:column; gap:10px; }
    .habitRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:8px 10px; border:1px solid var(--line); background:#121216; border-radius:14px;
    }
    .habitRow.dragging{ opacity:.6; }
    .habitRow.dragOver{ outline:2px dashed rgba(125,211,252,.35); border-color:rgba(125,211,252,.35); }
    .habitRow label{ display:flex; align-items:center; gap:10px; min-width:0; }
    .habitRow span{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .habitRow input[type="checkbox"]{ width:18px; height:18px; }

    @media (max-width: 900px){
      .main{ grid-template-columns: 1fr; }
      .side{ position:static; }
      .calendarArea{ height:auto; max-height:none; }
      body.weekMode .bottomGrid{ grid-template-columns: 1fr; }
      body.monthMode .side{ display:none; }
      body.weekMode .bottom{ margin-top: 0px; } /* kÃ¼Ã§Ã¼k ekranda negatif margin riskli */
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="left">
        <h1>Minimal To-Do v14.1</h1>
        <div class="seg" role="tablist" aria-label="GÃ¶rÃ¼nÃ¼m">
          <button id="btnWeek" class="active" type="button">Hafta</button>
          <button id="btnMonth" type="button">Ay</button>
        </div>
      </div>

      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <button id="tagSettingsBtn" class="btn" type="button">Tag AyarlarÄ±</button>
        <button id="btnInstall" class="btn" type="button" style="display:none;">YÃ¼kle</button>
        <button id="authBtn" class="btn" type="button">GiriÅŸ Yap</button>
      </div>
    </header>

    <div class="bar">
      <div class="nav">
        <button id="prev" class="btn" type="button">â—€</button>
        <button id="today" class="btn" type="button">BugÃ¼n</button>
        <button id="next" class="btn" type="button">â–¶</button>
      </div>

      <div class="filters">
        <div class="title" id="rangeTitle"></div>

        <select id="tagFilter" title="Tag filtresi">
          <option value="__all__">Tag: Hepsi</option>
        </select>

        <select id="typeFilter" title="TÃ¼r filtresi">
          <option value="__preset__">TÃ¼r: GÃ¶rÃ¼nÃ¼me gÃ¶re (preset)</option>
          <option value="__all__">TÃ¼r: Hepsi</option>
          <option value="termin">Sadece termin</option>
          <option value="hedef">Sadece hedef</option>
          <option value="gorev">Sadece gÃ¶rev</option>
        </select>

        <input id="search" type="search" placeholder="Araâ€¦" />
      </div>
    </div>

    <div class="main">
      <div>
        <div id="calendarArea" class="calendarArea">
          <div class="grid" id="dowRow"></div>
          <div class="grid week" id="grid"></div>
        </div>

        <section class="bottom" id="bottom">
          <div class="bottomGrid" id="bottomGrid">

            <div class="panelLike">
              <div class="bottomTop">
                <div>
                  <h2 id="panelTitle">SeÃ§ili gÃ¼n</h2>
                  <div class="muted">SÄ±ralama: Termin â†’ Hedef â†’ GÃ¶rev â€¢ Saat â€¢ Tag</div>
                </div>
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                  <button id="clearDone" class="btn" type="button">TamamlananlarÄ± temizle</button>
                </div>
              </div>

              <form id="addForm" autocomplete="off">
                <input class="w" id="taskInput" type="text" placeholder="BaÅŸlÄ±kâ€¦" maxlength="120" />
                <input class="w" id="timeInput" type="time" title="Saat" />
                <select class="w" id="typeInput" title="TÃ¼r">
                  <option value="termin">Termin</option>
                  <option value="hedef">Hedef</option>
                  <option value="gorev">GÃ¶rev</option>
                </select>
                <select class="w" id="tagInput" title="Tag (dropdown)"></select>

                <select class="w" id="whereInput" title="Nereye eklensin?">
                  <option value="selected">SeÃ§ili gÃ¼ne</option>
                  <option value="inbox">Inbox (Brain Dump)</option>
                </select>

                <button id="addSubmit" class="btn" type="submit">Ekle</button>
              </form>

              <div class="list" id="taskList"></div>
            </div>

            <div id="bottomInboxSlot" class="panelLike"></div>

          </div>
        </section>
      </div>

      <aside class="side">
        <div id="inbox" class="panelBox inbox" aria-label="Brain Dump">
          <div class="panelHead">
            <div>
              <h2>Brain Dump</h2>
              <div class="muted">GÃ¼ne atanmamÄ±ÅŸ kartlar</div>
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
              <button id="inboxAdd" class="plusBtn" type="button">+</button>
              <button id="clearInboxDone" class="btn" type="button">Temizle</button>
            </div>
          </div>
          <div class="muted" id="inboxCount"></div>
          <div id="inboxList" class="inboxList"></div>
        </div>

        <div id="habitsBox" class="panelBox">
          <div class="panelHead">
            <div>
              <h2>Habits</h2>
              <div class="muted" id="habitsSub">Her gÃ¼n sÄ±fÄ±rlanÄ±r</div>
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
              <button id="habitAddBtn" class="plusBtn" type="button">+</button>
              <button id="habitResetBtn" class="btn" type="button">Reset</button>
            </div>
          </div>
          <div class="habitsList" id="habitsList"></div>
        </div>
      </aside>
    </div>
  </div>

  <div id="overlay" class="overlay" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalTop">
        <h3 id="modalTitle">Modal</h3>
        <button id="modalClose" class="btn" type="button">Kapat</button>
      </div>

      <div id="quickAddSection">
        <div class="muted" id="modalWhere"></div>
        <div class="modalGrid">
          <input id="mText" class="full" type="text" placeholder="BaÅŸlÄ±kâ€¦" maxlength="120" />
          <input id="mTime" type="time" />
          <select id="mType">
            <option value="termin">Termin</option>
            <option value="hedef">Hedef</option>
            <option value="gorev">GÃ¶rev</option>
          </select>
          <select id="mTag"></select>
          <div class="full muted">Enter = Kaydet/Ekle</div>
        </div>

        <div class="modalActions">
          <button id="modalDelete" class="btn danger" type="button" style="display:none;">Sil</button>
          <div style="display:flex; gap:8px; margin-left:auto;">
            <button id="modalSave" class="btn" type="button">Ekle</button>
          </div>
        </div>
      </div>

      <div id="tagSettingsSection" style="display:none;">
        <div class="muted">Tag sÄ±ralamasÄ±nÄ± drag-drop ile deÄŸiÅŸtir.</div>
        <div class="tagManager" id="tagManager"></div>
      </div>
    </div>
  </div>

  <div id="authOverlay" class="overlay">
    <div class="modal" style="max-width:400px;">
      <div class="modalTop">
        <h3>Hesap / Senkronizasyon</h3>
        <button id="authClose" class="btn" type="button">Kapat</button>
      </div>
      <div class="modalGrid" style="grid-template-columns: 1fr;">
        <div class="muted">Verilerini bulutta saklamak iÃ§in giriÅŸ yap.</div>
        <input id="emailInput" class="full" type="email" placeholder="E-posta adresi" />
        <button id="sendMagicLink" class="btn" type="button" style="justify-self:start;">Sihirli Link GÃ¶nder</button>
        <div id="authStatus" class="muted" style="margin-top:10px;"></div>
        
        <hr style="width:100%; border:0; border-top:1px solid var(--line); margin:10px 0;">
        
        <button id="signOutBtn" class="btn danger" type="button" style="display:none;">Ã‡Ä±kÄ±ÅŸ Yap</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    // ----------------------------------------------------------------------------------
    // âš ï¸ LUTFEN SUPABASE BILGILERINI BURAYA GIR
    // ----------------------------------------------------------------------------------
    const SUPABASE_URL = 'https://czuprhvrnlqpipcytvwx.supabase.co'; // Ã–rn: 'https://xyz.supabase.co'
    const SUPABASE_KEY = 'sb_publishable_IR67FHQQNsnA9aNMizaqUA_HYGC8cKM'; // Ã–rn: 'eyJhbGciOiJIUzI1NiIsInR5...' (Anon public key)
    // ----------------------------------------------------------------------------------

    let supabase = null;
    if(SUPABASE_URL && SUPABASE_KEY) {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    } else {
      console.warn("Supabase bilgileri girilmediÄŸi iÃ§in bulut Ã¶zellikleri devre dÄ±ÅŸÄ±.");
    }

    // PWA install
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(()=>{}));
    }
    let deferredPrompt = null;
    const btnInstall = document.getElementById('btnInstall');
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      btnInstall.style.display = 'inline-block';
    });
    btnInstall.addEventListener('click', async () => {
      if (!deferredPrompt) return;
      deferredPrompt.prompt();
      await deferredPrompt.userChoice;
      deferredPrompt = null;
      btnInstall.style.display = 'none';
    });

    // --- DB MANAGEMENT & SYNC ---
    const KEY = 'minimal_todo_v14_1';
    let user = null; // Logged in Supabase user

    function defaultTags(){
      return [
        { name:'akademik',  color:'#7dd3fc', order:1 },
        { name:'praktikum', color:'#34d399', order:2 },
        { name:'finans',    color:'#fbbf24', order:3 },
        { name:'ev',        color:'#fb7185', order:4 },
      ];
    }

    function getFreshDB(){
      return { days:{}, inbox:[], tags: defaultTags(), habits:[], habitState:{ date: todayKey(), doneIds:[] } };
    }

    // Load Local first
    function loadDB(){
      const raw = localStorage.getItem(KEY);
      if (raw){ try { return JSON.parse(raw); } catch {} }
      const fresh = getFreshDB();
      localStorage.setItem(KEY, JSON.stringify(fresh));
      return fresh;
    }

    let db = loadDB();

    // Save Logic (Local + Debounced Cloud)
    let timeoutId = null;
    function saveDB(newDB){
      // 1. Save to LocalStorage immediately
      localStorage.setItem(KEY, JSON.stringify(newDB));
      
      // 2. If logged in, save to Cloud (debounced)
      if(user && supabase){
        saveToCloudDebounced(newDB);
      }
    }

    function saveToCloudDebounced(data){
      const statusDiv = document.getElementById('authStatus');
      if(statusDiv && authOverlay.style.display === 'flex') statusDiv.textContent = 'Kaydediliyor...';
      
      clearTimeout(timeoutId);
      timeoutId = setTimeout(async () => {
        // SQL: create table user_data (id uuid pk, content jsonb, updated_at ts)
        const { error } = await supabase
          .from('user_data')
          .upsert({ 
            id: user.id, // using 'id' to match your table
            content: data,
            updated_at: new Date() 
          });
        
        if(statusDiv && authOverlay.style.display === 'flex') {
          statusDiv.textContent = error ? 'Hata oluÅŸtu!' : 'Senkronize edildi âœ“';
        }
      }, 1000);
    }

    async function syncData() {
      if(!user || !supabase) return;
      
      const { data, error } = await supabase
        .from('user_data')
        .select('content')
        .eq('id', user.id) // using 'id' to match your table
        .single();

      if (data && data.content) {
        // Cloud has data, overwrite local
        db = data.content;
        localStorage.setItem(KEY, JSON.stringify(db));
        render();
        console.log("Buluttan veri Ã§ekildi.");
      } else if (!data) {
        // New user on cloud, push local data
        saveToCloudDebounced(db);
      }
    }

    // --- AUTH UI HANDLING ---
    const authBtn = document.getElementById('authBtn');
    const authOverlay = document.getElementById('authOverlay');
    const authClose = document.getElementById('authClose');
    const emailInput = document.getElementById('emailInput');
    const sendMagicLink = document.getElementById('sendMagicLink');
    const signOutBtn = document.getElementById('signOutBtn');
    const authStatus = document.getElementById('authStatus');

    authBtn.addEventListener('click', () => authOverlay.style.display = 'flex');
    authClose.addEventListener('click', () => authOverlay.style.display = 'none');
    
    if(supabase){
      sendMagicLink.addEventListener('click', async () => {
        const email = emailInput.value;
        if(!email) return alert('E-posta giriniz');
        
        sendMagicLink.disabled = true;
        sendMagicLink.textContent = 'GÃ¶nderiliyor...';
        
        const { error } = await supabase.auth.signInWithOtp({ email });
        
        if (error) {
          alert('Hata: ' + error.message);
        } else {
          alert('Sihirli link e-postana gÃ¶nderildi! Linke tÄ±klayarak giriÅŸ yapabilirsin.');
          authOverlay.style.display = 'none';
        }
        sendMagicLink.disabled = false;
        sendMagicLink.textContent = 'Sihirli Link GÃ¶nder';
      });

      signOutBtn.addEventListener('click', async () => {
        await supabase.auth.signOut();
        window.location.reload();
      });

      // Auth State Listener
      supabase.auth.onAuthStateChange(async (event, session) => {
        if (session) {
          user = session.user;
          authBtn.textContent = 'Hesap (' + user.email.split('@')[0] + ')';
          signOutBtn.style.display = 'block';
          emailInput.style.display = 'none';
          sendMagicLink.style.display = 'none';
          authStatus.textContent = 'GiriÅŸ yapÄ±ldÄ±.';
          
          await syncData();
        } else {
          user = null;
          authBtn.textContent = 'GiriÅŸ Yap';
          signOutBtn.style.display = 'none';
          emailInput.style.display = 'block';
          sendMagicLink.style.display = 'block';
        }
      });
    }

    // --- UTILS ---

    function dayKey(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const da = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    }
    function todayKey(){ return dayKey(new Date()); }

    function startOfWeek(date){
      const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      const day = (d.getDay() + 6) % 7;
      d.setDate(d.getDate() - day);
      return d;
    }
    function addDays(date, n){
      const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
      d.setDate(d.getDate()+n);
      return d;
    }
    function startOfMonth(date){ return new Date(date.getFullYear(), date.getMonth(), 1); }
    function endOfMonth(date){ return new Date(date.getFullYear(), date.getMonth()+1, 0); }

    function fmtRange(a,b){
      const opts = { day:'2-digit', month:'short', year:'numeric' };
      return `${a.toLocaleDateString('tr-TR', opts)} â€“ ${b.toLocaleDateString('tr-TR', opts)}`;
    }
    function fmtDay(d){
      return d.toLocaleDateString('tr-TR', { weekday:'long', day:'2-digit', month:'long', year:'numeric' });
    }

    function normalizeTagName(s){
      return (s||'').trim().toLowerCase().replace(/\s+/g,'-');
    }

    function fixItem(t){
      const id = t.id || (crypto.randomUUID ? crypto.randomUUID() : String(Date.now())+Math.random());
      const type = (['gorev','termin','hedef'].includes(t.type) ? t.type : 'gorev');
      return {
        id,
        text: (t.text||'').trim(),
        done: !!t.done,
        type,
        tag: (t.tag || ''),
        time: (t.time || ''),
        created: t.created || Date.now()
      };
    }

    function getCssVar(name){
      return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    }
    function typeFrameColor(type){
      if (type === 'termin') return getCssVar('--frame-termin');
      if (type === 'hedef') return getCssVar('--frame-hedef');
      return getCssVar('--frame-gorev');
    }

    function hexToRgba(hex, alpha){
      if (!hex) return `rgba(255,255,255,${alpha})`;
      const h = hex.replace('#','').trim();
      const full = h.length === 3 ? h.split('').map(c=>c+c).join('') : h;
      const r = parseInt(full.slice(0,2),16);
      const g = parseInt(full.slice(2,4),16);
      const b = parseInt(full.slice(4,6),16);
      return `rgba(${r},${g},${b},${alpha})`;
    }

    function typeRank(type){
      if (type === 'termin') return 0;
      if (type === 'hedef') return 1;
      return 2;
    }
    function timeKey(t){ return t.time ? t.time : '99:99'; }

    const DOW = ['Pzt','Sal','Ã‡ar','Per','Cum','Cts','Paz'];
    let mode = 'week';
    let anchor = new Date();
    let selected = new Date();
    let dragPayload = null;

    function ensureHabitReset(){
      const today = todayKey();
      db.habitState = db.habitState || { date: today, doneIds: [] };
      if (db.habitState.date !== today){
        db.habitState = { date: today, doneIds: [] };
        saveDB(db);
      }
    }
    ensureHabitReset();

    // UI refs
    const calendarArea = document.getElementById('calendarArea');
    const grid = document.getElementById('grid');
    const dowRow = document.getElementById('dowRow');
    const rangeTitle = document.getElementById('rangeTitle');
    const btnWeek = document.getElementById('btnWeek');
    const btnMonth = document.getElementById('btnMonth');

    const panelTitle = document.getElementById('panelTitle');
    const taskList = document.getElementById('taskList');

    const addForm = document.getElementById('addForm');
    const taskInput = document.getElementById('taskInput');
    const timeInput = document.getElementById('timeInput');
    const typeInput = document.getElementById('typeInput');
    const tagInput = document.getElementById('tagInput');
    const whereInput = document.getElementById('whereInput');
    const addSubmit = document.getElementById('addSubmit');
    const clearDone = document.getElementById('clearDone');

    const tagFilter = document.getElementById('tagFilter');
    const typeFilter = document.getElementById('typeFilter');
    const search = document.getElementById('search');

    const inbox = document.getElementById('inbox');
    const inboxList = document.getElementById('inboxList');
    const inboxCount = document.getElementById('inboxCount');
    const clearInboxDone = document.getElementById('clearInboxDone');
    const inboxAdd = document.getElementById('inboxAdd');
    const bottomInboxSlot = document.getElementById('bottomInboxSlot');

    const habitsList = document.getElementById('habitsList');
    const habitAddBtn = document.getElementById('habitAddBtn');
    const habitResetBtn = document.getElementById('habitResetBtn');
    const habitsSub = document.getElementById('habitsSub');

    // Modal
    const overlay = document.getElementById('overlay');
    const modalClose = document.getElementById('modalClose');
    const modalTitle = document.getElementById('modalTitle');
    const modalWhere = document.getElementById('modalWhere');
    const mText = document.getElementById('mText');
    const mTime = document.getElementById('mTime');
    const mType = document.getElementById('mType');
    const mTag = document.getElementById('mTag');
    const quickAddSection = document.getElementById('quickAddSection');
    const tagSettingsSection = document.getElementById('tagSettingsSection');
    const tagSettingsBtn = document.getElementById('tagSettingsBtn');
    const tagManager = document.getElementById('tagManager');
    const modalSave = document.getElementById('modalSave');
    const modalDelete = document.getElementById('modalDelete');

    let modalContext = { mode:'add', dest:'day', dayKey:null, origin:null, itemId:null };

    function closeModal(){ overlay.style.display = 'none'; }
    modalClose.addEventListener('click', closeModal);
    overlay.addEventListener('click', (e)=>{ if (e.target === overlay) closeModal(); });

    // Enter in modal always saves (unless tag settings page open)
    overlay.addEventListener('keydown', (e)=>{
      if (overlay.style.display !== 'flex') return;
      if (tagSettingsSection.style.display === 'block') return;
      if (e.key === 'Enter'){
        e.preventDefault();
        modalSave.click();
      }
    });

    tagSettingsBtn.addEventListener('click', ()=>{
      modalTitle.textContent = 'Tag AyarlarÄ±';
      quickAddSection.style.display = 'none';
      tagSettingsSection.style.display = 'block';
      overlay.style.display = 'flex';
      renderTagManager();
    });

    function tagMeta(name){ return db.tags.find(x=>x.name===name); }
    function tagOrder(name){
      if (!name) return 9999;
      const m = tagMeta(name);
      return m ? (m.order ?? 9999) : 9999;
    }
    function itemSort(a,b){
      const ra = typeRank(a.type), rb = typeRank(b.type);
      if (ra !== rb) return ra - rb;

      const ta = timeKey(a), tb = timeKey(b);
      if (ta < tb) return -1;
      if (ta > tb) return 1;

      const oa = tagOrder(a.tag), ob = tagOrder(b.tag);
      if (oa !== ob) return oa - ob;

      return (a.created||0) - (b.created||0);
    }

    function presetTypesForMode(){
      if (mode === 'month') return new Set(['termin','hedef']);
      return new Set(['termin','hedef','gorev']);
    }
    function passesFilters(item){
      const q = (search.value||'').trim().toLowerCase();
      if (q && !(item.text||'').toLowerCase().includes(q)) return false;

      const tf = tagFilter.value;
      if (tf && tf !== '__all__' && item.tag !== tf) return false;

      const tpf = typeFilter.value;
      if (tpf === '__preset__'){
        if (!presetTypesForMode().has(item.type)) return false;
      } else if (tpf !== '__all__' && item.type !== tpf) return false;

      return true;
    }

    function rebuildTagDropdowns(){
      db.tags.sort((a,b)=>(a.order??9999)-(b.order??9999));

      tagInput.innerHTML = '';
      const opt0 = document.createElement('option');
      opt0.value='__none__'; opt0.textContent='Tag: yok';
      tagInput.appendChild(opt0);
      for (const t of db.tags){
        const o = document.createElement('option');
        o.value=t.name; o.textContent=t.name;
        tagInput.appendChild(o);
      }

      mTag.innerHTML = '';
      const m0 = document.createElement('option');
      m0.value='__none__'; m0.textContent='Tag: yok';
      mTag.appendChild(m0);
      for (const t of db.tags){
        const o = document.createElement('option');
        o.value=t.name; o.textContent=t.name;
        mTag.appendChild(o);
      }

      const current = tagFilter.value || '__all__';
      tagFilter.innerHTML = '';
      const all = document.createElement('option');
      all.value='__all__'; all.textContent='Tag: Hepsi';
      tagFilter.appendChild(all);
      for (const t of db.tags){
        const o = document.createElement('option');
        o.value=t.name; o.textContent = `Tag: ${t.name}`;
        tagFilter.appendChild(o);
      }
      tagFilter.value = db.tags.some(x=>x.name===current) ? current : '__all__';
    }

    function addItemTo(dest, dayK, item){
      item = fixItem(item);
      if (dest === 'inbox'){
        db.inbox = db.inbox || [];
        db.inbox.push(item);
      } else {
        db.days[dayK] = db.days[dayK] || [];
        db.days[dayK].push(item);
      }
      saveDB(db);
    }

    function findItem(origin, itemId){
      if (!origin || !itemId) return null;
      if (origin.from === 'inbox'){
        return (db.inbox||[]).find(x=>x.id===itemId) || null;
      }
      if (origin.from === 'day'){
        return (db.days[origin.dayKey]||[]).find(x=>x.id===itemId) || null;
      }
      return null;
    }

    function deleteItem(origin, itemId){
      if (origin.from === 'inbox'){
        db.inbox = (db.inbox||[]).filter(x=>x.id!==itemId);
      } else if (origin.from === 'day'){
        const k = origin.dayKey;
        const arr = db.days[k] || [];
        const kept = arr.filter(x=>x.id!==itemId);
        if (kept.length) db.days[k]=kept; else delete db.days[k];
      }
      saveDB(db);
      render();
    }

    function openModalAdd(ctx){
      modalContext = { mode:'add', dest:ctx.dest, dayKey:ctx.dayKey, origin:null, itemId:null };
      modalTitle.textContent = (ctx.dest === 'inbox') ? 'Inboxâ€™a ekle' : 'GÃ¼ne ekle';
      modalWhere.textContent = (ctx.dest === 'inbox') ? 'Hedef: Brain Dump' : `Hedef gÃ¼n: ${ctx.dayKey}`;

      quickAddSection.style.display = 'block';
      tagSettingsSection.style.display = 'none';
      overlay.style.display = 'flex';

      rebuildTagDropdowns();
      mText.value = '';
      mTime.value = '';
      mTag.value = '__none__';

      const defaultType =
        (ctx.dest === 'inbox') ? 'gorev' :
        (mode === 'month') ? 'termin' : 'gorev';
      mType.value = defaultType;

      modalDelete.style.display = 'none';
      modalSave.textContent = 'Ekle';

      setTimeout(()=>mText.focus(), 0);
    }

    function openModalEdit(origin, itemId){
      const it = findItem(origin, itemId);
      if (!it) return;

      modalContext = { mode:'edit', dest:null, dayKey:null, origin, itemId };
      modalTitle.textContent = 'DÃ¼zenle';
      modalWhere.textContent = origin.from === 'inbox'
        ? 'Konum: Brain Dump'
        : `Konum: ${origin.dayKey}`;

      quickAddSection.style.display = 'block';
      tagSettingsSection.style.display = 'none';
      overlay.style.display = 'flex';

      rebuildTagDropdowns();
      mText.value = it.text || '';
      mTime.value = it.time || '';
      mType.value = it.type || 'gorev';
      mTag.value = it.tag ? it.tag : '__none__';

      modalDelete.style.display = 'inline-block';
      modalSave.textContent = 'Kaydet';

      setTimeout(()=>mText.focus(), 0);
    }

    modalSave.addEventListener('click', ()=>{
      const text = (mText.value||'').trim();
      if (!text) return;

      if (modalContext.mode === 'add'){
        addItemTo(modalContext.dest, modalContext.dayKey, {
          text,
          time: mTime.value || '',
          type: mType.value,
          tag: (mTag.value==='__none__' ? '' : mTag.value),
          done:false,
          created: Date.now()
        });
        closeModal();
        render();
        return;
      }

      if (modalContext.mode === 'edit'){
        const it = findItem(modalContext.origin, modalContext.itemId);
        if (!it) { closeModal(); return; }
        it.text = text;
        it.time = mTime.value || '';
        it.type = mType.value;
        it.tag  = (mTag.value==='__none__' ? '' : mTag.value);
        saveDB(db);
        closeModal();
        render();
      }
    });

    modalDelete.addEventListener('click', ()=>{
      if (modalContext.mode !== 'edit') return;
      if (!confirm('Silinsin mi?')) return;
      deleteItem(modalContext.origin, modalContext.itemId);
      closeModal();
    });

    function renderDOW(){
      dowRow.innerHTML = '';
      dowRow.className = 'grid ' + (mode==='month' ? 'month' : 'week');
      for (const name of DOW){
        const el = document.createElement('div');
        el.className='dow';
        el.textContent=name;
        dowRow.appendChild(el);
      }
    }

    function makeCard(item, origin){
      const meta = tagMeta(item.tag);
      const tagColor = meta?.color || null;

      const card = document.createElement('div');
      card.className = 'card' + (item.done ? ' done' : '');
      card.draggable = true;

      card.style.setProperty('--frameColor', typeFrameColor(item.type));
      card.style.setProperty('--fillColor', tagColor ? hexToRgba(tagColor, 0.22) : 'rgba(255,255,255,0.04)');

      const more = document.createElement('button');
      more.className='moreBtn';
      more.type='button';
      more.textContent='â‹¯';
      more.title='DÃ¼zenle';
      more.addEventListener('click', (e)=>{
        e.stopPropagation();
        openModalEdit(origin, item.id);
      });

      const row = document.createElement('div');
      row.className = 'cardRow';

      const check = document.createElement('button');
      check.className = 'checkBtn';
      check.type = 'button';
      check.title = item.done ? 'Geri al' : 'Tamamla';
      check.textContent = item.done ? 'â†©' : 'âœ“';
      check.addEventListener('click', (e)=>{
        e.stopPropagation();
        item.done = !item.done;
        saveDB(db);
        render();
      });

      const body = document.createElement('div');
      body.className = 'cardBody';

      const title = document.createElement('div');
      title.className = 'titleText';
      title.textContent = item.text || '(baÅŸlÄ±ksÄ±z)';
      body.appendChild(title);

      if (item.time){
        const time = document.createElement('div');
        time.className = 'timeText';
        time.textContent = item.time;
        body.appendChild(time);
      }

      row.appendChild(check);
      row.appendChild(body);

      card.appendChild(more);
      card.appendChild(row);

      card.addEventListener('dragstart', (e)=>{
        dragPayload = { ...origin, itemId: item.id };
        e.dataTransfer.setData('text/plain', JSON.stringify(dragPayload));
        e.dataTransfer.effectAllowed = 'move';
      });

      return card;
    }

    function renderInbox(){
      inboxList.innerHTML = '';
      const items = (db.inbox||[]).map(fixItem).filter(passesFilters).sort(itemSort);
      const openCount = items.filter(x=>!x.done).length;
      inboxCount.textContent = items.length ? `AÃ§Ä±k: ${openCount} â€¢ Toplam: ${items.length}` : 'BoÅŸ';

      if (!items.length){
        const empty = document.createElement('div');
        empty.className='muted';
        empty.textContent='Inbox boÅŸ. + ile hÄ±zlÄ± ekle.';
        inboxList.appendChild(empty);
        return;
      }
      for (const it of items){
        inboxList.appendChild(makeCard(it, {from:'inbox'}));
      }
    }

    function renderHabits(){
      ensureHabitReset();
      habitsList.innerHTML = '';
      const done = new Set(db.habitState?.doneIds || []);
      const total = (db.habits||[]).length;
      habitsSub.textContent = total ? `BugÃ¼n: ${done.size}/${total}` : 'Her gÃ¼n sÄ±fÄ±rlanÄ±r';

      if (!total){
        const empty = document.createElement('div');
        empty.className='muted';
        empty.textContent='AlÄ±ÅŸkanlÄ±k eklemek iÃ§in +';
        habitsList.appendChild(empty);
        return;
      }

      let dragHabitId = null;

      for (const h of db.habits){
        const row = document.createElement('div');
        row.className='habitRow';
        row.draggable = true;
        row.dataset.habit = h.id;

        const lab = document.createElement('label');
        const cb = document.createElement('input');
        cb.type='checkbox';
        cb.checked = done.has(h.id);
        cb.addEventListener('change', ()=>{
          ensureHabitReset();
          const s = new Set(db.habitState.doneIds || []);
          cb.checked ? s.add(h.id) : s.delete(h.id);
          db.habitState.doneIds = [...s];
          saveDB(db);
          renderHabits();
        });

        const name = document.createElement('span');
        name.textContent = h.name;

        lab.appendChild(cb);
        lab.appendChild(name);

        const del = document.createElement('button');
        del.className='iconBtn';
        del.type='button';
        del.textContent='ðŸ—‘';
        del.addEventListener('click', ()=>{
          if (!confirm(`"${h.name}" silinsin mi?`)) return;
          db.habits = (db.habits||[]).filter(x=>x.id!==h.id);
          ensureHabitReset();
          db.habitState.doneIds = (db.habitState.doneIds||[]).filter(id=>id!==h.id);
          saveDB(db);
          renderHabits();
        });

        row.appendChild(lab);
        row.appendChild(del);

        row.addEventListener('dragstart', ()=>{
          dragHabitId = h.id;
          row.classList.add('dragging');
        });
        row.addEventListener('dragend', ()=>{
          dragHabitId = null;
          row.classList.remove('dragging');
          [...habitsList.querySelectorAll('.habitRow')].forEach(x=>x.classList.remove('dragOver'));
        });
        row.addEventListener('dragover', (e)=>{
          e.preventDefault();
          row.classList.add('dragOver');
        });
        row.addEventListener('dragleave', ()=>row.classList.remove('dragOver'));
        row.addEventListener('drop', (e)=>{
          e.preventDefault();
          row.classList.remove('dragOver');
          const targetId = row.dataset.habit;
          if (!dragHabitId || !targetId || dragHabitId === targetId) return;

          const ids = db.habits.map(x=>x.id);
          const from = ids.indexOf(dragHabitId);
          const to = ids.indexOf(targetId);
          if (from < 0 || to < 0) return;

          const moved = db.habits.splice(from,1)[0];
          db.habits.splice(to,0,moved);

          saveDB(db);
          renderHabits();
        });

        habitsList.appendChild(row);
      }
    }

    function renderPanel(){
      const k = dayKey(selected);
      panelTitle.textContent = fmtDay(selected);
      const items = (db.days[k]||[]).map(fixItem).filter(passesFilters).sort(itemSort);

      taskList.innerHTML = '';
      if (!items.length){
        const empty = document.createElement('div');
        empty.className='muted';
        empty.style.padding='10px 2px';
        empty.textContent='Bu gÃ¼n iÃ§in (filtreye gÃ¶re) kart yok.';
        taskList.appendChild(empty);
        return;
      }
      for (const it of items){
        const row = document.createElement('div');
        row.className='row';
        const txt = document.createElement('div');
        txt.className='txt';
        txt.textContent = it.text + (it.time ? ` â€¢ ${it.time}` : '');
        txt.style.color = it.done ? 'var(--muted)' : 'var(--text)';
        row.appendChild(txt);
        taskList.appendChild(row);
      }
    }

    function adjustMonthCellHeight(totalCells){
      const rows = Math.max(5, Math.min(6, Math.ceil(totalCells / 7)));
      const areaH = calendarArea.clientHeight;
      const dowH = dowRow.getBoundingClientRect().height || 18;
      const gaps = (rows - 1) * 10 + 10;
      const topPadding = 14;
      const cellH = Math.floor((areaH - dowH - gaps - topPadding) / rows);
      const clamped = Math.max(115, Math.min(185, cellH));
      document.documentElement.style.setProperty('--monthCellH', clamped + 'px');
    }

    function dockInboxForMode(){
      const side = document.querySelector('.side');
      if (mode === 'week'){
        document.body.classList.add('weekMode');
        document.body.classList.remove('monthMode');

        const inboxOpt = whereInput.querySelector('option[value="inbox"]');
        if (inboxOpt) inboxOpt.disabled = false;

        if (bottomInboxSlot && inbox.parentElement !== bottomInboxSlot){
          bottomInboxSlot.appendChild(inbox);
        }
      } else {
        document.body.classList.remove('weekMode');
        document.body.classList.add('monthMode');

        whereInput.value = 'selected';
        const inboxOpt = whereInput.querySelector('option[value="inbox"]');
        if (inboxOpt) inboxOpt.disabled = true;

        if (inbox.parentElement !== side){
          side.insertBefore(inbox, side.firstChild);
        }
      }
    }

    function renderTagManager(){
      tagManager.innerHTML = '';

      const addRow = document.createElement('div');
      addRow.className = 'tagItem';
      addRow.innerHTML = `
        <input id="newTagText" type="text" placeholder="Yeni tag (Ã¶rn: kompozit)" />
        <input id="newTagColor" type="color" value="#7dd3fc" />
        <button id="newTagBtn" class="btn" type="button">Ekle</button>
      `;
      tagManager.appendChild(addRow);

      const newTagText = addRow.querySelector('#newTagText');
      const newTagColor = addRow.querySelector('#newTagColor');

      addRow.querySelector('#newTagBtn').addEventListener('click', ()=>{
        const name = normalizeTagName(newTagText.value);
        if (!name) return;
        if (db.tags.some(x=>x.name===name)) return;
        const maxOrder = Math.max(0, ...db.tags.map(x=>x.order||0));
        db.tags.push({ name, color: newTagColor.value || '#7dd3fc', order: maxOrder+1 });
        saveDB(db);
        rebuildTagDropdowns();
        render();
        renderTagManager();
      });

      const hint = document.createElement('div');
      hint.className='muted';
      hint.textContent='Tag sÄ±ralamasÄ±nÄ± sÃ¼rÃ¼kleyip bÄ±rakarak deÄŸiÅŸtir.';
      tagManager.appendChild(hint);

      db.tags.sort((a,b)=>(a.order??9999)-(b.order??9999));
      let dragTagName = null;

      for (const t of db.tags){
        const row = document.createElement('div');
        row.className='tagItem';
        row.draggable = true;
        row.dataset.tag = t.name;

        const nameBox = document.createElement('div');
        nameBox.className='tagName';
        const d = document.createElement('span'); d.className='dot'; d.style.background=t.color || '#999';
        const s = document.createElement('span'); s.textContent=t.name;
        nameBox.appendChild(d); nameBox.appendChild(s);

        const color = document.createElement('input');
        color.type='color';
        color.value = t.color || '#7dd3fc';
        color.addEventListener('input', ()=>{
          t.color = color.value;
          saveDB(db);
          render();
        });

        const del = document.createElement('button');
        del.className='iconBtn';
        del.type='button';
        del.textContent='ðŸ—‘';
        del.addEventListener('click', ()=>{
          if (!confirm(`"${t.name}" silinsin mi? (kartlardan tag kalkar)`)) return;
          db.tags = db.tags.filter(x=>x.name!==t.name);
          for (const k of Object.keys(db.days)){
            db.days[k].forEach(it=>{ if (it.tag===t.name) it.tag=''; });
          }
          (db.inbox||[]).forEach(it=>{ if (it.tag===t.name) it.tag=''; });
          saveDB(db);
          rebuildTagDropdowns();
          render();
          renderTagManager();
        });

        row.appendChild(nameBox);
        row.appendChild(color);
        row.appendChild(del);

        row.addEventListener('dragstart', ()=>{ dragTagName = t.name; });
        row.addEventListener('dragover', (e)=>{ e.preventDefault(); row.classList.add('dragOver'); });
        row.addEventListener('dragleave', ()=>row.classList.remove('dragOver'));
        row.addEventListener('drop', (e)=>{
          e.preventDefault();
          row.classList.remove('dragOver');
          const targetName = row.dataset.tag;
          if (!dragTagName || !targetName || dragTagName === targetName) return;

          const names = db.tags.slice().sort((a,b)=>(a.order??9999)-(b.order??9999)).map(x=>x.name);
          const from = names.indexOf(dragTagName);
          const to = names.indexOf(targetName);
          if (from<0 || to<0) return;
          names.splice(from,1);
          names.splice(to,0,dragTagName);

          names.forEach((name, idx)=>{
            const m = db.tags.find(x=>x.name===name);
            if (m) m.order = idx+1;
          });

          saveDB(db);
          rebuildTagDropdowns();
          render();
          renderTagManager();
        });

        tagManager.appendChild(row);
      }
    }

    function render(){
      for (const k of Object.keys(db.days||{})){
        db.days[k] = (db.days[k]||[]).map(fixItem);
      }
      db.inbox = (db.inbox||[]).map(fixItem);

      rebuildTagDropdowns();
      renderDOW();
      dockInboxForMode();

      grid.className = 'grid ' + (mode==='month' ? 'month' : 'week');
      grid.innerHTML = '';

      let cells = [];
      if (mode === 'week'){
        const start = startOfWeek(anchor);
        const end = addDays(start, 6);
        rangeTitle.textContent = fmtRange(start, end);
        for (let i=0;i<7;i++) cells.push({ date: addDays(start,i), out:false });
      } else {
        const first = startOfMonth(anchor);
        const last = endOfMonth(anchor);
        const start = startOfWeek(first);
        const end = addDays(startOfWeek(last), 6);
        rangeTitle.textContent = anchor.toLocaleDateString('tr-TR', { month:'long', year:'numeric' });
        const totalDays = Math.round((end - start) / (24*3600*1000)) + 1;
        for (let i=0;i<totalDays;i++){
          const d = addDays(start,i);
          cells.push({ date:d, out: d.getMonth() !== anchor.getMonth() });
        }
        adjustMonthCellHeight(cells.length);
      }

      const selKey = dayKey(selected);

      for (const c of cells){
        const k = dayKey(c.date);
        const items = (db.days[k]||[]).filter(passesFilters).sort(itemSort);
        const openCount = items.filter(x=>!x.done).length;

        const cell = document.createElement('div');
        cell.className = 'cell ' + (mode==='month' ? 'monthCell' : 'weekCell') + (c.out ? ' out' : '') + (k===selKey ? ' sel' : '');
        cell.dataset.key = k;

        const top = document.createElement('div');
        top.className='dateRow';

        const left = document.createElement('div');
        left.className='dateLeft';

        const dateEl = document.createElement('div');
        dateEl.className='date';
        dateEl.textContent = String(c.date.getDate()).padStart(2,'0');

        const plus = document.createElement('button');
        plus.className='plusBtn';
        plus.type='button';
        plus.textContent='+';
        plus.addEventListener('click', (e)=>{
          e.stopPropagation();
          openModalAdd({ dest:'day', dayKey:k });
        });

        left.appendChild(dateEl);
        left.appendChild(plus);

        const count = document.createElement('div');
        count.className='count';
        count.textContent = openCount ? `${openCount}` : '';

        top.appendChild(left);
        top.appendChild(count);

        const cards = document.createElement('div');
        cards.className='cards';

        for (const it of items){
          cards.appendChild(makeCard(it, { from:'day', dayKey:k }));
        }

        cell.appendChild(top);
        cell.appendChild(cards);

        cell.addEventListener('click', ()=>{
          selected = c.date;
          if (mode==='month' && c.out){
            anchor = new Date(c.date.getFullYear(), c.date.getMonth(), 1);
          }
          render();
        });

        cell.addEventListener('dragover', (e)=>{ e.preventDefault(); cell.classList.add('dragOver'); e.dataTransfer.dropEffect='move'; });
        cell.addEventListener('dragleave', ()=>cell.classList.remove('dragOver'));
        cell.addEventListener('drop', (e)=>{
          e.preventDefault();
          cell.classList.remove('dragOver');

          let payload = dragPayload;
          try {
            const txt = e.dataTransfer.getData('text/plain');
            if (txt) payload = JSON.parse(txt);
          } catch {}
          if (!payload?.itemId) return;

          const toKey = k;

          if (payload.from === 'inbox'){
            const idx = (db.inbox||[]).findIndex(x=>x.id===payload.itemId);
            if (idx === -1) return;
            const [moved] = db.inbox.splice(idx,1);
            db.days[toKey] = db.days[toKey] || [];
            db.days[toKey].push(moved);
          } else if (payload.from === 'day'){
            const fromKey = payload.dayKey;
            if (!fromKey || fromKey===toKey) return;
            const fromArr = db.days[fromKey] || [];
            const idx = fromArr.findIndex(x=>x.id===payload.itemId);
            if (idx === -1) return;
            const [moved] = fromArr.splice(idx,1);
            if (!fromArr.length) delete db.days[fromKey];
            db.days[toKey] = db.days[toKey] || [];
            db.days[toKey].push(moved);
          }

          saveDB(db);
          dragPayload = null;
          selected = c.date;
          render();
        });

        grid.appendChild(cell);
      }

      renderInbox();
      renderHabits();
      renderPanel();
    }

    // Controls
    document.getElementById('prev').addEventListener('click', ()=>{
      anchor = (mode==='week') ? addDays(anchor, -7) : new Date(anchor.getFullYear(), anchor.getMonth()-1, 1);
      render();
    });
    document.getElementById('next').addEventListener('click', ()=>{
      anchor = (mode==='week') ? addDays(anchor, 7) : new Date(anchor.getFullYear(), anchor.getMonth()+1, 1);
      render();
    });
    document.getElementById('today').addEventListener('click', ()=>{
      anchor = new Date();
      selected = new Date();
      render();
    });

    btnWeek.addEventListener('click', ()=>{
      mode='week';
      btnWeek.classList.add('active'); btnMonth.classList.remove('active');
      anchor = new Date(selected);
      typeFilter.value = '__preset__';
      typeInput.value = 'gorev';
      render();
    });
    btnMonth.addEventListener('click', ()=>{
      mode='month';
      btnMonth.classList.add('active'); btnWeek.classList.remove('active');
      anchor = new Date(selected.getFullYear(), selected.getMonth(), 1);
      typeFilter.value = '__preset__';
      typeInput.value = 'termin';
      render();
    });

    tagFilter.addEventListener('change', render);
    typeFilter.addEventListener('change', render);
    search.addEventListener('input', render);

    taskInput.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter'){
        e.preventDefault();
        addSubmit.click();
      }
    });

    addForm.addEventListener('submit', (e)=>{
      e.preventDefault();
      const text = (taskInput.value||'').trim();
      if (!text) return;

      const item = {
        text,
        time: timeInput.value || '',
        type: typeInput.value,
        tag: (tagInput.value==='__none__' ? '' : tagInput.value),
        done:false,
        created: Date.now()
      };

      if (whereInput.value === 'inbox'){
        addItemTo('inbox', null, item);
      } else {
        addItemTo('day', dayKey(selected), item);
      }

      taskInput.value='';
      timeInput.value='';
      tagInput.value='__none__';
      render();
      taskInput.focus();
    });

    clearDone.addEventListener('click', ()=>{
      const k = dayKey(selected);
      const items = db.days[k] || [];
      const kept = items.filter(t=>!t.done);
      if (kept.length) db.days[k]=kept; else delete db.days[k];
      saveDB(db);
      render();
    });

    clearInboxDone.addEventListener('click', ()=>{
      db.inbox = (db.inbox||[]).filter(t=>!t.done);
      saveDB(db);
      render();
    });

    inboxAdd.addEventListener('click', ()=>openModalAdd({ dest:'inbox', dayKey:null }));

    inbox.addEventListener('dragover', (e)=>{ e.preventDefault(); inbox.classList.add('dragOver'); e.dataTransfer.dropEffect='move'; });
    inbox.addEventListener('dragleave', ()=>inbox.classList.remove('dragOver'));
    inbox.addEventListener('drop', (e)=>{
      e.preventDefault();
      inbox.classList.remove('dragOver');

      let payload = dragPayload;
      try {
        const txt = e.dataTransfer.getData('text/plain');
        if (txt) payload = JSON.parse(txt);
      } catch {}
      if (!payload?.itemId) return;

      if (payload.from === 'day'){
        const fromKey = payload.dayKey;
        const fromArr = db.days[fromKey] || [];
        const idx = fromArr.findIndex(x=>x.id===payload.itemId);
        if (idx === -1) return;
        const [moved] = fromArr.splice(idx,1);
        if (!fromArr.length) delete db.days[fromKey];
        db.inbox = db.inbox || [];
        db.inbox.push(moved);
        saveDB(db);
        dragPayload = null;
        render();
      }
    });

    habitAddBtn.addEventListener('click', ()=>{
      const name = prompt('Yeni alÄ±ÅŸkanlÄ±k:');
      if (!name) return;
      db.habits = db.habits || [];
      db.habits.push({ id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now())+Math.random(), name: name.trim() });
      saveDB(db);
      renderHabits();
    });

    habitResetBtn.addEventListener('click', ()=>{
      db.habitState = { date: todayKey(), doneIds: [] };
      saveDB(db);
      renderHabits();
    });

    typeFilter.value='__preset__';
    typeInput.value = 'gorev';

    render();

    window.addEventListener('resize', ()=>{
      if (mode === 'month') render();
    });
  </script>
</body>
</html>
