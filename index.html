<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="theme-color" content="#111111" />
  <title>Minimal To-Do v15.2 (App Mode)</title>
  <link rel="manifest" href="manifest.webmanifest">
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#0f0f10; --card:#17171a; --muted:#a3a3a3; --text:#f5f5f5; --line:#2a2a2f; --accent:#7dd3fc;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --frame-termin:#fb7185; --frame-hedef:#60a5fa; --frame-gorev:#34d399;
      --monthCellH: 130px;
      --bottom-nav-h: 60px;
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    html, body{ height:100%; margin:0; background:var(--bg); color:var(--text); overscroll-behavior-y: none; }

    /* --- COMMON UI --- */
    .btn{ background:var(--card); border:1px solid var(--line); color:var(--text); padding:8px 10px; border-radius:12px; cursor:pointer; }
    .btn:hover{ border-color:#3a3a44; }
    .btn.danger{ color:#fb7185; border-color:rgba(251,113,133,.35); }
    .btn.primary{ background: var(--accent); color: #000; border-color:var(--accent); font-weight: 600; }
    .hidden { display: none !important; }

    /* --- DESKTOP STYLES (ORIGINAL v15.1) --- */
    .desktop-only { display: block; height: 100%; }
    
    .wrap{ max-width:1440px; margin:0 auto; padding:16px; height: 100%; display: flex; flex-direction: column; }
    header{ display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:12px; flex-wrap:wrap; }
    .left{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    h1{ font-size:16px; margin:0; font-weight:650; letter-spacing:.2px; }
    .seg{ display:flex; background:var(--card); border:1px solid var(--line); border-radius:14px; overflow:hidden; }
    .seg button{ border:0; background:transparent; color:var(--muted); padding:8px 12px; cursor:pointer; }
    .seg button.active{ color:var(--text); background:#1f1f24; }
    .bar{ display:flex; gap:10px; align-items:center; justify-content:space-between; margin:10px 0 12px; flex-wrap:wrap; }
    .nav{ display:flex; gap:8px; align-items:center; }
    .title{ font-size:14px; color:var(--muted); }
    .filters{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    select, input[type="text"], input[type="search"], input[type="time"], input[type="email"], input[type="password"]{ background:#101014; color:var(--text); border:1px solid var(--line); border-radius:12px; padding:8px 10px; outline:none; font-size:13px; }
    .main{ display:grid; grid-template-columns: 1fr 240px; gap:12px; align-items:start; flex: 1; overflow: hidden; }
    .calendarArea{ height: calc(100vh - 210px); overflow:auto; padding-right:4px; }
    body.weekMode .calendarArea{ height: calc(100vh - 320px); }
    body.monthMode .calendarArea{ height: calc(100vh - 140px); }
    .grid{ display:grid; gap:10px; }
    .month{ grid-template-columns: repeat(7, 1fr); }
    .week{ grid-template-columns: repeat(7, 1fr); }
    .dow{ font-size:12px; color:var(--muted); padding:0 6px; }
    .cell{ background:var(--card); border:1px solid var(--line); border-radius:16px; padding:10px; cursor:pointer; display:flex; flex-direction:column; gap:8px; overflow:hidden; min-width:0; }
    .cell.weekCell{ min-height:280px; }
    .cell.monthCell{ height: var(--monthCellH); }
    .cell:hover{ border-color:#3a3a44; } .cell.out{ opacity:.55; } .cell.sel{ outline:2px solid rgba(125,211,252,.35); border-color:rgba(125,211,252,.35); }
    .dateRow{ display:flex; align-items:center; justify-content:space-between; gap:8px; } .dateLeft{ display:flex; align-items:center; gap:8px; min-width:0; } .date{ font-size:12px; color:var(--muted); } .count{ font-size:12px; color:var(--accent); }
    .plusBtn{ width:26px; height:26px; display:grid; place-items:center; border-radius:10px; border:1px solid var(--line); background:transparent; color:var(--muted); cursor:pointer; flex:0 0 auto; }
    .cards{ display:flex; flex-direction:column; gap:6px; overflow:auto; min-height:0; padding-right:2px; }
    
    /* CARD (Shared Style) */
    .card{ border:2px solid var(--frameColor, var(--line)); border-radius:12px; padding:6px 8px; background: var(--fillColor, rgba(255,255,255,0.04)); user-select:none; min-width:0; position:relative; }
    .card.done{ opacity:.55; }
    .cardRow{ display:flex; align-items:flex-start; gap:8px; min-width:0; }
    .checkBtn{ width:18px; height:18px; display:grid; place-items:center; border-radius:7px; border:1px solid rgba(0,0,0,.25); background:rgba(0,0,0,.10); color:rgba(255,255,255,.85); cursor:pointer; flex:0 0 auto; font-size:11px; line-height:1; margin-top:1px; }
    .cardBody{ flex:1 1 auto; min-width:0; display:flex; flex-direction:column; gap:3px; padding-right:22px; }
    .titleText{ font-size:12.8px; line-height:1.2; color: var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .timeText{ font-size:11px; line-height:1.1; color: rgba(255,255,255,.75); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    body.monthMode .card{ padding:4px 6px; border-radius:10px; } body.monthMode .cards{ gap:4px; } body.monthMode .checkBtn{ width:14px; height:14px; border-radius:6px; font-size:9px; margin-top:0; }
    body.monthMode .cardBody{ gap:2px; padding-right:20px; flex-direction: row; align-items: center; gap: 6px; } body.monthMode .titleText{ font-size:11px; flex: 1 1 auto; min-width: 0; } body.monthMode .timeText{ font-size:9.5px; opacity: .85; flex: 0 0 auto; }
    .moreBtn{ position:absolute; top:6px; right:6px; width:18px; height:18px; border-radius:8px; border:1px solid rgba(255,255,255,.15); background:rgba(0,0,0,.12); color:rgba(255,255,255,.85); cursor:pointer; display:grid; place-items:center; font-size:14px; line-height:1; }
    
    .side{ position:sticky; top:12px; display:flex; flex-direction:column; gap:12px; } .panelBox{ background:var(--card); border:1px solid var(--line); border-radius:18px; padding:12px; box-shadow: var(--shadow); }
    .panelHead{ display:flex; align-items:center; justify-content:space-between; gap:8px; } .panelHead h2{ margin:0; font-size:14px; } .muted{ color:var(--muted); font-size:12px; }
    .inboxList{ display:flex; flex-direction:column; gap:8px; overflow:auto; max-height:40vh; padding-right:2px; }
    .bottom{ margin-top: 0px; background:transparent; border:0; padding:0; } body.weekMode .bottom{ margin-top: -64px; }
    .bottomGrid{ display:block; } body.weekMode .bottomGrid{ display:grid; grid-template-columns: 1fr 360px; gap:10px; align-items:start; }
    .panelLike{ background:var(--card); border:1px solid var(--line); border-radius:18px; padding:12px; box-shadow: var(--shadow); }
    .bottomTop{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; flex-wrap:wrap; } .panelLike h2{ margin:0; font-size:14px; }
    form{ display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; } .w{ min-width:160px; }
    .list{ margin-top:10px; display:flex; flex-direction:column; gap:8px; } .row{ display:flex; align-items:center; justify-content:space-between; gap:10px; border:1px solid var(--line); background:#121216; padding:10px 12px; border-radius:14px; }
    .row .txt{ font-size:13px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    body.monthMode .side{ display:none; } body.monthMode .main{ grid-template-columns: 1fr; } body.monthMode #bottomInboxSlot{ display:none; }

    /* --- MOBILE APP STYLES (New) --- */
    .mobile-only { display: none; height: 100%; flex-direction: column; position: relative; }
    .m-header { padding:12px 16px; background:rgba(15,15,16,0.95); border-bottom:1px solid var(--line); display:flex; justify-content:space-between; align-items:center; }
    .m-content { flex:1; overflow-y:auto; padding:12px; padding-bottom:80px; }
    .m-nav { position:fixed; bottom:0; left:0; width:100%; height:var(--bottom-nav-h); background:var(--card); border-top:1px solid var(--line); display:grid; grid-template-columns:repeat(5,1fr); z-index:20; padding-bottom:env(safe-area-inset-bottom); }
    .m-nav-item { display:flex; flex-direction:column; align-items:center; justify-content:center; font-size:10px; color:var(--muted); background:transparent; border:none; }
    .m-nav-item.active { color:var(--accent); }
    .m-nav-icon { font-size:18px; margin-bottom:2px; }
    .fab { position:fixed; bottom: calc(var(--bottom-nav-h) + 16px); right:16px; width:56px; height:56px; border-radius:16px; background:var(--accent); color:#000; display:flex; align-items:center; justify-content:center; font-size:28px; box-shadow:0 4px 15px rgba(0,0,0,0.5); border:none; z-index:15; }
    
    /* Mobile Calendar */
    .m-cal-row { display:grid; grid-template-columns:repeat(7,1fr); text-align:center; margin-bottom:5px; }
    .m-cal-cell { aspect-ratio:1; display:flex; flex-direction:column; align-items:center; justify-content:center; border-radius:50%; font-size:14px; position:relative; }
    .m-cal-cell.today { background:#333; font-weight:bold; }
    .m-cal-cell.sel { background:var(--accent); color:#000; font-weight:bold; }
    .m-dot { width:4px; height:4px; border-radius:50%; background:var(--frame-gorev); margin-top:2px; }

    /* OVERLAYS */
    .overlay { position:fixed; inset:0; background:rgba(0,0,0,.7); display:none; align-items:center; justify-content:center; z-index:100; padding:20px; }
    .modal { width:100%; max-width:400px; background:var(--card); border-radius:16px; padding:16px; border:1px solid var(--line); max-height:85vh; overflow-y:auto; box-shadow: var(--shadow); }
    .modalTop{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .modalGrid{ display:grid; grid-template-columns: 1fr 170px 170px 1fr; gap:8px; margin-top:10px; }
    .modalGrid .full{ grid-column: 1 / -1; }
    .modalActions{ display:flex; justify-content:space-between; align-items:center; gap:8px; margin-top:10px; }

    /* Habit & Tags */
    .habitsList{ display:flex; flex-direction:column; gap:10px; }
    .habitRow{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 10px; border:1px solid var(--line); background:#121216; border-radius:14px; }
    .tagManager{ display:flex; flex-direction:column; gap:8px; margin-top:10px; }
    .tagItem{ display:grid; grid-template-columns: 1fr auto auto; gap:8px; align-items:center; border:1px solid var(--line); background:#121216; padding:8px 10px; border-radius:14px; }
    .iconBtn{ width:38px; height:34px; display:grid; place-items:center; border-radius:12px; border:1px solid var(--line); background:transparent; color:var(--muted); cursor:pointer; }

    /* Auth */
    .authBox { width: 100%; max-width: 360px; background: var(--card); border: 1px solid var(--line); border-radius: 20px; padding: 24px; box-shadow: var(--shadow); display: flex; flex-direction: column; gap: 12px; }
    .authError { color: #fb7185; font-size: 13px; text-align: center; min-height: 18px; }

    /* RESPONSIVE SWITCH */
    @media (max-width: 900px) {
      .desktop-only { display: none !important; }
      .mobile-only { display: flex !important; }
    }
  </style>
</head>
<body>

  <div id="authOverlay" class="overlay" style="display:flex; z-index:999; background:var(--bg);">
    <div class="authBox">
      <h2 style="text-align:center; margin:0;">Minimal To-Do</h2>
      <p style="text-align:center; color:var(--muted); font-size:13px;">Giri≈ü Yapƒ±n (Sync)</p>
      <input type="email" id="authEmail" placeholder="E-posta" />
      <input type="password" id="authPass" placeholder="≈ûifre" />
      <div id="authError" class="authError"></div>
      <button id="btnLogin" class="btn primary">Giri≈ü Yap</button>
      <button id="btnSignup" class="btn">Kayƒ±t Ol</button>
    </div>
  </div>

  <div id="appWrap" style="display:none; height:100%;">
    
    <div class="desktop-only wrap">
      <header>
        <div class="left">
          <h1>Minimal To-Do v15.2</h1>
          <div class="seg">
            <button id="btnWeek" class="active">Hafta</button>
            <button id="btnMonth">Ay</button>
          </div>
        </div>
        <div style="display:flex; gap:8px; align-items:center;">
          <span id="userEmailDisplay" style="font-size:12px; color:var(--muted);"></span>
          <button id="btnLogout" class="btn danger">√áƒ±kƒ±≈ü</button>
          <button id="tagSettingsBtn" class="btn">Tag Ayarlarƒ±</button>
        </div>
      </header>

      <div class="bar">
        <div class="nav">
          <button id="prev" class="btn">‚óÄ</button>
          <button id="today" class="btn">Bug√ºn</button>
          <button id="next" class="btn">‚ñ∂</button>
        </div>
        <div class="filters">
          <div class="title" id="rangeTitle"></div>
          <select id="tagFilter"><option value="__all__">Tag: Hepsi</option></select>
          <select id="typeFilter"><option value="__preset__">T√ºr: G√∂r√ºn√ºme g√∂re</option><option value="gorev">G√∂rev</option><option value="termin">Termin</option><option value="hedef">Hedef</option></select>
          <input id="search" type="search" placeholder="Ara‚Ä¶" />
        </div>
      </div>

      <div class="main">
        <div>
          <div id="calendarArea" class="calendarArea">
            <div class="grid" id="dowRow"></div>
            <div class="grid week" id="grid"></div>
          </div>
          <section class="bottom">
            <div class="bottomGrid" id="bottomGrid">
              <div class="panelLike">
                <div class="bottomTop">
                  <div><h2 id="panelTitle">Se√ßili g√ºn</h2><div class="muted">Sƒ±ralama: Termin ‚Üí Hedef ‚Üí G√∂rev</div></div>
                  <button id="clearDone" class="btn">Tamamlananlarƒ± temizle</button>
                </div>
                <form id="addForm" autocomplete="off">
                  <input class="w" id="taskInput" type="text" placeholder="Ba≈ülƒ±k‚Ä¶" />
                  <input class="w" id="timeInput" type="time" />
                  <select class="w" id="typeInput"><option value="termin">Termin</option><option value="hedef">Hedef</option><option value="gorev">G√∂rev</option></select>
                  <select class="w" id="tagInput"></select>
                  <select class="w" id="whereInput"><option value="selected">Se√ßili g√ºne</option><option value="inbox">Inbox</option></select>
                  <button id="addSubmit" class="btn" type="submit">Ekle</button>
                </form>
                <div class="list" id="taskList"></div>
              </div>
              <div id="bottomInboxSlot" class="panelLike"></div>
            </div>
          </section>
        </div>
        <aside class="side">
          <div id="inbox" class="panelBox inbox">
            <div class="panelHead">
              <div><h2>Brain Dump</h2><div class="muted">G√ºne atanmamƒ±≈ü</div></div>
              <div style="display:flex;gap:5px;"><button id="inboxAdd" class="plusBtn">+</button><button id="clearInboxDone" class="btn">Temizle</button></div>
            </div>
            <div class="muted" id="inboxCount"></div>
            <div id="inboxList" class="inboxList"></div>
          </div>
          <div id="habitsBox" class="panelBox">
            <div class="panelHead">
              <div><h2>Habits</h2><div class="muted" id="habitsSub">Her g√ºn sƒ±fƒ±rlanƒ±r</div></div>
              <div style="display:flex;gap:5px;"><button id="habitAddBtn" class="plusBtn">+</button><button id="habitResetBtn" class="btn">Reset</button></div>
            </div>
            <div class="habitsList" id="habitsList"></div>
          </div>
        </aside>
      </div>
    </div>

    <div class="mobile-only">
      <div class="m-header">
        <span style="font-weight:bold; font-size:18px;">Minimal To-Do</span>
        <span id="mHeaderDate" style="font-size:12px; color:var(--accent);"></span>
      </div>
      <div id="mContent" class="m-content"></div>
      <button id="mFab" class="fab">+</button>
      <div class="m-nav">
        <button class="m-nav-item active" onclick="switchMobileTab('day')"><span class="m-nav-icon">üìÖ</span><span>G√ºn</span></button>
        <button class="m-nav-item" onclick="switchMobileTab('month')"><span class="m-nav-icon">üóì</span><span>Takvim</span></button>
        <button class="m-nav-item" onclick="switchMobileTab('inbox')"><span class="m-nav-icon">üì•</span><span>Inbox</span></button>
        <button class="m-nav-item" onclick="switchMobileTab('habits')"><span class="m-nav-icon">‚úÖ</span><span>Habit</span></button>
        <button class="m-nav-item" onclick="switchMobileTab('settings')"><span class="m-nav-icon">‚öô</span><span>Ayar</span></button>
      </div>
    </div>

  </div>

  <div id="overlay" class="overlay">
    <div class="modal">
      <div class="modalTop">
        <h3 id="modalTitle">Ekle</h3>
        <button id="modalClose" class="btn">Kapat</button>
      </div>
      <div id="quickAddSection">
        <div class="muted" id="modalWhere"></div>
        <div class="modalGrid">
          <input id="mText" class="full" type="text" placeholder="Ba≈ülƒ±k‚Ä¶" />
          <input id="mTime" type="time" />
          <select id="mType"><option value="termin">Termin</option><option value="hedef">Hedef</option><option value="gorev">G√∂rev</option></select>
          <select id="mTag"></select>
        </div>
        <div class="modalActions">
          <button id="modalDelete" class="btn danger" style="display:none;">Sil</button>
          <div style="display:flex; gap:8px; margin-left:auto;">
            <button id="modalSave" class="btn">Ekle</button>
          </div>
        </div>
      </div>
      <div id="tagSettingsSection" style="display:none;">
        <div class="muted">Tag sƒ±ralamasƒ±nƒ± deƒüi≈ütir.</div>
        <div class="tagManager" id="tagManager"></div>
      </div>
    </div>
  </div>

  <div id="confirmOverlay" class="overlay" style="z-index:110;">
    <div class="modal" style="text-align:center; width:300px;">
      <h3 style="margin-top:0;">Emin misin?</h3>
      <p id="confirmMsg" style="color:var(--muted);">Bu i≈ülem geri alƒ±namaz.</p>
      <div style="display:flex; gap:10px; justify-content:center; margin-top:16px;">
        <button id="confirmNo" class="btn">ƒ∞ptal</button>
        <button id="confirmYes" class="btn danger">Evet, Sil</button>
      </div>
    </div>
  </div>

<script>
// ==========================================
// 1. AYARLAR
// ==========================================
const SUPABASE_URL = "https://czuprhvrnlqpipcytvwx.supabase.co"; 
const SUPABASE_KEY = "sb_publishable_IR67FHQQNsnA9aNMizaqUA_HYGC8cKM"; 

let db = { days:{}, inbox:[], habits:[], tags:[{name:'genel', color:'#7dd3fc', order:1}], habitState:{date:'', doneIds:[]} };
let currentUser = null;
let _supabase = null;
// UI State
let mode = 'week';
let anchor = new Date();
let selected = new Date();
let mobileTab = 'day';
let dragPayload = null;
let modalContext = { mode:'add', dest:'day', dayKey:null };

// Init
if(SUPABASE_URL && SUPABASE_KEY) {
  _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  initApp();
} else { alert("Supabase Keylerini girin!"); }

async function initApp() {
  const { data: { session } } = await _supabase.auth.getSession();
  if(session) handleSession(session); else document.getElementById('authOverlay').style.display = 'flex';
  _supabase.auth.onAuthStateChange((_event, session) => {
    if(session) handleSession(session); else location.reload();
  });
}

async function handleSession(session) {
  currentUser = session.user;
  document.getElementById('authOverlay').style.display = 'none';
  document.getElementById('appWrap').style.display = 'block';
  document.getElementById('userEmailDisplay').textContent = currentUser.email;
  await loadRemoteDB();
  render();
}

// ==========================================
// 2. DATA UTILS (DATE FIX)
// ==========================================
function dayKey(d) {
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const da = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${da}`;
}
function todayKey() { return dayKey(new Date()); }
function addDays(d, n) { const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function startOfWeek(d) { const x=new Date(d); const day=(x.getDay()+6)%7; x.setDate(x.getDate()-day); return x; }
function startOfMonth(d) { return new Date(d.getFullYear(), d.getMonth(), 1); }
function endOfMonth(d) { return new Date(d.getFullYear(), d.getMonth()+1, 0); }
function normalizeTagName(s){ return (s||'').trim().toLowerCase().replace(/\s+/g,'-'); }
function fixItem(t){ return { id:t.id||crypto.randomUUID(), text:(t.text||'').trim(), done:!!t.done, type:t.type||'gorev', tag:t.tag||'', time:t.time||'', created:t.created||Date.now() }; }
function typeFrameColor(type){ return type==='termin'?'#fb7185': type==='hedef'?'#60a5fa':'#34d399'; }
function hexToRgba(hex, alpha){
  let c; if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(hex)){ c=hex.substring(1).split(''); if(c.length==3)c=[c[0],c[0],c[1],c[1],c[2],c[2]]; c='0x'+c.join(''); return 'rgba('+[(c>>16)&255, (c>>8)&255, c&255].join(',')+','+alpha+')'; } return 'rgba(50,50,50,'+alpha+')';
}

// ==========================================
// 3. DB SYNC
// ==========================================
const LOCAL_KEY = 'minimal_todo_v15_2_app';
async function loadRemoteDB() {
  try { const raw=localStorage.getItem(LOCAL_KEY); if(raw) db=JSON.parse(raw); } catch{}
  if(currentUser) {
    const { data } = await _supabase.from('user_data').select('content').eq('id', currentUser.id).single();
    if(data && data.content) { db=data.content; localStorage.setItem(LOCAL_KEY, JSON.stringify(db)); }
    else if(!db.days) saveDB(db);
  }
}
let saveTimer=null;
function saveDB(newDB) {
  if(newDB) db=newDB;
  localStorage.setItem(LOCAL_KEY, JSON.stringify(db));
  if(saveTimer) clearTimeout(saveTimer);
  saveTimer = setTimeout(async () => {
    if(currentUser) await _supabase.from('user_data').upsert({ id: currentUser.id, content: db, updated_at: new Date() });
  }, 1000);
}

// ==========================================
// 4. RENDERERS
// ==========================================
function render() {
  // DB Cleaning
  for(const k in db.days) db.days[k] = (db.days[k]||[]).map(fixItem);
  db.inbox = (db.inbox||[]).map(fixItem);
  
  // Desktop Render (Original)
  rebuildTagDropdowns();
  renderDesktop();
  
  // Mobile Render (New)
  renderMobile();
}

// --- DESKTOP LOGIC (v15.1 Original) ---
function renderDesktop() {
  const dowRow = document.getElementById('dowRow');
  const grid = document.getElementById('grid');
  const rangeTitle = document.getElementById('rangeTitle');
  const DOW = ['Pzt','Sal','√áar','Per','Cum','Cts','Paz'];
  
  // DOW
  dowRow.innerHTML = '';
  dowRow.className = 'grid ' + (mode==='month' ? 'month' : 'week');
  DOW.forEach(d => { dowRow.innerHTML += `<div class="dow">${d}</div>`; });

  // Grid
  grid.className = 'grid ' + (mode==='month' ? 'month' : 'week');
  grid.innerHTML = '';
  let cells = [];
  if(mode === 'week'){
    const start = startOfWeek(anchor);
    const end = addDays(start, 6);
    rangeTitle.textContent = `${start.getDate()} ${start.toLocaleDateString('tr-TR',{month:'short'})} - ${end.getDate()} ${end.toLocaleDateString('tr-TR',{month:'short'})}`;
    for(let i=0; i<7; i++) cells.push({d: addDays(start, i), out:false});
  } else {
    const first = startOfMonth(anchor);
    rangeTitle.textContent = anchor.toLocaleDateString('tr-TR', {month:'long', year:'numeric'});
    const start = startOfWeek(first);
    const total = Math.ceil((endOfMonth(anchor) - start + 1) / 86400000);
    const rows = Math.ceil(total/7)*7; 
    for(let i=0; i<rows; i++) { const d=addDays(start,i); cells.push({d:d, out: d.getMonth()!==anchor.getMonth()}); }
    document.documentElement.style.setProperty('--monthCellH', Math.max(115, Math.floor((document.getElementById('calendarArea').clientHeight - 40) / (rows/7))) + 'px');
  }

  cells.forEach(c => {
    const k = dayKey(c.d);
    const items = (db.days[k]||[]).filter(passesFilters).sort(itemSort);
    const cell = document.createElement('div');
    cell.className = `cell ${mode==='month'?'monthCell':'weekCell'} ${c.out?'out':''} ${k===dayKey(selected)?'sel':''}`;
    cell.innerHTML = `
      <div class="dateRow">
        <div class="dateLeft"><div class="date">${c.d.getDate()}</div><button class="plusBtn" onclick="openModalAdd({dest:'day', dayKey:'${k}'})">+</button></div>
        <div class="count">${items.filter(x=>!x.done).length||''}</div>
      </div>
      <div class="cards"></div>
    `;
    const cardCont = cell.querySelector('.cards');
    items.forEach(it => cardCont.appendChild(makeCard(it, {from:'day', dayKey:k})));
    
    cell.onclick = (e) => { if(e.target===cell || e.target.classList.contains('date')) { selected=c.d; render(); } };
    cell.addEventListener('dragover', e => { e.preventDefault(); cell.classList.add('dragOver'); });
    cell.addEventListener('dragleave', () => cell.classList.remove('dragOver'));
    cell.addEventListener('drop', e => {
      e.preventDefault(); cell.classList.remove('dragOver');
      if(!dragPayload) return;
      if(dragPayload.from==='inbox') {
        const idx = db.inbox.findIndex(x=>x.id===dragPayload.itemId);
        if(idx>-1) { db.days[k] = db.days[k]||[]; db.days[k].push(db.inbox.splice(idx,1)[0]); }
      } else {
        const fromK = dragPayload.dayKey;
        const idx = (db.days[fromK]||[]).findIndex(x=>x.id===dragPayload.itemId);
        if(idx>-1) { db.days[k] = db.days[k]||[]; db.days[k].push(db.days[fromK].splice(idx,1)[0]); }
      }
      saveDB(); render();
    });
    grid.appendChild(cell);
  });

  renderInbox();
  renderHabits();
  renderPanel();
  dockInboxForMode();
}

// --- MOBILE LOGIC (App Mode) ---
function renderMobile() {
  const mContent = document.getElementById('mContent');
  const mHeader = document.getElementById('mHeaderDate');
  const mFab = document.getElementById('mFab');
  
  // Active Tab Style
  document.querySelectorAll('.m-nav-item').forEach(el => el.classList.remove('active'));
  document.querySelectorAll(`.m-nav-item`)[['day','month','inbox','habits','settings'].indexOf(mobileTab)].classList.add('active');
  
  mContent.innerHTML = '';
  mFab.style.display = (mobileTab==='settings') ? 'none' : 'flex';

  if(mobileTab === 'day') {
    mHeader.textContent = selected.toLocaleDateString('tr-TR', {weekday:'long', day:'numeric', month:'short'});
    
    const wrap = document.createElement('div');
    wrap.className = 'mobile-day-wrapper';
    
    // Swipe
    let ts = 0;
    wrap.addEventListener('touchstart', e => ts = e.touches[0].clientX);
    wrap.addEventListener('touchend', e => {
      const te = e.changedTouches[0].clientX;
      if(ts - te > 50) { selected = addDays(selected, 1); render(); }
      if(te - ts > 50) { selected = addDays(selected, -1); render(); }
    });

    const items = (db.days[dayKey(selected)]||[]).sort(itemSort);
    if(items.length === 0) wrap.innerHTML = '<div class="empty-state">Bug√ºn bo≈ü.<br>+ ile ekle.</div>';
    else items.forEach(it => wrap.appendChild(makeCard(it, {from:'day', dayKey:dayKey(selected)})));
    
    mContent.appendChild(wrap);
    mFab.onclick = () => openModalAdd({dest:'day', dayKey:dayKey(selected)});
  
  } else if (mobileTab === 'month') {
    mHeader.textContent = selected.toLocaleDateString('tr-TR', {month:'long', year:'numeric'});
    const grid = document.createElement('div');
    const start = startOfWeek(startOfMonth(selected));
    
    const hRow = document.createElement('div');
    hRow.className = 'm-cal-row m-cal-head';
    ['Pt','Sa','√áa','Pe','Cu','Ct','Pa'].forEach(d => hRow.innerHTML+=`<span>${d}</span>`);
    grid.appendChild(hRow);

    const bodyDiv = document.createElement('div');
    bodyDiv.className = 'm-cal-grid';

    for(let i=0; i<42; i++) {
      const d = addDays(start, i);
      const k = dayKey(d);
      const items = (db.days[k]||[]);
      
      const cell = document.createElement('div');
      cell.className = `m-cal-cell ${k===todayKey()?'today':''} ${k===dayKey(selected)?'selected':''} ${d.getMonth()!==selected.getMonth()?'diff-month':''}`;
      
      let dots = '';
      items.filter(x=>!x.done).slice(0,3).forEach(it => {
        dots += `<div class="m-dot" style="background:${typeFrameColor(it.type)}"></div>`;
      });
      
      cell.innerHTML = `<span>${d.getDate()}</span><div class="m-dots">${dots}</div>`;
      cell.onclick = () => { selected = d; mobileTab = 'day'; render(); };
      bodyDiv.appendChild(cell);
    }
    grid.appendChild(bodyDiv);
    mContent.appendChild(grid);
    mFab.onclick = () => openModalAdd({dest:'day', dayKey:dayKey(selected)});

  } else if (mobileTab === 'inbox') {
    mHeader.textContent = 'Inbox';
    const items = (db.inbox||[]).sort(itemSort);
    if(items.length===0) mContent.innerHTML='<div class="empty-state">Inbox bo≈ü.</div>';
    else items.forEach(it => mContent.appendChild(makeCard(it, {from:'inbox'})));
    mFab.onclick = () => openModalAdd({dest:'inbox'});
  
  } else if (mobileTab === 'habits') {
    mHeader.textContent = 'Habits';
    // Reuse existing habit renderer logic but adapt for mobile
    const today = todayKey();
    if(!db.habitState || db.habitState.date !== today) { db.habitState = {date:today, doneIds:[]}; saveDB(); }
    if(!db.habits.length) mContent.innerHTML='<div class="empty-state">Alƒ±≈ükanlƒ±k yok.</div>';
    db.habits.forEach(h => {
      const isDone = db.habitState.doneIds.includes(h.id);
      const row = document.createElement('div');
      row.className = 'card';
      row.style.cssText = `display:flex; justify-content:space-between; align-items:center; border-left:none; ${isDone?'opacity:0.5':''}`;
      row.innerHTML = `<span>${h.name}</span> <div class="checkBtn" style="${isDone?'background:var(--accent);color:#000':''}">${isDone?'‚úì':''}</div>`;
      row.onclick = () => {
        if(isDone) db.habitState.doneIds = db.habitState.doneIds.filter(x=>x!==h.id);
        else db.habitState.doneIds.push(h.id);
        saveDB(); render();
      };
      // Long press delete
      let pt;
      row.addEventListener('touchstart', ()=>{ pt=setTimeout(()=>{ showConfirm('Silinsin mi?', ()=>{ db.habits=db.habits.filter(x=>x.id!==h.id); saveDB(); render(); }); },800); });
      row.addEventListener('touchend', ()=>{ clearTimeout(pt); });
      mContent.appendChild(row);
    });
    mFab.onclick = () => { const n=prompt('Yeni Alƒ±≈ükanlƒ±k:'); if(n){ db.habits.push({id:crypto.randomUUID(), name:n}); saveDB(); render(); } };

  } else if (mobileTab === 'settings') {
    mHeader.textContent = 'Ayarlar';
    mContent.innerHTML = `
      <div class="card" style="border-left:none;">
        <h3>Tag Y√∂netimi</h3>
        <div id="mTags"></div>
        <div style="margin-top:10px; display:flex; gap:5px;">
           <input id="newTagName" placeholder="Yeni Tag">
           <input type="color" id="newTagColor" value="#7dd3fc" style="width:50px;">
           <button class="btn" onclick="addTagMobile()">Ekle</button>
        </div>
      </div>
      <button class="btn danger" style="width:100%; margin-top:20px;" onclick="logout()">√áƒ±kƒ±≈ü Yap</button>
    `;
    const tagList = mContent.querySelector('#mTags');
    db.tags.forEach(t => {
      const row = document.createElement('div');
      row.style.cssText = "display:flex; justify-content:space-between; margin-bottom:5px; align-items:center;";
      row.innerHTML = `<span style="color:${t.color}">‚óè ${t.name}</span> <button class="btn danger" style="padding:2px 6px; font-size:10px;">Sil</button>`;
      row.querySelector('button').onclick = () => { 
        showConfirm('Tag silinsin mi?', () => { db.tags=db.tags.filter(x=>x.name!==t.name); saveDB(); render(); }); 
      };
      tagList.appendChild(row);
    });
  }
}

function switchMobileTab(t) { mobileTab = t; render(); }
function addTagMobile() {
  const n = document.getElementById('newTagName').value;
  const c = document.getElementById('newTagColor').value;
  if(n) { db.tags.push({name:n, color:c, order:99}); saveDB(); render(); }
}

// --- SHARED HELPERS ---
function makeCard(item, origin){
  const card = document.createElement('div');
  card.className = 'card' + (item.done ? ' done' : '');
  card.draggable = true;
  
  // Type Color (Left Border)
  card.style.setProperty('--frameColor', typeFrameColor(item.type));
  
  // Tag Color (Background)
  const meta = tagMeta(item.tag);
  if(meta) card.style.background = hexToRgba(meta.color, 0.15);

  const more = document.createElement('button');
  more.className='moreBtn'; more.type='button'; more.textContent='‚ãØ';
  more.onclick = (e) => { e.stopPropagation(); openModalEdit(origin, item.id); };

  const row = document.createElement('div'); row.className = 'cardRow';
  const check = document.createElement('button'); check.className = 'checkBtn'; check.textContent = item.done ? '‚úì' : '';
  check.onclick = (e) => { e.stopPropagation(); item.done = !item.done; saveDB(); render(); };

  const body = document.createElement('div'); body.className = 'cardBody';
  const title = document.createElement('div'); title.className = 'titleText'; title.textContent = item.text;
  body.appendChild(title);
  if(item.time){
    const time = document.createElement('div'); time.className = 'timeText'; time.textContent = item.time + (item.tag ? ' ‚Ä¢ '+item.tag : '');
    body.appendChild(time);
  }

  row.appendChild(check); row.appendChild(body);
  card.appendChild(more); card.appendChild(row);
  
  card.addEventListener('dragstart', (e)=>{ dragPayload = { ...origin, itemId: item.id }; e.dataTransfer.setData('text', ''); });
  // Edit on click body
  body.onclick = () => openModalEdit(origin, item.id);

  return card;
}

function renderInbox(){
  const inboxList = document.getElementById('inboxList');
  inboxList.innerHTML = '';
  const items = (db.inbox||[]).filter(passesFilters).sort(itemSort);
  document.getElementById('inboxCount').textContent = items.length ? `Count: ${items.length}` : 'Bo≈ü';
  items.forEach(it => inboxList.appendChild(makeCard(it, {from:'inbox'})));
}

function renderHabits(){
  const habitsList = document.getElementById('habitsList');
  habitsList.innerHTML = '';
  ensureHabitReset();
  const done = new Set(db.habitState.doneIds);
  db.habits.forEach(h => {
    const row = document.createElement('div'); row.className='habitRow';
    const cb = document.createElement('input'); cb.type='checkbox'; cb.checked=done.has(h.id);
    cb.onchange = () => { cb.checked?done.add(h.id):done.delete(h.id); db.habitState.doneIds=[...done]; saveDB(); render(); };
    const span = document.createElement('span'); span.textContent=h.name;
    const del = document.createElement('button'); del.className='iconBtn'; del.textContent='üóë';
    del.onclick = () => showConfirm('Sil?', ()=>{ db.habits=db.habits.filter(x=>x.id!==h.id); saveDB(); render(); });
    const lab = document.createElement('label'); lab.appendChild(cb); lab.appendChild(span);
    row.appendChild(lab); row.appendChild(del);
    habitsList.appendChild(row);
  });
}

function renderPanel(){
  const list = document.getElementById('taskList');
  list.innerHTML = '';
  const k = dayKey(selected);
  document.getElementById('panelTitle').textContent = fmtDay(selected);
  (db.days[k]||[]).filter(passesFilters).sort(itemSort).forEach(it => {
    const row = document.createElement('div'); row.className='row';
    const txt = document.createElement('div'); txt.className='txt';
    txt.textContent = it.text + (it.time?` ‚Ä¢ ${it.time}`:'');
    if(it.done) txt.style.color='var(--muted)';
    row.appendChild(txt);
    list.appendChild(row);
  });
}

function dockInboxForMode(){
  const side = document.querySelector('.side');
  const bottomSlot = document.getElementById('bottomInboxSlot');
  const inbox = document.getElementById('inbox');
  if(mode==='week' && bottomSlot) { document.body.classList.add('weekMode'); document.body.classList.remove('monthMode'); bottomSlot.appendChild(inbox); }
  else { document.body.classList.remove('weekMode'); document.body.classList.add('monthMode'); side.insertBefore(inbox, side.firstChild); }
}

// --- MODAL ---
function openModalAdd(ctx){
  modalContext = { mode:'add', dest:ctx.dest, dayKey:ctx.dayKey||dayKey(selected) };
  document.getElementById('modalTitle').textContent = 'Ekle';
  document.getElementById('mText').value='';
  document.getElementById('mTime').value='';
  document.getElementById('modalDelete').style.display='none';
  document.getElementById('overlay').style.display='flex';
  document.getElementById('quickAddSection').style.display='block';
  document.getElementById('tagSettingsSection').style.display='none';
  rebuildTagDropdowns();
  setTimeout(()=>document.getElementById('mText').focus(),0);
}
function openModalEdit(origin, itemId){
  const it = findItem(origin, itemId);
  if(!it) return;
  modalContext = { mode:'edit', origin, itemId };
  document.getElementById('modalTitle').textContent = 'D√ºzenle';
  document.getElementById('mText').value=it.text;
  document.getElementById('mTime').value=it.time;
  document.getElementById('mType').value=it.type;
  document.getElementById('modalDelete').style.display='block';
  document.getElementById('overlay').style.display='flex';
  document.getElementById('quickAddSection').style.display='block';
  document.getElementById('tagSettingsSection').style.display='none';
  rebuildTagDropdowns();
  document.getElementById('mTag').value=it.tag;
}
document.getElementById('modalSave').onclick = () => {
  const txt = document.getElementById('mText').value;
  if(!txt) return;
  if(modalContext.mode==='add') {
    addItemTo(modalContext.dest, modalContext.dayKey, {
      text:txt, time:document.getElementById('mTime').value,
      type:document.getElementById('mType').value, tag:document.getElementById('mTag').value
    });
  } else {
    const it = findItem(modalContext.origin, modalContext.itemId);
    if(it) {
      it.text=txt; it.time=document.getElementById('mTime').value;
      it.type=document.getElementById('mType').value; it.tag=document.getElementById('mTag').value;
      saveDB();
    }
  }
  document.getElementById('overlay').style.display='none'; render();
};
document.getElementById('modalDelete').onclick = () => {
  showConfirm('Silinsin mi?', ()=>{ deleteItem(modalContext.origin, modalContext.itemId); document.getElementById('overlay').style.display='none'; });
};
document.getElementById('modalClose').onclick = () => document.getElementById('overlay').style.display='none';

// --- UTILS ---
function passesFilters(item){
  const q = document.getElementById('search').value.toLowerCase();
  if(q && !item.text.toLowerCase().includes(q)) return false;
  const tf = document.getElementById('tagFilter').value;
  if(tf!=='__all__' && item.tag!==tf) return false;
  const tpf = document.getElementById('typeFilter').value;
  if(tpf==='__preset__') { if(mode==='month' && item.type==='gorev') return false; }
  else if(tpf!=='__all__' && item.type!==tpf) return false;
  return true;
}
function itemSort(a,b){
  const rank={termin:0,hedef:1,gorev:2};
  if(rank[a.type]!==rank[b.type]) return rank[a.type]-rank[b.type];
  const ta=a.time||'99', tb=b.time||'99';
  return ta.localeCompare(tb);
}

// --- EVENT LISTENERS ---
document.getElementById('btnWeek').onclick = () => { mode='week'; document.getElementById('btnWeek').classList.add('active'); document.getElementById('btnMonth').classList.remove('active'); document.getElementById('typeFilter').value='__preset__'; render(); };
document.getElementById('btnMonth').onclick = () => { mode='month'; document.getElementById('btnMonth').classList.add('active'); document.getElementById('btnWeek').classList.remove('active'); document.getElementById('typeFilter').value='__preset__'; render(); };
document.getElementById('prev').onclick = () => { anchor = mode==='week' ? addDays(anchor, -7) : new Date(anchor.getFullYear(), anchor.getMonth()-1, 1); render(); };
document.getElementById('next').onclick = () => { anchor = mode==='week' ? addDays(anchor, 7) : new Date(anchor.getFullYear(), anchor.getMonth()+1, 1); render(); };
document.getElementById('today').onclick = () => { anchor = new Date(); selected = new Date(); render(); };
document.getElementById('tagFilter').onchange = render;
document.getElementById('typeFilter').onchange = render;
document.getElementById('search').oninput = render;
document.getElementById('addForm').onsubmit = (e) => {
  e.preventDefault();
  const txt = document.getElementById('taskInput').value; if(!txt) return;
  addItemTo(document.getElementById('whereInput').value==='inbox'?'inbox':'day', dayKey(selected), {
    text:txt, time:document.getElementById('timeInput').value,
    type:document.getElementById('typeInput').value, tag:document.getElementById('tagInput').value
  });
  document.getElementById('taskInput').value=''; render();
};
document.getElementById('clearDone').onclick = () => { db.days[dayKey(selected)] = (db.days[dayKey(selected)]||[]).filter(x=>!x.done); saveDB(); render(); };
document.getElementById('clearInboxDone').onclick = () => { db.inbox = db.inbox.filter(x=>!x.done); saveDB(); render(); };
document.getElementById('inboxAdd').onclick = () => openModalAdd({dest:'inbox'});
document.getElementById('tagSettingsBtn').onclick = () => {
  document.getElementById('modalTitle').textContent = 'Tag Ayarlarƒ±';
  document.getElementById('quickAddSection').style.display='none';
  document.getElementById('tagSettingsSection').style.display='block';
  document.getElementById('overlay').style.display='flex';
  renderTagManager();
};
document.getElementById('inbox').ondragover = e => { e.preventDefault(); e.dataTransfer.dropEffect='move'; };
document.getElementById('inbox').ondrop = e => {
  e.preventDefault();
  if(!dragPayload || dragPayload.from!=='day') return;
  const idx = db.days[dragPayload.dayKey].findIndex(x=>x.id===dragPayload.itemId);
  if(idx>-1) { db.inbox.push(db.days[dragPayload.dayKey].splice(idx,1)[0]); saveDB(); render(); }
};

document.getElementById('btnLogin').onclick = async () => {
  const { error } = await _supabase.auth.signInWithPassword({ email: document.getElementById('authEmail').value, password: document.getElementById('authPass').value });
  if(error) document.getElementById('authError').textContent = error.message;
};
document.getElementById('btnSignup').onclick = async () => {
  const { error } = await _supabase.auth.signUp({ email: document.getElementById('authEmail').value, password: document.getElementById('authPass').value });
  if(error) document.getElementById('authError').textContent = error.message; else alert("Kayƒ±t olundu.");
};
document.getElementById('btnLogout').onclick = () => { _supabase.auth.signOut(); location.reload(); };

// Start
document.getElementById('typeFilter').value='__preset__';
window.onresize = () => { if(mode==='month') render(); };
</script>
</body>
</html>
